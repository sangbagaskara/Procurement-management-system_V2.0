<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-height: 100vh; color: #e2e8f0; }
        .header { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(51, 65, 85, 0.5); position: sticky; top: 0; z-index: 100; padding: 1rem 1.5rem; }
        .header-content { max-width: 1800px; margin: 0 auto; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #14b8a6, #06b6d4); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3); }
        .logo-icon svg { width: 24px; height: 24px; color: white; }
        .logo-text h1 { font-size: 1.25rem; font-weight: 700; color: white; }
        .logo-text p { font-size: 0.75rem; color: #94a3b8; }
        .header-actions { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .project-select { appearance: none; background: #1e293b url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") no-repeat right 0.75rem center; background-size: 1.25rem; border: 1px solid #475569; color: white; padding: 0.625rem 2.5rem 0.625rem 1rem; border-radius: 12px; font-size: 0.875rem; cursor: pointer; min-width: 280px; }
        .project-select:focus { outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2); }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #0d9488, #06b6d4); color: white; box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #14b8a6, #22d3ee); }
        .btn-secondary { background: #334155; color: white; }
        .btn-secondary:hover { background: #475569; }
        .btn-icon { padding: 0.5rem; border-radius: 8px; background: transparent; color: #94a3b8; border: none; cursor: pointer; }
        .btn-icon:hover { background: #334155; color: white; }
        .nav-tabs { display: flex; gap: 0.25rem; flex-wrap: wrap; }
        .nav-tab { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; color: #94a3b8; background: transparent; border: none; cursor: pointer; transition: all 0.2s; }
        .nav-tab:hover { background: #1e293b; color: white; }
        .nav-tab.active { background: linear-gradient(135deg, rgba(13, 148, 136, 0.2), rgba(6, 182, 212, 0.2)); color: #2dd4bf; border: 1px solid rgba(20, 184, 166, 0.3); }
        .nav-tab svg { width: 18px; height: 18px; }
        .main-content { max-width: 1800px; margin: 0 auto; padding: 1.5rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: linear-gradient(135deg, #1e293b, rgba(30, 41, 59, 0.5)); border-radius: 16px; padding: 1.25rem; border: 1px solid rgba(51, 65, 85, 0.5); }
        .stat-card-content { display: flex; justify-content: space-between; align-items: center; }
        .stat-label { color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: white; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.2); }
        .stat-icon.blue svg { color: #60a5fa; }
        .stat-icon.emerald { background: rgba(16, 185, 129, 0.2); }
        .stat-icon.emerald svg { color: #34d399; }
        .stat-icon.red { background: rgba(239, 68, 68, 0.2); }
        .stat-icon.red svg { color: #f87171; }
        .stat-icon.teal { background: rgba(20, 184, 166, 0.2); }
        .stat-icon.teal svg { color: #2dd4bf; }
        .stat-icon svg { width: 24px; height: 24px; }
        .card { background: linear-gradient(135deg, #1e293b, rgba(30, 41, 59, 0.5)); border-radius: 16px; border: 1px solid rgba(51, 65, 85, 0.5); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid rgba(51, 65, 85, 0.5); }
        .card-title { font-size: 1.125rem; font-weight: 600; color: white; }
        .card-body { padding: 1.5rem; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .chart-container { height: 280px; position: relative; }
        .filter-bar { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; justify-content: space-between; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .search-input { position: relative; }
        .search-input input { background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 0.5rem 1rem 0.5rem 2.5rem; color: white; font-size: 0.875rem; width: 220px; }
        .search-input input::placeholder { color: #64748b; }
        .search-input input:focus { outline: none; border-color: #14b8a6; }
        .search-input svg { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #64748b; width: 18px; height: 18px; }
        .filter-select { background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 0.5rem 1rem; color: white; font-size: 0.875rem; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: #14b8a6; }
        .table-wrapper { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 1rem; font-size: 0.75rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; background: rgba(15, 23, 42, 0.5); }
        .data-table td { padding: 1rem; border-bottom: 1px solid rgba(51, 65, 85, 0.5); }
        .data-table tr:hover { background: rgba(51, 65, 85, 0.2); }
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; border: 1px solid; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #34d399; border-color: rgba(16, 185, 129, 0.3); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
        .badge-info { background: rgba(6, 182, 212, 0.2); color: #22d3ee; border-color: rgba(6, 182, 212, 0.3); }
        .badge-default { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border-color: rgba(100, 116, 139, 0.3); }
        .progress-bar { width: 100%; }
        .progress-track { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; position: relative; }
        .progress-plan { position: absolute; height: 100%; background: #475569; opacity: 0.5; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .progress-fill.green { background: #10b981; }
        .progress-fill.yellow { background: #f59e0b; }
        .progress-fill.red { background: #ef4444; }
        .progress-labels { display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.75rem; }
        .progress-labels span:first-child { color: #94a3b8; }
        .progress-labels span:last-child { color: #64748b; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1e293b; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; border: 1px solid #334155; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #334155; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: white; }
        .modal-close { padding: 0.5rem; border-radius: 8px; background: transparent; border: none; color: #94a3b8; cursor: pointer; }
        .modal-close:hover { background: #334155; color: white; }
        .modal-body { padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 140px); }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .form-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #334155; padding-bottom: 1rem; flex-wrap: wrap; }
        .form-tab { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500; color: #94a3b8; background: transparent; border: none; cursor: pointer; }
        .form-tab:hover { background: #334155; color: white; }
        .form-tab.active { background: #0d9488; color: white; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group.full { grid-column: span 2; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.375rem; }
        .form-input, .form-select, .form-textarea { width: 100%; background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 0.625rem 1rem; color: white; font-size: 0.875rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2); }
        .form-textarea { resize: none; }
        .form-input::placeholder { color: #64748b; }
        .form-checkbox { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; }
        .form-checkbox input { width: 20px; height: 20px; accent-color: #14b8a6; }
        .form-checkbox label { color: #cbd5e1; font-weight: 500; }
        .milestone-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; margin-bottom: 0.75rem; }
        .milestone-label { color: #cbd5e1; font-weight: 500; }
        .milestone-input label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; }
        .milestone-input input { width: 100%; background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 0.5rem; color: white; font-size: 0.875rem; }
        .scurve-display { background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 0.625rem 1rem; color: #2dd4bf; }
        .package-card { background: linear-gradient(135deg, #1e293b, rgba(30, 41, 59, 0.5)); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(51, 65, 85, 0.5); margin-bottom: 1rem; }
        .package-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .package-tags { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .package-tag { padding: 0.25rem 0.625rem; border-radius: 8px; font-size: 0.75rem; font-weight: 500; }
        .package-tag.ho { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .package-tag.site { background: rgba(168, 85, 247, 0.2); color: #a78bfa; }
        .package-tag.default { background: #334155; color: #94a3b8; }
        .package-title { font-size: 1.25rem; font-weight: 600; color: white; margin-bottom: 0.25rem; }
        .package-desc { color: #94a3b8; font-size: 0.875rem; }
        .package-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .meta-item label { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        .meta-item span { color: white; }
        .package-milestones { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #334155; }
        .milestones-title { font-size: 0.875rem; font-weight: 500; color: #94a3b8; margin-bottom: 0.75rem; }
        .milestones-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .milestone-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.875rem; }
        .milestone-badge.completed { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #34d399; }
        .milestone-badge.pending { background: rgba(51, 65, 85, 0.5); border: 1px solid #475569; color: #94a3b8; }
        .package-progress { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .progress-section h4 { font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .progress-section h4 span { color: #2dd4bf; }
        .risk-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .risk-stat { border-radius: 16px; padding: 1.25rem; }
        .risk-stat.critical { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)); border: 1px solid rgba(239, 68, 68, 0.2); }
        .risk-stat.medium { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2); }
        .risk-stat.low { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); }
        .risk-stat.open { background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(8, 145, 178, 0.05)); border: 1px solid rgba(6, 182, 212, 0.2); }
        .risk-stat-content { display: flex; align-items: center; gap: 0.75rem; }
        .risk-stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .risk-stat.critical .risk-stat-icon { background: rgba(239, 68, 68, 0.2); }
        .risk-stat.critical .risk-stat-icon svg { color: #f87171; }
        .risk-stat.critical .risk-stat-value { color: #f87171; }
        .risk-stat.medium .risk-stat-icon { background: rgba(245, 158, 11, 0.2); }
        .risk-stat.medium .risk-stat-icon svg { color: #fbbf24; }
        .risk-stat.medium .risk-stat-value { color: #fbbf24; }
        .risk-stat.low .risk-stat-icon { background: rgba(16, 185, 129, 0.2); }
        .risk-stat.low .risk-stat-icon svg { color: #34d399; }
        .risk-stat.low .risk-stat-value { color: #34d399; }
        .risk-stat.open .risk-stat-icon { background: rgba(6, 182, 212, 0.2); }
        .risk-stat.open .risk-stat-icon svg { color: #22d3ee; }
        .risk-stat.open .risk-stat-value { color: #22d3ee; }
        .risk-stat-label { font-size: 0.875rem; color: #94a3b8; }
        .risk-stat-value { font-size: 1.875rem; font-weight: 700; }
        .heat-map { display: grid; grid-template-columns: auto repeat(3, 1fr); gap: 0.5rem; }
        .heat-map-header { text-align: center; font-size: 0.75rem; font-weight: 500; color: #94a3b8; padding: 0.5rem; }
        .heat-map-label { text-align: right; font-size: 0.75rem; font-weight: 500; color: #94a3b8; padding: 1rem 0.5rem; display: flex; align-items: center; justify-content: flex-end; }
        .heat-map-cell { border-radius: 8px; padding: 0.75rem; text-align: center; font-weight: 700; }
        .heat-map-cell.low-risk { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .heat-map-cell.med-risk { background: rgba(245, 158, 11, 0.3); color: #fbbf24; }
        .heat-map-cell.high-risk { background: rgba(239, 68, 68, 0.3); color: #f87171; }
        .project-card { background: linear-gradient(135deg, #1e293b, rgba(30, 41, 59, 0.5)); border-radius: 16px; border: 1px solid rgba(51, 65, 85, 0.5); overflow: hidden; margin-bottom: 1.5rem; }
        .project-card-body { padding: 1.5rem; }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .project-info { display: flex; align-items: center; gap: 0.75rem; }
        .project-icon { width: 40px; height: 40px; background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(6, 182, 212, 0.2)); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .project-icon svg { color: #2dd4bf; }
        .project-name { font-size: 1.25rem; font-weight: 600; color: white; }
        .project-type { font-size: 0.875rem; color: #94a3b8; }
        .project-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .project-detail label { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        .project-detail span { color: white; }
        .project-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #334155; }
        .metric-card { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1rem; }
        .metric-card-header { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.25rem; }
        .metric-card-header svg { width: 14px; height: 14px; }
        .metric-card-value { color: white; font-size: 0.875rem; }
        .metric-card-sub { color: #2dd4bf; font-size: 0.75rem; margin-top: 0.25rem; }
        .project-scope { margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.3); border-radius: 12px; border: 1px solid rgba(51, 65, 85, 0.5); }
        .project-scope label { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; }
        .project-scope p { color: #cbd5e1; font-size: 0.875rem; }
        .incoterm-info { padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #334155; margin-top: 1rem; }
        .incoterm-header { display: flex; align-items: center; gap: 0.5rem; color: #2dd4bf; font-weight: 500; margin-bottom: 0.5rem; }
        .incoterm-desc { color: #94a3b8; font-size: 0.875rem; }
        .incoterm-mode { color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: white; }
        .critical-item { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1rem; border: 1px solid rgba(239, 68, 68, 0.2); margin-bottom: 0.75rem; }
        .critical-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .critical-item h4 { color: white; font-weight: 500; }
        .critical-item p { color: #94a3b8; font-size: 0.875rem; }
        .critical-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .tag-critical { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .tag-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        /* View Detail Modal Styles */
        .modal-large { max-width: 1000px; width: 95%; max-height: 90vh; }
        .detail-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #334155; }
        .detail-title-section h2 { font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem; }
        .detail-title-section p { color: #94a3b8; font-size: 0.875rem; }
        .detail-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem; }
        .detail-section { margin-bottom: 1.5rem; }
        .detail-section-title { font-size: 1rem; font-weight: 600; color: #2dd4bf; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #334155; }
        .detail-section-title svg { width: 20px; height: 20px; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .detail-item { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1rem; border: 1px solid #334155; }
        .detail-item label { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        .detail-item span { color: white; font-size: 0.9rem; font-weight: 500; }
        .detail-item.highlight { border-color: rgba(20, 184, 166, 0.3); background: rgba(20, 184, 166, 0.1); }
        .milestone-timeline { display: flex; flex-direction: column; gap: 0.75rem; }
        .milestone-item { display: grid; grid-template-columns: 1fr 120px 120px 80px; gap: 1rem; align-items: center; padding: 0.75rem 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 10px; border: 1px solid #334155; }
        .milestone-item.completed { border-color: rgba(16, 185, 129, 0.3); }
        .milestone-item.pending { border-color: rgba(100, 116, 139, 0.3); }
        .milestone-name { color: white; font-weight: 500; }
        .milestone-date { color: #94a3b8; font-size: 0.875rem; text-align: center; }
        .milestone-date.actual { color: #2dd4bf; }
        .milestone-status { text-align: center; }
        .progress-detail { margin-top: 0.5rem; }
        .progress-detail-bar { height: 12px; background: #334155; border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 0.5rem; }
        .progress-detail-fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
        .progress-detail-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-detail-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-detail-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.875rem; color: #94a3b8; }
        .progress-info .value { color: white; font-weight: 600; }
        .btn-back { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: 1px solid #475569; background: transparent; color: #94a3b8; transition: all 0.2s; }
        .btn-back:hover { background: #334155; color: white; border-color: #14b8a6; }
        .btn-view { padding: 0.4rem 0.75rem; border-radius: 8px; background: rgba(6, 182, 212, 0.2); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.3); font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-view:hover { background: rgba(6, 182, 212, 0.3); }
        .delivery-status { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #334155; }
        .delivery-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(6, 182, 212, 0.2); }
        .delivery-icon svg { color: #22d3ee; width: 24px; height: 24px; }
        .delivery-info h4 { color: white; font-weight: 500; margin-bottom: 0.25rem; }
        .delivery-info p { color: #94a3b8; font-size: 0.875rem; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .form-group.full { grid-column: span 1; } .milestone-row { grid-template-columns: 1fr; } .milestone-item { grid-template-columns: 1fr; gap: 0.5rem; } .milestone-date { text-align: left; } .milestone-status { text-align: left; } }
        /* Weight Factor Styles */
        .wf-grid { display: grid; gap: 1rem; }
        .wf-section { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1rem; border: 1px solid #334155; }
        .wf-section-title { font-size: 0.875rem; font-weight: 600; color: #2dd4bf; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .wf-section-title svg { width: 18px; height: 18px; }
        .wf-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }
        .wf-item { display: flex; flex-direction: column; gap: 0.25rem; }
        .wf-item label { font-size: 0.75rem; color: #94a3b8; }
        .wf-item input { background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 0.5rem; color: white; font-size: 0.875rem; width: 100%; text-align: center; }
        .wf-item input:focus { outline: none; border-color: #14b8a6; }
        .wf-total { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(20, 184, 166, 0.1); border-radius: 12px; border: 1px solid rgba(20, 184, 166, 0.3); margin-top: 1rem; }
        .wf-total-label { font-size: 0.875rem; color: #94a3b8; }
        .wf-total-value { font-size: 1.5rem; font-weight: 700; }
        .wf-total-value.valid { color: #34d399; }
        .wf-total-value.invalid { color: #f87171; }
        .wf-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 1rem; font-size: 0.8rem; color: #93c5fd; }
        .wf-info svg { width: 18px; height: 18px; flex-shrink: 0; }
        .btn-settings { padding: 0.4rem 0.75rem; border-radius: 8px; background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.3); font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-settings:hover { background: rgba(100, 116, 139, 0.3); color: white; }
        .scurve-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .scurve-legend { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #94a3b8; }
        .status-date-picker { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(15, 23, 42, 0.8); border-radius: 10px; border: 1px solid #475569; }
        .cutoff-date-input { background: #0f172a; border: 1px solid #475569; border-radius: 6px; padding: 0.35rem 0.5rem; color: white; font-size: 0.8rem; cursor: pointer; }
        .cutoff-date-input:focus { outline: none; border-color: #14b8a6; }
        .cutoff-date-input::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .btn-today { padding: 0.35rem 0.6rem; border-radius: 6px; background: linear-gradient(135deg, #0d9488, #06b6d4); color: white; border: none; font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-today:hover { background: linear-gradient(135deg, #14b8a6, #22d3ee); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        /* Risk Grouping Styles */
        .risk-group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
        .risk-group-card { background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #334155; overflow: hidden; transition: all 0.2s; }
        .risk-group-card:hover { border-color: #475569; transform: translateY(-2px); }
        .risk-group-header { padding: 1rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .risk-group-header:hover { background: rgba(51, 65, 85, 0.3); }
        .risk-group-title { display: flex; align-items: center; gap: 0.75rem; }
        .risk-group-title h4 { color: white; font-weight: 600; font-size: 1rem; }
        .risk-group-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .risk-group-icon svg { width: 20px; height: 20px; }
        .risk-group-badges { display: flex; gap: 0.5rem; }
        .risk-group-count { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; }
        .risk-group-body { padding: 1rem; }
        .risk-group-item { padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(15, 23, 42, 0.8); border-radius: 8px; border-left: 3px solid; cursor: pointer; transition: all 0.2s; }
        .risk-group-item:hover { background: rgba(51, 65, 85, 0.5); }
        .risk-group-item:last-child { margin-bottom: 0; }
        .risk-group-item.critical { border-left-color: #f87171; }
        .risk-group-item.medium { border-left-color: #fbbf24; }
        .risk-group-item.low { border-left-color: #34d399; }
        .risk-group-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .risk-group-item-title { color: #e2e8f0; font-size: 0.875rem; font-weight: 500; flex: 1; }
        .risk-group-item-meta { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .risk-group-item-meta span { font-size: 0.7rem; color: #64748b; }
        .risk-group-more { text-align: center; padding: 0.75rem; color: #64748b; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .risk-group-more:hover { color: #94a3b8; background: rgba(51, 65, 85, 0.3); }
        /* Risk View Modal Styles */
        .risk-view-header { display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #334155; }
        .risk-view-level { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .risk-view-level.critical { background: rgba(239, 68, 68, 0.2); }
        .risk-view-level.medium { background: rgba(245, 158, 11, 0.2); }
        .risk-view-level.low { background: rgba(16, 185, 129, 0.2); }
        .risk-view-level svg { width: 28px; height: 28px; }
        .risk-view-info h3 { color: white; font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .risk-view-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .risk-view-section { margin-bottom: 1.5rem; }
        .risk-view-section-title { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem; }
        .risk-view-section-content { color: #e2e8f0; font-size: 0.9rem; line-height: 1.6; }
        .risk-view-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .risk-view-item { padding: 0.75rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #334155; }
        .risk-view-item label { display: block; color: #64748b; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.25rem; }
        .risk-view-item span { color: white; font-weight: 500; }
        /* Export Dropdown Styles */
        .export-dropdown { position: relative; display: inline-block; }
        .export-dropdown-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: #1e293b; border: 1px solid #475569; border-radius: 12px; min-width: 220px; z-index: 1000; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .export-dropdown-content.show { display: block; }
        .export-dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; color: #e2e8f0; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; border: none; background: transparent; width: 100%; text-align: left; }
        .export-dropdown-item:hover { background: rgba(20, 184, 166, 0.2); }
        .export-dropdown-item svg { width: 18px; height: 18px; color: #94a3b8; }
        .export-dropdown-item:hover svg { color: #2dd4bf; }
        .export-dropdown-divider { height: 1px; background: #334155; margin: 0.25rem 0; }
        .export-dropdown-header { padding: 0.5rem 1rem; font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; }
        /* PDF Export Loading Overlay */
        .pdf-loading-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .pdf-loading-overlay.show { display: flex; }
        .pdf-loading-spinner { width: 48px; height: 48px; border: 4px solid #334155; border-top-color: #14b8a6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pdf-loading-text { color: #e2e8f0; font-size: 1rem; }
        .pdf-loading-progress { color: #94a3b8; font-size: 0.875rem; }
        /* Data Management Dropdown Styles */
        .data-dropdown { position: relative; display: inline-block; }
        .data-dropdown-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: #1e293b; border: 1px solid #475569; border-radius: 12px; min-width: 240px; z-index: 1000; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .data-dropdown-content.show { display: block; }
        .data-dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; color: #e2e8f0; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; border: none; background: transparent; width: 100%; text-align: left; }
        .data-dropdown-item:hover { background: rgba(20, 184, 166, 0.2); }
        .data-dropdown-item svg { width: 18px; height: 18px; color: #94a3b8; }
        .data-dropdown-item:hover svg { color: #2dd4bf; }
        .data-dropdown-divider { height: 1px; background: #334155; margin: 0.25rem 0; }
        .data-dropdown-header { padding: 0.5rem 1rem; font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; }
        /* Import Modal Styles */
        .import-zone { border: 2px dashed #475569; border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(15, 23, 42, 0.5); }
        .import-zone:hover, .import-zone.dragover { border-color: #14b8a6; background: rgba(20, 184, 166, 0.1); }
        .import-zone svg { width: 48px; height: 48px; color: #64748b; margin-bottom: 1rem; }
        .import-zone:hover svg { color: #14b8a6; }
        .import-zone-text { color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .import-zone-hint { color: #64748b; font-size: 0.75rem; }
        .import-preview { margin-top: 1.5rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #475569; display: none; }
        .import-preview.show { display: block; }
        .import-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .import-preview-title { color: white; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .import-preview-title svg { width: 20px; height: 20px; color: #10b981; }
        .import-preview-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .import-stat { padding: 0.75rem; background: #1e293b; border-radius: 8px; text-align: center; }
        .import-stat-value { font-size: 1.5rem; font-weight: 700; color: #2dd4bf; }
        .import-stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
        .import-options { margin-top: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3); }
        .import-options-title { color: #fbbf24; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .import-options-title svg { width: 16px; height: 16px; }
        .import-radio-group { display: flex; flex-direction: column; gap: 0.75rem; }
        .import-radio { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; cursor: pointer; }
        .import-radio input { margin-top: 2px; accent-color: #14b8a6; }
        .import-radio-text { flex: 1; }
        .import-radio-label { color: #e2e8f0; font-size: 0.875rem; font-weight: 500; }
        .import-radio-desc { color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; }
        .import-file-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(20, 184, 166, 0.1); border-radius: 8px; border: 1px solid rgba(20, 184, 166, 0.3); margin-top: 1rem; }
        .import-file-icon { width: 40px; height: 40px; background: rgba(20, 184, 166, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .import-file-icon svg { width: 20px; height: 20px; color: #2dd4bf; }
        .import-file-details { flex: 1; }
        .import-file-name { color: white; font-weight: 500; font-size: 0.875rem; }
        .import-file-size { color: #94a3b8; font-size: 0.75rem; }
        .import-file-remove { padding: 0.5rem; background: transparent; border: none; color: #f87171; cursor: pointer; border-radius: 6px; }
        .import-file-remove:hover { background: rgba(248, 113, 113, 0.2); }
    </style>
</head>
<body>
    <!-- PDF Loading Overlay -->
    <div class="pdf-loading-overlay" id="pdfLoadingOverlay">
        <div class="pdf-loading-spinner"></div>
        <div class="pdf-loading-text">Generating PDF Report...</div>
        <div class="pdf-loading-progress" id="pdfLoadingProgress">Capturing charts and data</div>
    </div>

    <!-- Import Data Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align: middle; margin-right: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Import Data
                </h3>
                <button class="modal-close" onclick="closeImportModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="import-zone" id="importZone" onclick="document.getElementById('importFileInput').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    <p class="import-zone-text">Click to select file or drag & drop here</p>
                    <p class="import-zone-hint">Supported format: JSON (.json)</p>
                </div>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                
                <div class="import-file-info" id="importFileInfo" style="display: none;">
                    <div class="import-file-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <div class="import-file-details">
                        <div class="import-file-name" id="importFileName">-</div>
                        <div class="import-file-size" id="importFileSize">-</div>
                    </div>
                    <button class="import-file-remove" onclick="removeImportFile()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div class="import-preview" id="importPreview">
                    <div class="import-preview-header">
                        <div class="import-preview-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            File Valid - Ready to Import
                        </div>
                    </div>
                    <div class="import-preview-stats">
                        <div class="import-stat">
                            <div class="import-stat-value" id="importProjectCount">0</div>
                            <div class="import-stat-label">Projects</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="importPackageCount">0</div>
                            <div class="import-stat-label">Packages</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="importRiskCount">0</div>
                            <div class="import-stat-label">Risks</div>
                        </div>
                    </div>
                    
                    <div class="import-options">
                        <div class="import-options-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                            Import Options
                        </div>
                        <div class="import-radio-group">
                            <label class="import-radio">
                                <input type="radio" name="importMode" value="replace" checked>
                                <div class="import-radio-text">
                                    <div class="import-radio-label">Replace All Data</div>
                                    <div class="import-radio-desc">Delete all existing data and replace with imported data</div>
                                </div>
                            </label>
                            <label class="import-radio">
                                <input type="radio" name="importMode" value="merge">
                                <div class="import-radio-text">
                                    <div class="import-radio-label">Merge with Existing Data</div>
                                    <div class="import-radio-desc">Add imported data to existing data (may create duplicates)</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Import Data
                </button>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg></div>
                    <div class="logo-text"><h1>Procurement Management System</h1><p>End-to-End Procurement Tracking</p></div>
                </div>
                <div class="header-actions">
                    <select class="project-select" id="projectSelect" onchange="changeProject()"></select>
                    <!-- Data Management Dropdown -->
                    <div class="data-dropdown">
                        <button class="btn btn-secondary" onclick="toggleDataDropdown()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>
                            Data
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div class="data-dropdown-content" id="dataDropdown">
                            <div class="data-dropdown-header">Export Data</div>
                            <button class="data-dropdown-item" onclick="exportAllData()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                Export All Data (JSON)
                            </button>
                            <button class="data-dropdown-item" onclick="exportProjectData()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                                Export Current Project
                            </button>
                            <div class="data-dropdown-divider"></div>
                            <div class="data-dropdown-header">Import Data</div>
                            <button class="data-dropdown-item" onclick="openImportModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Import Data (JSON)
                            </button>
                            <div class="data-dropdown-divider"></div>
                            <div class="data-dropdown-header">Manage Data</div>
                            <button class="data-dropdown-item" onclick="resetToDefaults()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Reset to Default
                            </button>
                            <button class="data-dropdown-item" onclick="clearAllData()" style="color: #f87171;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #f87171;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                Clear All Data
                            </button>
                        </div>
                    </div>
                    <div class="export-dropdown">
                        <button class="btn btn-primary" onclick="toggleExportDropdown()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Export PDF
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div class="export-dropdown-content" id="exportDropdown">
                            <div class="export-dropdown-header">Export with Charts</div>
                            <button class="export-dropdown-item" onclick="exportDashboardPDF()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                Dashboard Report
                            </button>
                            <button class="export-dropdown-item" onclick="exportRiskAnalysisPDF()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                                Risk Analysis Report
                            </button>
                            <div class="export-dropdown-divider"></div>
                            <div class="export-dropdown-header">Quick Export (Table Only)</div>
                            <button class="export-dropdown-item" onclick="exportQuickPDF('dashboard')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                Dashboard (Quick)
                            </button>
                            <button class="export-dropdown-item" onclick="exportQuickPDF('risks')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                Risk Analysis (Quick)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>Dashboard</button>
                <button class="nav-tab" data-tab="packages" onclick="switchTab('packages')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>Packages</button>
                <button class="nav-tab" data-tab="projects" onclick="switchTab('projects')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>Projects</button>
                <button class="nav-tab" data-tab="risks" onclick="switchTab('risks')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>Risk Analysis</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid"></div>
            <div class="charts-grid">
                <div class="card"><div class="card-header"><h3 class="card-title">Progress by Discipline</h3></div><div class="card-body"><div class="chart-container"><canvas id="disciplineChart"></canvas></div></div></div>
                <div class="card">
                    <div class="card-header">
                        <div class="scurve-header">
                            <h3 class="card-title">Overall S-Curve <span id="scurveDynamicInfo" style="font-size:0.75rem;color:#94a3b8;font-weight:400;margin-left:0.5rem;">(Dynamic S-Curve)</span></h3>
                            <div style="display:flex;align-items:center;gap:0.75rem;">
                                <div class="status-date-picker">
                                    <label style="font-size:0.75rem;color:#94a3b8;margin-right:0.5rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;margin-right:0.25rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        Cut-off Date:
                                    </label>
                                    <input type="date" id="scurveCutoffDate" class="cutoff-date-input" onchange="onCutoffDateChange()">
                                    <button class="btn-today" onclick="setTodayAsCutoff()" title="Set to Today">Today</button>
                                </div>
                                <button class="btn-settings" onclick="openWeightFactorModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    Weight Factor
                                </button>
                            </div>
                        </div>
                        <div class="scurve-legend">
                            <div class="legend-item"><div class="legend-color" style="background:#14b8a6;"></div>Plan (S-Curve)</div>
                            <div class="legend-item"><div class="legend-color" style="background:#3b82f6;"></div>Actual (S-Curve)</div>
                        </div>
                        <div id="scurveDateRange" style="font-size:0.75rem;color:#64748b;margin-top:0.5rem;"></div>
                    </div>
                    <div class="card-body"><div class="chart-container"><canvas id="scurveChart"></canvas></div></div>
                </div>
            </div>
            <div class="card" id="criticalSection"></div>
            <div class="card">
                <div class="card-header">
                    <div class="filter-bar">
                        <h3 class="card-title">All Packages</h3>
                        <div class="filter-group">
                            <div class="search-input"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><input type="text" id="searchInput" placeholder="Search..." oninput="filterPackages()"></div>
                            <select class="filter-select" id="disciplineFilter" onchange="filterPackages()"><option value="">All Disciplines</option><option value="Process">Process</option><option value="Mechanical">Mechanical</option><option value="Piping">Piping</option><option value="Electrical">Electrical</option><option value="Instrument">Instrument</option><option value="Civil">Civil</option></select>
                            <button class="btn btn-primary" onclick="openPackageModal()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>Add Package</button>
                        </div>
                    </div>
                </div>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>Package</th><th>Discipline</th><th>Vendor</th><th>COO</th><th>PO Status</th><th>Mfg Progress</th><th>Actions</th></tr></thead><tbody id="packagesTableBody"></tbody></table></div>
            </div>
        </div>

        <div id="packages" class="tab-content">
            <div class="page-header"><h2 class="page-title">Procurement Packages</h2><button class="btn btn-primary" onclick="openPackageModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>New Package</button></div>
            <div id="packagesCards"></div>
        </div>

        <div id="projects" class="tab-content">
            <div class="page-header"><h2 class="page-title">Project Management</h2><button class="btn btn-primary" onclick="openProjectModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>New Project</button></div>
            <div id="projectsCards"></div>
        </div>

        <div id="risks" class="tab-content">
            <div class="page-header">
                <h2 class="page-title">Risk Analysis</h2>
                <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="autoGenerateRisks()" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        Auto-Generate Risks
                    </button>
                    <button class="btn btn-primary" onclick="openRiskModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Add Manual Risk
                    </button>
                </div>
            </div>
            
            <!-- Risk Statistics -->
            <div class="risk-stats" id="riskStats"></div>
            
            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="card"><div class="card-header"><h3 class="card-title">Risk Distribution</h3></div><div class="card-body"><div class="chart-container"><canvas id="riskPieChart"></canvas></div></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Risk Heat Map</h3></div><div class="card-body"><div id="riskHeatMap" class="heat-map"></div></div></div>
            </div>
            
            <!-- Risk Grouping Section (Auto + Manual Combined) -->
            <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem;">
                    <h3 class="card-title" style="display:flex;align-items:center;gap:0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        Risk Grouping
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <select class="filter-select" id="riskGroupBy" onchange="updateRiskGrouping()" style="min-width:150px;">
                            <option value="category">Group by Category</option>
                            <option value="level">Group by Risk Level</option>
                            <option value="package">Group by Package</option>
                            <option value="status">Group by Status</option>
                            <option value="source">Group by Source</option>
                        </select>
                    </div>
                </div>
                <div class="card-body" id="riskGroupingContent"></div>
            </div>
            
            <!-- Risk Register Table -->
            <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem;">
                    <h3 class="card-title">Risk Register</h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                        <select class="filter-select" id="riskFilterCategory" onchange="filterRisks()" style="min-width:120px;">
                            <option value="">All Categories</option>
                            <option value="Schedule">Schedule</option>
                            <option value="Technical">Technical</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Logistics">Logistics</option>
                            <option value="HSE">HSE</option>
                        </select>
                        <select class="filter-select" id="riskFilterType" onchange="filterRisks()" style="min-width:120px;">
                            <option value="">All Types</option>
                            <option value="auto">Auto-Generated</option>
                            <option value="manual">Manual Entry</option>
                        </select>
                        <select class="filter-select" id="riskFilterLevel" onchange="filterRisks()" style="min-width:100px;">
                            <option value="">All Levels</option>
                            <option value="Critical">Critical</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <select class="filter-select" id="riskFilterStatus" onchange="filterRisks()" style="min-width:100px;">
                            <option value="">All Status</option>
                            <option value="Open">Open</option>
                            <option value="Monitoring">Monitoring</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Package</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Level</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="riskTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Risk View Modal -->
    <div class="modal-overlay" id="riskViewModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="riskViewTitle">Risk Details</h2>
                <button class="modal-close" onclick="closeRiskViewModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="modal-body" id="riskViewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRiskViewModal()">Close</button>
                <button class="btn btn-primary" id="riskViewEditBtn" onclick="editRiskFromView()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    Edit Risk
                </button>
            </div>
        </div>
    </div>

    <!-- Risk Group View Modal -->
    <div class="modal-overlay" id="riskGroupViewModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="riskGroupViewTitle">Risk Group Details</h2>
                <button class="modal-close" onclick="closeRiskGroupViewModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="modal-body" id="riskGroupViewContent" style="max-height:70vh;overflow-y:auto;"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRiskGroupViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Package Modal -->
    <div class="modal-overlay" id="packageModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="packageModalTitle">Add Package</h2><button class="modal-close" onclick="closePackageModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="modal-body">
                <div class="form-tabs">
                    <button class="form-tab active" onclick="switchFormTab('master')">Master Data</button>
                    <button class="form-tab" onclick="switchFormTab('milestones')">Milestones</button>
                    <button class="form-tab" onclick="switchFormTab('engineering')">Engineering</button>
                    <button class="form-tab" onclick="switchFormTab('manufacture')">Manufacture</button>
                    <button class="form-tab" onclick="switchFormTab('delivery')">Delivery</button>
                </div>
                <form id="packageForm">
                    <input type="hidden" id="packageId">
                    <div class="form-section active" id="masterSection">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Initiation</label><select class="form-select" id="initiation"><option value="HO">HO</option><option value="Site">Site</option></select></div>
                            <div class="form-group"><label class="form-label">Discipline</label><select class="form-select" id="discipline"><option value="Process">Process</option><option value="Mechanical">Mechanical</option><option value="Piping">Piping</option><option value="Electrical">Electrical</option><option value="Instrument">Instrument</option><option value="Civil">Civil</option></select></div>
                            <div class="form-group"><label class="form-label">Area</label><select class="form-select" id="area"><option value="GPP">GPP</option><option value="SAGS">SAGS</option></select></div>
                            <div class="form-group"><label class="form-label">RFQ No</label><input type="text" class="form-input" id="rfqNo" placeholder="RFQ-2024-XXX"></div>
                            <div class="form-group full"><label class="form-label">Package Name</label><input type="text" class="form-input" id="packageName" placeholder="Enter package name"></div>
                            <div class="form-group full"><label class="form-label">Description</label><textarea class="form-textarea" id="packageDesc" rows="2" placeholder="Enter description"></textarea></div>
                            <div class="form-group"><label class="form-label">Contract No</label><input type="text" class="form-input" id="contractNo" placeholder="PO-2024-XXX"></div>
                            <div class="form-group"><label class="form-label">Vendor Name</label><input type="text" class="form-input" id="vendorName" placeholder="Vendor name"></div>
                            <div class="form-group full"><label class="form-label">Country of Origin</label><select class="form-select" id="coo"><option value="">Select country</option></select></div>
                        </div>
                    </div>
                    <div class="form-section" id="milestonesSection"><div id="milestonesFields"></div></div>
                    <div class="form-section" id="engineeringSection">
                        <div class="form-checkbox"><input type="checkbox" id="engRequired"><label for="engRequired">Engineering Required</label></div>
                        <div id="engineeringFields" style="margin-top:1rem;display:none;">
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Plan Start</label><input type="date" class="form-input" id="engPlanStart" onchange="calcEngineeringPlanProgress()"></div>
                                <div class="form-group"><label class="form-label">Plan Finish</label><input type="date" class="form-input" id="engPlanFinish" onchange="calcEngineeringPlanProgress()"></div>
                                <div class="form-group"><label class="form-label">Actual Start</label><input type="date" class="form-input" id="engActualStart"></div>
                                <div class="form-group"><label class="form-label">Actual Finish</label><input type="date" class="form-input" id="engActualFinish"></div>
                                <div class="form-group"><label class="form-label">Status Date (for Plan %)</label><input type="date" class="form-input" id="engStatusDate" onchange="calcEngineeringPlanProgress()"></div>
                                <div class="form-group"><label class="form-label">Plan Progress (S-Curve)</label><div class="scurve-display" id="engPlanProgress">0%</div></div>
                                <div class="form-group"><label class="form-label">Actual Progress (%)</label><input type="number" class="form-input" id="engActualProgress" min="0" max="100" value="0"></div>
                                <div class="form-group full"><label class="form-label">Remark</label><textarea class="form-textarea" id="engRemark" rows="2"></textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section" id="manufactureSection">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Plan Start</label><input type="date" class="form-input" id="mfgPlanStart" onchange="calcManufacturePlanProgress()"></div>
                            <div class="form-group"><label class="form-label">Plan Finish</label><input type="date" class="form-input" id="mfgPlanFinish" onchange="calcManufacturePlanProgress()"></div>
                            <div class="form-group"><label class="form-label">Actual Start</label><input type="date" class="form-input" id="mfgActualStart"></div>
                            <div class="form-group"><label class="form-label">Actual Finish</label><input type="date" class="form-input" id="mfgActualFinish"></div>
                            <div class="form-group"><label class="form-label">Status Date (for Plan %)</label><input type="date" class="form-input" id="mfgStatusDate" onchange="calcManufacturePlanProgress()"></div>
                            <div class="form-group"><label class="form-label">Plan Progress (S-Curve)</label><div class="scurve-display" id="mfgPlanProgress">0%</div></div>
                            <div class="form-group"><label class="form-label">Actual Progress (%)</label><input type="number" class="form-input" id="mfgActualProgress" min="0" max="100" value="0"></div>
                            <div class="form-group full"><label class="form-label">Remark</label><textarea class="form-textarea" id="mfgRemark" rows="2"></textarea></div>
                        </div>
                        
                        <!-- FAT Section -->
                        <div style="margin-top:1rem;padding:1rem;background:rgba(139,92,246,0.1);border-radius:12px;border:1px solid rgba(139,92,246,0.2);">
                            <h4 style="color:#a78bfa;font-size:0.875rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Factory Acceptance Test (FAT)
                            </h4>
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Plan FAT Date</label><input type="date" class="form-input" id="mfgPlanFAT"></div>
                                <div class="form-group"><label class="form-label">Actual FAT Date</label><input type="date" class="form-input" id="mfgActualFAT"></div>
                                <div class="form-group"><label class="form-label">FAT Status</label>
                                    <div class="scurve-display" id="fatStatusDisplay" style="background:rgba(100,116,139,0.2);color:#94a3b8;">Pending</div>
                                </div>
                                <div class="form-group"><label class="form-label">FAT Result</label>
                                    <select class="form-select" id="mfgFATResult">
                                        <option value="">Not Yet</option>
                                        <option value="Passed">Passed</option>
                                        <option value="Passed with Remarks">Passed with Remarks</option>
                                        <option value="Failed">Failed</option>
                                    </select>
                                </div>
                                <div class="form-group full"><label class="form-label">FAT Remarks</label><textarea class="form-textarea" id="mfgFATRemarks" rows="2" placeholder="FAT findings, punch list items, etc."></textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section" id="deliverySection">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Incoterm 2020</label><select class="form-select" id="incoterm" onchange="updateIncotermInfo()"></select></div>
                            <div class="form-group"><label class="form-label">Delivery Location</label><input type="text" class="form-input" id="deliveryLocation" placeholder="e.g., Tanjung Priok Port"></div>
                        </div>
                        <div class="incoterm-info" id="incotermInfo" style="display:none;"></div>
                        
                        <!-- Shipping Section -->
                        <div style="margin-top:1.5rem;padding:1rem;background:rgba(6,182,212,0.1);border-radius:12px;border:1px solid rgba(6,182,212,0.2);">
                            <h4 style="color:#22d3ee;font-size:0.875rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                Shipping / Delivery Status
                            </h4>
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Plan Delivery 100%</label><input type="date" class="form-input" id="planDelivery100" onchange="calcDeliveryPlanStatus()"></div>
                                <div class="form-group"><label class="form-label">Actual Delivery 100%</label><input type="date" class="form-input" id="actualDelivery100"></div>
                                <div class="form-group"><label class="form-label">Status Date (for Plan %)</label><input type="date" class="form-input" id="shippingStatusDate" onchange="calcDeliveryPlanStatus()"></div>
                                <div class="form-group"><label class="form-label">Shipping Status Plan (%)</label><div class="scurve-display" id="shippingStatusPlanDisplay">0%</div></div>
                                <div class="form-group"><label class="form-label">Shipping Status Actual (%)</label><input type="number" class="form-input" id="shippingStatus" min="0" max="100" value="0"></div>
                            </div>
                        </div>
                        
                        <!-- Material at Site Section -->
                        <div style="margin-top:1rem;padding:1rem;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);">
                            <h4 style="color:#34d399;font-size:0.875rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                                Material Received at Site
                            </h4>
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Plan Material 100% at Site</label><input type="date" class="form-input" id="planMaterialAtSite100" onchange="calcDeliveryPlanStatus()"></div>
                                <div class="form-group"><label class="form-label">Actual Material 100% at Site</label><input type="date" class="form-input" id="actualMaterialAtSite100"></div>
                                <div class="form-group"><label class="form-label">Status Date (for Plan %)</label><input type="date" class="form-input" id="materialStatusDate" onchange="calcDeliveryPlanStatus()"></div>
                                <div class="form-group"><label class="form-label">Material at Site Plan (%)</label><div class="scurve-display" id="materialAtSitePlanDisplay">0%</div></div>
                                <div class="form-group"><label class="form-label">Material at Site Actual (%)</label><input type="number" class="form-input" id="materialReceivedActual" min="0" max="100" value="0"></div>
                            </div>
                        </div>
                        
                        <!-- Legacy fields for backward compatibility -->
                        <input type="hidden" id="deliveryPlanDate">
                        <input type="hidden" id="deliveryActualDate">
                        <input type="hidden" id="requiredAtSite">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closePackageModal()">Cancel</button><button class="btn btn-primary" onclick="savePackage()">Save</button></div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="projectModalTitle">Add Project</h2><button class="modal-close" onclick="closeProjectModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-grid">
                        <div class="form-group full"><label class="form-label">Project Name</label><input type="text" class="form-input" id="projName" placeholder="Project name"></div>
                        <div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="projOwner" placeholder="Owner"></div>
                        <div class="form-group"><label class="form-label">Contractor</label><input type="text" class="form-input" id="projContractor" placeholder="Contractor"></div>
                        <div class="form-group"><label class="form-label">Technology Provider</label><input type="text" class="form-input" id="projTechProvider" placeholder="Technology provider"></div>
                        <div class="form-group"><label class="form-label">Contract Type</label><select class="form-select" id="projContractType"><option value="EPC Lump Sum">EPC Lump Sum</option><option value="Turnkey">Turnkey</option><option value="Build & Design">Build & Design</option><option value="Unit Rate Basis">Unit Rate Basis</option><option value="EPCM">EPCM</option></select></div>
                        <div class="form-group"><label class="form-label">Contract Price (USD)</label><input type="number" class="form-input" id="projContractPrice" placeholder="Amount"></div>
                        <div class="form-group"><label class="form-label">Payment Term</label><select class="form-select" id="projPaymentTerm"><option value="Milestone Payment">Milestone Payment</option><option value="Progress Payment">Progress Payment</option><option value="Milestone + Progress">Milestone + Progress</option></select></div>
                        <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="projStartDate"></div>
                        <div class="form-group"><label class="form-label">Finish Date</label><input type="date" class="form-input" id="projFinishDate"></div>
                        <div class="form-group"><label class="form-label">LD Delay (USD/day)</label><input type="number" class="form-input" id="projLdDelay" placeholder="Amount"></div>
                        <div class="form-group"><label class="form-label">LD Performance (USD/kW)</label><input type="number" class="form-input" id="projLdPerformance" placeholder="Amount"></div>
                        <div class="form-group"><label class="form-label">Guarantee Power (MW)</label><input type="number" class="form-input" id="projGuaranteePower" placeholder="MW"></div>
                        <div class="form-group full"><label class="form-label">Scope by Owner</label><textarea class="form-textarea" id="projScopeByOwner" rows="2" placeholder="Scope"></textarea></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Save</button></div>
        </div>
    </div>

    <!-- Risk Modal -->
    <div class="modal-overlay" id="riskModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="riskModalTitle">Add Risk</h2><button class="modal-close" onclick="closeRiskModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="modal-body">
                <form id="riskForm">
                    <input type="hidden" id="riskId">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Package</label><select class="form-select" id="riskPackageId"></select></div>
                        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="riskCategory"><option value="Schedule">Schedule</option><option value="Technical">Technical</option><option value="Commercial">Commercial</option><option value="Logistics">Logistics</option><option value="HSE">HSE</option></select></div>
                        <div class="form-group full"><label class="form-label">Description</label><textarea class="form-textarea" id="riskDescription" rows="2" placeholder="Risk description"></textarea></div>
                        <div class="form-group"><label class="form-label">Probability</label><select class="form-select" id="riskProbability" onchange="calcRiskLevel()"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div>
                        <div class="form-group"><label class="form-label">Impact</label><select class="form-select" id="riskImpact" onchange="calcRiskLevel()"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div>
                        <div class="form-group"><label class="form-label">Risk Level</label><div id="riskLevelDisplay" class="scurve-display" style="background:rgba(245,158,11,0.2);color:#fbbf24;">Medium</div></div>
                        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="riskStatus"><option value="Open">Open</option><option value="Monitoring">Monitoring</option><option value="Closed">Closed</option></select></div>
                        <div class="form-group full"><label class="form-label">Mitigation</label><textarea class="form-textarea" id="riskMitigation" rows="2" placeholder="Mitigation plan"></textarea></div>
                        <div class="form-group"><label class="form-label">Owner</label><input type="text" class="form-input" id="riskOwner" placeholder="Risk owner"></div>
                        <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="riskDueDate"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeRiskModal()">Cancel</button><button class="btn btn-primary" onclick="saveRisk()">Save</button></div>
        </div>
    </div>

    <!-- Package Detail View Modal -->
    <div class="modal-overlay" id="packageDetailModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <div style="display:flex;align-items:center;gap:1rem;">
                    <button class="btn-back" onclick="closePackageDetail()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        Back
                    </button>
                    <h2 class="modal-title">Package Detail</h2>
                </div>
                <button class="modal-close" onclick="closePackageDetail()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body" id="packageDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn-back" onclick="closePackageDetail()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    Back to Previous Page
                </button>
                <button class="btn btn-primary" onclick="editPackageFromDetail()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    Edit Package
                </button>
            </div>
        </div>
    </div>

    <!-- Weight Factor Modal -->
    <div class="modal-overlay" id="weightFactorModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2 class="modal-title">S-Curve Weight Factor Settings</h2>
                <button class="modal-close" onclick="closeWeightFactorModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body">
                <div class="wf-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Weight factors determine the contribution of each activity to the overall S-Curve progress. Total must equal 100%.
                </div>
                <div class="wf-grid">
                    <!-- Milestones Section -->
                    <div class="wf-section">
                        <div class="wf-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                            Milestones Weight Factor (%)
                        </div>
                        <div class="wf-items">
                            <div class="wf-item"><label>Issue RFQ</label><input type="number" id="wfIssueRFQ" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Receive Quotation</label><input type="number" id="wfReceiveQuotation" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Issue TBE</label><input type="number" id="wfIssueTBE" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Issue CBE</label><input type="number" id="wfIssueCBE" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Final Negotiation</label><input type="number" id="wfFinalNegotiation" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Issue PO</label><input type="number" id="wfIssuePO" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>KOM</label><input type="number" id="wfKOM" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                        </div>
                    </div>
                    
                    <!-- Engineering Section -->
                    <div class="wf-section">
                        <div class="wf-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
                            Engineering Weight Factor (%)
                        </div>
                        <div class="wf-items">
                            <div class="wf-item"><label>Engineering Progress</label><input type="number" id="wfEngineering" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                        </div>
                    </div>
                    
                    <!-- Manufacture Section -->
                    <div class="wf-section">
                        <div class="wf-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                            Manufacture Weight Factor (%)
                        </div>
                        <div class="wf-items">
                            <div class="wf-item"><label>Manufacture Progress</label><input type="number" id="wfManufacture" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>FAT (Factory Acceptance Test)</label><input type="number" id="wfFAT" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                        </div>
                    </div>
                    
                    <!-- Delivery Section -->
                    <div class="wf-section">
                        <div class="wf-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                            Delivery Weight Factor (%)
                        </div>
                        <div class="wf-items">
                            <div class="wf-item"><label>Shipping Status</label><input type="number" id="wfShipping" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                            <div class="wf-item"><label>Material at Site</label><input type="number" id="wfMaterialAtSite" min="0" max="100" step="0.5" onchange="updateWFTotal()"></div>
                        </div>
                    </div>
                </div>
                
                <div class="wf-total">
                    <span class="wf-total-label">Total Weight Factor</span>
                    <span class="wf-total-value" id="wfTotalDisplay">100%</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetWeightFactors()">Reset to Default</button>
                <button class="btn btn-secondary" onclick="closeWeightFactorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveWeightFactors()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const countries = ["Indonesia","China","Japan","South Korea","Germany","United States","Italy","France","United Kingdom","Netherlands","Singapore","Malaysia","Thailand","Vietnam","India","Taiwan","Australia"].sort();
        const incoterms = [{code:"EXW",name:"Ex Works",mode:"all",desc:"Seller makes goods available at their premises"},{code:"FCA",name:"Free Carrier",mode:"all",desc:"Seller delivers goods to carrier"},{code:"CPT",name:"Carriage Paid To",mode:"all",desc:"Seller pays freight to destination"},{code:"CIP",name:"Carriage Insurance Paid",mode:"all",desc:"Seller pays freight and insurance"},{code:"DAP",name:"Delivered at Place",mode:"all",desc:"Seller delivers at destination"},{code:"DPU",name:"Delivered at Place Unloaded",mode:"all",desc:"Seller delivers and unloads"},{code:"DDP",name:"Delivered Duty Paid",mode:"all",desc:"Seller delivers cleared for import"},{code:"FAS",name:"Free Alongside Ship",mode:"sea",desc:"Seller delivers alongside vessel"},{code:"FOB",name:"Free on Board",mode:"sea",desc:"Seller delivers on board vessel"},{code:"CFR",name:"Cost and Freight",mode:"sea",desc:"Seller pays freight to port"},{code:"CIF",name:"Cost Insurance Freight",mode:"sea",desc:"Seller pays freight and insurance to port"}];
        const milestoneLabels = [{key:'issueRFQ',label:'Issue RFQ'},{key:'receiveQuotation',label:'Receive Quotation'},{key:'issueTBE',label:'Issue TBE'},{key:'issueCBE',label:'Issue CBE'},{key:'finalNegotiation',label:'Final Negotiation'},{key:'issuePO',label:'Issue PO'},{key:'kom',label:'KOM'}];

        // Storage Key Constants
        const STORAGE_KEYS = {
            PROJECTS: 'procurement_projects',
            PACKAGES: 'procurement_packages',
            RISKS: 'procurement_risks',
            SELECTED_PROJECT: 'procurement_selected_project',
            WEIGHT_FACTORS: 'procurement_weight_factors'
        };

        // Default Weight Factors (must total 100%)
        const defaultWeightFactors = {
            milestones: {
                issueRFQ: 2,
                receiveQuotation: 3,
                issueTBE: 3,
                issueCBE: 3,
                finalNegotiation: 4,
                issuePO: 5,
                kom: 5
            },
            engineering: 15,
            manufacture: 40,
            fat: 5,
            delivery: {
                shipping: 10,
                materialAtSite: 5
            }
        };

        // Current Weight Factors (will be loaded from localStorage)
        let weightFactors = JSON.parse(JSON.stringify(defaultWeightFactors));

        // Default Data (used only when localStorage is empty)
        const defaultProjects = [{id:1,name:"Geothermal Power Plant Dieng Unit 2",owner:"PT Geo Dipa Energi",contractor:"PT Rekayasa Industri",technologyProvider:"Fuji Electric",contractType:"EPC Lump Sum",contractPrice:125000000,paymentTerm:"Milestone + Progress",startDate:"2024-01-15",finishDate:"2026-06-30",ldDelay:50000,ldPerformance:25000,guaranteePower:55,scopeByOwner:"Land acquisition, Permits, Steam supply"}];
        const defaultPackages = [
            {id:1,projectId:1,initiation:"HO",discipline:"Mechanical",area:"GPP",packageName:"Main Turbine Generator",description:"55MW geothermal turbine generator",rfqNo:"RFQ-2024-001",contractNo:"PO-2024-MTG-001",vendorName:"Fuji Electric",coo:"Japan",milestones:{issueRFQ:{plan:"2024-02-01",actual:"2024-02-03"},receiveQuotation:{plan:"2024-03-15",actual:"2024-03-20"},issueTBE:{plan:"2024-04-01",actual:"2024-04-05"},issueCBE:{plan:"2024-04-15",actual:"2024-04-18"},finalNegotiation:{plan:"2024-05-01",actual:"2024-05-10"},issuePO:{plan:"2024-05-15",actual:"2024-05-20"},kom:{plan:"2024-06-01",actual:"2024-06-05"}},engineering:{required:true,planStart:"2024-06-15",planFinish:"2024-10-30",actualStart:"2024-06-20",actualFinish:"2024-11-15",statusDate:"",planProgress:0,actualProgress:85,remark:"Minor delay"},manufacture:{planStart:"2024-09-01",planFinish:"2025-06-30",actualStart:"2024-09-15",actualFinish:"",statusDate:"",planProgress:0,actualProgress:45,remark:"On track",planFAT:"2025-06-15",actualFAT:"",fatResult:"",fatRemarks:""},delivery:{incoterm:"CIF",deliveryLocation:"Tanjung Priok",planDelivery100:"2025-07-30",actualDelivery100:"",shippingStatusDate:"",shippingStatusPlan:0,shippingStatus:20,planMaterialAtSite100:"2025-08-30",actualMaterialAtSite100:"",materialStatusDate:"",materialAtSitePlan:0,materialReceivedActual:0}},
            {id:2,projectId:1,initiation:"Site",discipline:"Electrical",area:"GPP",packageName:"Main Transformer",description:"Step-up transformer 70MVA",rfqNo:"RFQ-2024-002",contractNo:"PO-2024-TRF-001",vendorName:"Hyundai Electric",coo:"South Korea",milestones:{issueRFQ:{plan:"2024-03-01",actual:"2024-03-01"},receiveQuotation:{plan:"2024-04-15",actual:"2024-04-12"},issueTBE:{plan:"2024-05-01",actual:"2024-04-28"},issueCBE:{plan:"2024-05-15",actual:"2024-05-14"},finalNegotiation:{plan:"2024-06-01",actual:"2024-05-30"},issuePO:{plan:"2024-06-15",actual:"2024-06-10"},kom:{plan:"2024-07-01",actual:"2024-06-28"}},engineering:{required:true,planStart:"2024-07-15",planFinish:"2024-09-30",actualStart:"2024-07-10",actualFinish:"2024-09-25",statusDate:"",planProgress:0,actualProgress:100,remark:"Completed"},manufacture:{planStart:"2024-10-01",planFinish:"2025-04-30",actualStart:"2024-10-05",actualFinish:"",statusDate:"",planProgress:0,actualProgress:70,remark:"On schedule",planFAT:"2025-04-15",actualFAT:"",fatResult:"",fatRemarks:""},delivery:{incoterm:"FOB",deliveryLocation:"Busan Port",planDelivery100:"2025-05-15",actualDelivery100:"",shippingStatusDate:"",shippingStatusPlan:0,shippingStatus:0,planMaterialAtSite100:"2025-06-15",actualMaterialAtSite100:"",materialStatusDate:"",materialAtSitePlan:0,materialReceivedActual:0}},
            {id:3,projectId:1,initiation:"HO",discipline:"Process",area:"SAGS",packageName:"Steam Above Ground System",description:"SAGS piping system",rfqNo:"RFQ-2024-003",contractNo:"PO-2024-SAGS-001",vendorName:"PT Citra Tubindo",coo:"Indonesia",milestones:{issueRFQ:{plan:"2024-02-15",actual:"2024-02-15"},receiveQuotation:{plan:"2024-03-30",actual:"2024-04-05"},issueTBE:{plan:"2024-04-15",actual:"2024-04-20"},issueCBE:{plan:"2024-04-30",actual:"2024-05-05"},finalNegotiation:{plan:"2024-05-15",actual:"2024-05-20"},issuePO:{plan:"2024-06-01",actual:"2024-06-08"},kom:{plan:"2024-06-15",actual:"2024-06-20"}},engineering:{required:false,planStart:"",planFinish:"",actualStart:"",actualFinish:"",statusDate:"",planProgress:0,actualProgress:0,remark:""},manufacture:{planStart:"2024-07-01",planFinish:"2025-02-28",actualStart:"2024-07-10",actualFinish:"",statusDate:"",planProgress:0,actualProgress:92,remark:"Nearing completion",planFAT:"2025-02-15",actualFAT:"2025-02-20",fatResult:"Passed",fatRemarks:"All tests passed"},delivery:{incoterm:"DAP",deliveryLocation:"Site Dieng",planDelivery100:"2025-03-15",actualDelivery100:"",shippingStatusDate:"",shippingStatusPlan:0,shippingStatus:0,planMaterialAtSite100:"2025-03-30",actualMaterialAtSite100:"",materialStatusDate:"",materialAtSitePlan:0,materialReceivedActual:0}},
            {id:4,projectId:1,initiation:"Site",discipline:"Instrument",area:"GPP",packageName:"DCS & Instrumentation",description:"Distributed Control System",rfqNo:"RFQ-2024-004",contractNo:"",vendorName:"",coo:"",milestones:{issueRFQ:{plan:"2024-04-01",actual:"2024-04-05"},receiveQuotation:{plan:"2024-05-15",actual:"2024-05-25"},issueTBE:{plan:"2024-06-01",actual:""},issueCBE:{plan:"2024-06-15",actual:""},finalNegotiation:{plan:"2024-07-01",actual:""},issuePO:{plan:"2024-07-15",actual:""},kom:{plan:"2024-08-01",actual:""}},engineering:{required:true,planStart:"2024-08-15",planFinish:"2024-12-31",actualStart:"",actualFinish:"",statusDate:"",planProgress:0,actualProgress:0,remark:"Awaiting PO"},manufacture:{planStart:"2025-01-01",planFinish:"2025-06-30",actualStart:"",actualFinish:"",statusDate:"",planProgress:0,actualProgress:0,remark:"",planFAT:"2025-06-15",actualFAT:"",fatResult:"",fatRemarks:""},delivery:{incoterm:"DDP",deliveryLocation:"Site Dieng",planDelivery100:"2025-07-15",actualDelivery100:"",shippingStatusDate:"",shippingStatusPlan:0,shippingStatus:0,planMaterialAtSite100:"2025-08-01",actualMaterialAtSite100:"",materialStatusDate:"",materialAtSitePlan:0,materialReceivedActual:0}}
        ];
        const defaultRisks = [
            {id:1,projectId:1,packageId:1,category:"Schedule",riskDescription:"Potential delay in turbine manufacturing",probability:"High",impact:"High",riskLevel:"Critical",status:"Open",mitigation:"Expedite critical components",owner:"Procurement Manager",dueDate:"2025-03-15"},
            {id:2,projectId:1,packageId:2,category:"Technical",riskDescription:"Transformer spec may require revision",probability:"Medium",impact:"Medium",riskLevel:"Medium",status:"Monitoring",mitigation:"Coordinate with PLN",owner:"Engineering Manager",dueDate:"2025-01-30"},
            {id:3,projectId:1,packageId:4,category:"Commercial",riskDescription:"DCS bidding delayed",probability:"High",impact:"High",riskLevel:"Critical",status:"Open",mitigation:"Fast-track TBE/CBE",owner:"Project Manager",dueDate:"2025-01-15"},
            {id:4,projectId:1,packageId:3,category:"Logistics",riskDescription:"Road access during rainy season",probability:"Medium",impact:"Low",riskLevel:"Low",status:"Monitoring",mitigation:"Plan deliveries outside rainy season",owner:"Logistics",dueDate:"2025-02-28"}
        ];

        // Initialize variables - will be loaded from localStorage or defaults
        let projects = [];
        let packages = [];
        let risks = [];
        let selectedProject = 1, currentTab = 'dashboard', charts = {};

        // ===== LOCAL STORAGE FUNCTIONS =====
        
        // Save all data to localStorage
        function saveAllData() {
            try {
                localStorage.setItem(STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
                localStorage.setItem(STORAGE_KEYS.PACKAGES, JSON.stringify(packages));
                localStorage.setItem(STORAGE_KEYS.RISKS, JSON.stringify(risks));
                localStorage.setItem(STORAGE_KEYS.SELECTED_PROJECT, selectedProject.toString());
                localStorage.setItem(STORAGE_KEYS.WEIGHT_FACTORS, JSON.stringify(weightFactors));
                console.log('Data saved to localStorage successfully');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showNotification('Error saving data. Storage may be full.', 'error');
            }
        }

        // Load all data from localStorage
        function loadAllData() {
            try {
                const storedProjects = localStorage.getItem(STORAGE_KEYS.PROJECTS);
                const storedPackages = localStorage.getItem(STORAGE_KEYS.PACKAGES);
                const storedRisks = localStorage.getItem(STORAGE_KEYS.RISKS);
                const storedSelectedProject = localStorage.getItem(STORAGE_KEYS.SELECTED_PROJECT);
                const storedWeightFactors = localStorage.getItem(STORAGE_KEYS.WEIGHT_FACTORS);

                // Load or use defaults
                projects = storedProjects ? JSON.parse(storedProjects) : [...defaultProjects];
                packages = storedPackages ? JSON.parse(storedPackages) : [...defaultPackages];
                risks = storedRisks ? JSON.parse(storedRisks) : [...defaultRisks];
                selectedProject = storedSelectedProject ? parseInt(storedSelectedProject) : 1;
                weightFactors = storedWeightFactors ? JSON.parse(storedWeightFactors) : JSON.parse(JSON.stringify(defaultWeightFactors));

                // If this is first time (no data in storage), save defaults
                if (!storedProjects) {
                    saveAllData();
                }

                console.log('Data loaded from localStorage successfully');
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                // Fallback to defaults
                projects = [...defaultProjects];
                packages = [...defaultPackages];
                risks = [...defaultRisks];
                selectedProject = 1;
            }
        }

        // Reset data to defaults
        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all data to defaults? This cannot be undone.')) {
                projects = [...defaultProjects];
                packages = [...defaultPackages];
                risks = [...defaultRisks];
                weightFactors = JSON.parse(JSON.stringify(defaultWeightFactors));
                selectedProject = 1;
                saveAllData();
                populateSelects();
                renderAll();
                showNotification('Data has been reset to defaults', 'success');
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                projects = [];
                packages = [];
                risks = [];
                saveAllData();
                populateSelects();
                renderAll();
                showNotification('All data has been cleared', 'success');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notif = document.getElementById('notification');
            if (!notif) {
                notif = document.createElement('div');
                notif.id = 'notification';
                notif.style.cssText = 'position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:500;z-index:9999;transition:all 0.3s ease;opacity:0;transform:translateX(100%);';
                document.body.appendChild(notif);
            }
            
            // Set colors based on type
            const colors = {
                success: { bg: 'rgba(16, 185, 129, 0.9)', color: '#fff' },
                error: { bg: 'rgba(239, 68, 68, 0.9)', color: '#fff' },
                info: { bg: 'rgba(6, 182, 212, 0.9)', color: '#fff' }
            };
            const style = colors[type] || colors.info;
            
            notif.style.background = style.bg;
            notif.style.color = style.color;
            notif.textContent = message;
            
            // Show
            setTimeout(() => {
                notif.style.opacity = '1';
                notif.style.transform = 'translateX(0)';
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(100%)';
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => { initApp(); });

        function initApp() { 
            loadAllData(); // Load data from localStorage first
            populateSelects(); 
            initCutoffDate(); // Initialize cut-off date to today
            renderAll(); 
            initCharts(); 
        }

        function populateSelects() {
            document.getElementById('projectSelect').innerHTML = projects.map(p => '<option value="'+p.id+'"'+(p.id===selectedProject?' selected':'')+'>'+p.name+'</option>').join('');
            document.getElementById('coo').innerHTML = '<option value="">Select</option>' + countries.map(c => '<option value="'+c+'">'+c+'</option>').join('');
            document.getElementById('incoterm').innerHTML = incoterms.map(i => '<option value="'+i.code+'">'+i.code+' - '+i.name+'</option>').join('');
            document.getElementById('milestonesFields').innerHTML = milestoneLabels.map(m => '<div class="milestone-row"><div class="milestone-label">'+m.label+'</div><div class="milestone-input"><label>Plan</label><input type="date" id="'+m.key+'Plan"></div><div class="milestone-input"><label>Actual</label><input type="date" id="'+m.key+'Actual"></div></div>').join('');
            document.getElementById('engRequired').addEventListener('change', function() { document.getElementById('engineeringFields').style.display = this.checked ? 'block' : 'none'; });
            // Ensure selectedProject is valid
            if(projects.length > 0 && !projects.find(p => p.id === selectedProject)) {
                selectedProject = projects[0].id;
                saveAllData();
            }
        }

        function calculateSCurve(start, end, current) {
            if (!start || !end) return 0;
            const s = new Date(start).getTime(), e = new Date(end).getTime(), c = current ? new Date(current).getTime() : Date.now();
            if (c <= s) return 0; if (c >= e) return 100;
            return Math.round(100 / (1 + Math.exp(-10 * ((c - s) / (e - s) - 0.5))) * 10) / 10;
        }

        function daysDiff(d1, d2) { if (!d1 || !d2) return null; return Math.ceil((new Date(d2) - new Date(d1)) / 86400000); }
        function getProjectPackages() { return packages.filter(p => p.projectId === selectedProject); }
        function getProjectRisks() { return risks.filter(r => r.projectId === selectedProject); }
        function getStats() {
            const pkgs = getProjectPackages(), total = pkgs.length, poIssued = pkgs.filter(p => p.milestones.issuePO.actual).length;
            const criticalCount = pkgs.filter(p => !p.milestones.issuePO.actual || p.manufacture.actualProgress < calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish) - 10).length;
            const avgProgress = total > 0 ? Math.round(pkgs.reduce((a, p) => a + p.manufacture.actualProgress, 0) / total) : 0;
            return { total, poIssued, criticalCount, avgProgress };
        }

        function renderAll() { renderStats(); renderPackagesTable(); renderPackagesCards(); renderProjectsCards(); renderCriticalItems(); renderRisks(); if (charts.discipline) updateCharts(); }

        function renderStats() {
            const s = getStats();
            document.getElementById('statsGrid').innerHTML = '<div class="stat-card"><div class="stat-card-content"><div><p class="stat-label">Total Packages</p><p class="stat-value">'+s.total+'</p></div><div class="stat-icon blue"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg></div></div></div><div class="stat-card"><div class="stat-card-content"><div><p class="stat-label">PO Issued</p><p class="stat-value">'+s.poIssued+'</p></div><div class="stat-icon emerald"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div></div></div><div class="stat-card"><div class="stat-card-content"><div><p class="stat-label">Critical Items</p><p class="stat-value">'+s.criticalCount+'</p></div><div class="stat-icon red"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div></div></div><div class="stat-card"><div class="stat-card-content"><div><p class="stat-label">Avg Progress</p><p class="stat-value">'+s.avgProgress+'%</p></div><div class="stat-icon teal"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></div></div></div>';
        }

        function renderPackagesTable() {
            const search = document.getElementById('searchInput').value.toLowerCase(), disc = document.getElementById('disciplineFilter').value;
            const filtered = getProjectPackages().filter(p => (p.packageName.toLowerCase().includes(search) || p.vendorName.toLowerCase().includes(search)) && (!disc || p.discipline === disc));
            document.getElementById('packagesTableBody').innerHTML = filtered.map(p => {
                const plan = calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish), v = p.manufacture.actualProgress - plan, color = v >= 0 ? 'green' : v > -10 ? 'yellow' : 'red';
                return '<tr><td><div style="font-weight:500;color:white;">'+p.packageName+'</div><div style="font-size:0.875rem;color:#94a3b8;">'+p.rfqNo+'</div></td><td><span class="badge badge-default">'+p.discipline+'</span></td><td style="color:#cbd5e1;">'+(p.vendorName||'-')+'</td><td style="color:#cbd5e1;">'+(p.coo||'-')+'</td><td>'+(p.milestones.issuePO.actual?'<span class="badge badge-success">Issued</span>':'<span class="badge badge-warning">Pending</span>')+'</td><td style="min-width:140px;"><div class="progress-bar"><div class="progress-track"><div class="progress-plan" style="width:'+plan+'%"></div><div class="progress-fill '+color+'" style="width:'+p.manufacture.actualProgress+'%"></div></div><div class="progress-labels"><span>'+p.manufacture.actualProgress+'%</span><span>Plan: '+Math.round(plan)+'%</span></div></div></td><td><div class="action-buttons"><button class="btn-view" onclick="viewPackage('+p.id+')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>View</button><button class="btn-icon" onclick="editPackage('+p.id+')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button class="btn-icon" onclick="deletePackage('+p.id+')" style="color:#f87171;"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td></tr>';
            }).join('');
        }

        function renderPackagesCards() {
            document.getElementById('packagesCards').innerHTML = getProjectPackages().map(p => {
                const plan = calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish);
                return '<div class="package-card"><div class="package-header"><div><div class="package-tags"><span class="package-tag '+(p.initiation==='HO'?'ho':'site')+'">'+p.initiation+'</span><span class="package-tag default">'+p.discipline+'</span><span class="package-tag default">'+p.area+'</span></div><h3 class="package-title">'+p.packageName+'</h3><p class="package-desc">'+p.description+'</p></div><div class="action-buttons"><button class="btn-view" onclick="viewPackage('+p.id+')" style="padding:0.5rem 1rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>View</button><button class="btn btn-secondary" onclick="editPackage('+p.id+')">Edit</button></div></div><div class="package-meta"><div class="meta-item"><label>RFQ No</label><span>'+p.rfqNo+'</span></div><div class="meta-item"><label>Contract</label><span>'+(p.contractNo||'-')+'</span></div><div class="meta-item"><label>Vendor</label><span>'+(p.vendorName||'-')+'</span></div><div class="meta-item"><label>COO</label><span>'+(p.coo||'-')+'</span></div></div><div class="package-milestones"><p class="milestones-title">Milestones</p><div class="milestones-list">'+milestoneLabels.map(m=>'<div class="milestone-badge '+(p.milestones[m.key].actual?'completed':'pending')+'">'+(p.milestones[m.key].actual?'':'')+' '+m.label.split(' ')[0]+'</div>').join('')+'</div></div><div class="package-progress"><div class="progress-section"><h4>Manufacture <span>'+p.manufacture.actualProgress+'%</span></h4><div class="progress-bar"><div class="progress-track"><div class="progress-plan" style="width:'+plan+'%"></div><div class="progress-fill '+(p.manufacture.actualProgress>=plan?'green':'yellow')+'" style="width:'+p.manufacture.actualProgress+'%"></div></div></div></div></div></div>';
            }).join('');
        }

        function renderProjectsCards() {
            document.getElementById('projectsCards').innerHTML = projects.map(proj => {
                const pkgCount = packages.filter(p => p.projectId === proj.id).length, dur = daysDiff(proj.startDate, proj.finishDate);
                return '<div class="project-card"><div class="project-card-body"><div class="project-header"><div class="project-info"><div class="project-icon"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></div><div><h3 class="project-name">'+proj.name+'</h3><p class="project-type">'+proj.contractType+'</p></div></div><div class="action-buttons"><button class="btn btn-primary" onclick="editProject('+proj.id+')">Edit</button><button class="btn btn-secondary" onclick="deleteProject('+proj.id+')" style="margin-left:0.5rem;color:#f87171;">Delete</button></div></div><div class="project-details"><div class="project-detail"><label>Owner</label><span>'+proj.owner+'</span></div><div class="project-detail"><label>Contractor</label><span>'+proj.contractor+'</span></div><div class="project-detail"><label>Technology</label><span>'+proj.technologyProvider+'</span></div><div class="project-detail"><label>Contract Value</label><span>$'+(proj.contractPrice/1000000).toFixed(1)+'M</span></div></div><div class="project-metrics"><div class="metric-card"><div class="metric-card-header">Schedule</div><div class="metric-card-value">'+proj.startDate+' - '+proj.finishDate+'</div><div class="metric-card-sub">'+dur+' days</div></div><div class="metric-card"><div class="metric-card-header">LD Delay</div><div class="metric-card-value">$'+proj.ldDelay.toLocaleString()+'/day</div></div><div class="metric-card"><div class="metric-card-header">Power</div><div class="metric-card-value">'+proj.guaranteePower+' MW</div></div><div class="metric-card"><div class="metric-card-header">Packages</div><div class="metric-card-value">'+pkgCount+'</div></div></div>'+(proj.scopeByOwner?'<div class="project-scope"><label>Scope by Owner</label><p>'+proj.scopeByOwner+'</p></div>':'')+'</div></div>';
            }).join('');
        }

        function renderCriticalItems() {
            const items = getProjectPackages().map(p => {
                const issues = [], plan = calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish);
                if (!p.milestones.issuePO.actual) issues.push({type:'critical',msg:'PO not issued'});
                if (p.manufacture.actualProgress < plan - 10) issues.push({type:'warning',msg:'Behind schedule'});
                return issues.length > 0 ? {...p, issues} : null;
            }).filter(Boolean);
            const section = document.getElementById('criticalSection');
            if (items.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            section.innerHTML = '<div class="card-header"><h3 class="card-title" style="color:#f87171;"> Critical Items</h3></div><div class="card-body">'+items.map(i=>'<div class="critical-item"><div class="critical-item-header"><div><h4>'+i.packageName+'</h4><p>'+(i.vendorName||'Vendor TBD')+'  '+i.discipline+'</p></div></div><div class="critical-tags">'+i.issues.map(is=>'<span class="tag tag-'+is.type+'">'+is.msg+'</span>').join('')+'</div></div>').join('')+'</div>';
        }

        function renderRisks() {
            const allRisks = getProjectRisks();
            const r = allRisks;
            const crit = r.filter(x=>x.riskLevel==='Critical').length;
            const med = r.filter(x=>x.riskLevel==='Medium').length;
            const low = r.filter(x=>x.riskLevel==='Low').length;
            const open = r.filter(x=>x.status==='Open').length;
            const autoCount = r.filter(x=>x.isAutoGenerated).length;
            const manualCount = r.filter(x=>!x.isAutoGenerated).length;
            
            document.getElementById('riskStats').innerHTML = '<div class="risk-stat critical"><div class="risk-stat-content"><div class="risk-stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><div><p class="risk-stat-label">Critical</p><p class="risk-stat-value">'+crit+'</p></div></div></div><div class="risk-stat medium"><div class="risk-stat-content"><div class="risk-stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="risk-stat-label">Medium</p><p class="risk-stat-value">'+med+'</p></div></div></div><div class="risk-stat low"><div class="risk-stat-content"><div class="risk-stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="risk-stat-label">Low</p><p class="risk-stat-value">'+low+'</p></div></div></div><div class="risk-stat open"><div class="risk-stat-content"><div class="risk-stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div><div><p class="risk-stat-label">Open</p><p class="risk-stat-value">'+open+'</p></div></div></div>';
            
            const hm = {};['High','Medium','Low'].forEach(p=>['Low','Medium','High'].forEach(i=>{hm[p+'-'+i]=r.filter(x=>x.probability===p&&x.impact===i).length;}));
            document.getElementById('riskHeatMap').innerHTML = '<div></div><div class="heat-map-header">Low</div><div class="heat-map-header">Med</div><div class="heat-map-header">High</div><div class="heat-map-label">High</div><div class="heat-map-cell med-risk">'+hm['High-Low']+'</div><div class="heat-map-cell high-risk">'+hm['High-Medium']+'</div><div class="heat-map-cell high-risk">'+hm['High-High']+'</div><div class="heat-map-label">Med</div><div class="heat-map-cell low-risk">'+hm['Medium-Low']+'</div><div class="heat-map-cell med-risk">'+hm['Medium-Medium']+'</div><div class="heat-map-cell high-risk">'+hm['Medium-High']+'</div><div class="heat-map-label">Low</div><div class="heat-map-cell low-risk">'+hm['Low-Low']+'</div><div class="heat-map-cell low-risk">'+hm['Low-Medium']+'</div><div class="heat-map-cell med-risk">'+hm['Low-High']+'</div>';
            
            // Apply filters
            const filterCategory = document.getElementById('riskFilterCategory')?.value || '';
            const filterType = document.getElementById('riskFilterType')?.value || '';
            const filterLevel = document.getElementById('riskFilterLevel')?.value || '';
            const filterStatus = document.getElementById('riskFilterStatus')?.value || '';
            
            let filteredRisks = r;
            if (filterCategory) filteredRisks = filteredRisks.filter(x => x.category === filterCategory);
            if (filterType === 'auto') filteredRisks = filteredRisks.filter(x => x.isAutoGenerated);
            if (filterType === 'manual') filteredRisks = filteredRisks.filter(x => !x.isAutoGenerated);
            if (filterLevel) filteredRisks = filteredRisks.filter(x => x.riskLevel === filterLevel);
            if (filterStatus) filteredRisks = filteredRisks.filter(x => x.status === filterStatus);
            
            document.getElementById('riskTableBody').innerHTML = filteredRisks.map(x => {
                const pkg = packages.find(p => p.id === x.packageId);
                const sourceLabel = x.isAutoGenerated ? 
                    '<span class="badge" style="background:rgba(139,92,246,0.2);color:#a78bfa;border-color:rgba(139,92,246,0.3);">Auto</span>' : 
                    '<span class="badge" style="background:rgba(100,116,139,0.2);color:#94a3b8;border-color:rgba(100,116,139,0.3);">Manual</span>';
                return '<tr><td style="color:white;font-weight:500;">'+(pkg?.packageName||'Project Level')+'</td><td><span class="badge badge-default">'+x.category+'</span></td><td style="max-width:200px;color:#cbd5e1;font-size:0.875rem;">'+x.riskDescription.substring(0, 80)+(x.riskDescription.length > 80 ? '...' : '')+'</td><td><span class="badge badge-'+(x.riskLevel==='Critical'?'danger':x.riskLevel==='Medium'?'warning':'success')+'">'+x.riskLevel+'</span></td><td><span class="badge badge-'+(x.status==='Open'?'info':x.status==='Monitoring'?'warning':'success')+'">'+x.status+'</span></td><td>'+sourceLabel+'</td><td><div class="action-buttons"><button class="btn-view" onclick="viewRisk('+x.id+')" title="View Details"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button><button class="btn-icon" onclick="editRisk('+x.id+')" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button class="btn-icon" onclick="deleteRisk('+x.id+')" style="color:#f87171;" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td></tr>';
            }).join('');
            
            document.getElementById('riskPackageId').innerHTML = '<option value="">Select (or leave empty for Project Level)</option>' + getProjectPackages().map(p=>'<option value="'+p.id+'">'+p.packageName+'</option>').join('');
            
            // Update risk grouping
            updateRiskGrouping();
        }
        
        function filterRisks() {
            renderRisks();
        }
        
        // ===== RISK GROUPING FUNCTIONS =====
        
        function updateRiskGrouping() {
            const allRisks = getProjectRisks();
            const groupBy = document.getElementById('riskGroupBy')?.value || 'category';
            const groupingContent = document.getElementById('riskGroupingContent');
            
            if (!groupingContent || allRisks.length === 0) {
                if (groupingContent) {
                    groupingContent.innerHTML = '<div style="text-align:center;padding:2rem;color:#64748b;">No risks found. Click "Auto-Generate Risks" or "Add Manual Risk" to get started.</div>';
                }
                return;
            }
            
            // Group risks based on selected criteria
            const groups = {};
            allRisks.forEach(risk => {
                let key;
                switch (groupBy) {
                    case 'category':
                        key = risk.category;
                        break;
                    case 'level':
                        key = risk.riskLevel;
                        break;
                    case 'package':
                        const pkg = packages.find(p => p.id === risk.packageId);
                        key = pkg ? pkg.packageName : 'Project Level';
                        break;
                    case 'status':
                        key = risk.status;
                        break;
                    case 'source':
                        key = risk.isAutoGenerated ? 'Auto-Generated' : 'Manual Entry';
                        break;
                    default:
                        key = risk.category;
                }
                if (!groups[key]) groups[key] = [];
                groups[key].push(risk);
            });
            
            // Sort groups
            const sortedKeys = Object.keys(groups).sort((a, b) => {
                if (groupBy === 'level') {
                    const order = { 'Critical': 0, 'Medium': 1, 'Low': 2 };
                    return (order[a] || 99) - (order[b] || 99);
                }
                return a.localeCompare(b);
            });
            
            let html = '<div class="risk-group-grid">';
            
            sortedKeys.forEach(key => {
                const groupRisks = groups[key];
                const critCount = groupRisks.filter(r => r.riskLevel === 'Critical').length;
                const medCount = groupRisks.filter(r => r.riskLevel === 'Medium').length;
                const lowCount = groupRisks.filter(r => r.riskLevel === 'Low').length;
                const autoCount = groupRisks.filter(r => r.isAutoGenerated).length;
                const manualCount = groupRisks.filter(r => !r.isAutoGenerated).length;
                
                const groupConfig = getGroupConfig(groupBy, key);
                
                html += `
                <div class="risk-group-card">
                    <div class="risk-group-header" onclick="viewRiskGroup('${groupBy}', '${key.replace(/'/g, "\\'")}')">
                        <div class="risk-group-title">
                            <div class="risk-group-icon" style="background:${groupConfig.bgColor};">
                                ${groupConfig.icon}
                            </div>
                            <div>
                                <h4>${key}</h4>
                                <div style="font-size:0.75rem;color:#64748b;">${groupRisks.length} risk${groupRisks.length !== 1 ? 's' : ''}  ${autoCount} auto, ${manualCount} manual</div>
                            </div>
                        </div>
                        <div class="risk-group-badges">
                            ${critCount > 0 ? '<span class="risk-group-count" style="background:rgba(239,68,68,0.2);color:#f87171;">'+critCount+' Critical</span>' : ''}
                            ${medCount > 0 ? '<span class="risk-group-count" style="background:rgba(245,158,11,0.2);color:#fbbf24;">'+medCount+' Medium</span>' : ''}
                            ${lowCount > 0 ? '<span class="risk-group-count" style="background:rgba(16,185,129,0.2);color:#34d399;">'+lowCount+' Low</span>' : ''}
                        </div>
                    </div>
                    <div class="risk-group-body">
                        ${groupRisks.slice(0, 3).map(risk => {
                            const pkg = packages.find(p => p.id === risk.packageId);
                            const levelClass = risk.riskLevel.toLowerCase();
                            return `
                            <div class="risk-group-item ${levelClass}" onclick="viewRisk(${risk.id})">
                                <div class="risk-group-item-header">
                                    <div class="risk-group-item-title">${risk.riskDescription.substring(0, 70)}${risk.riskDescription.length > 70 ? '...' : ''}</div>
                                </div>
                                <div class="risk-group-item-meta">
                                    <span>${pkg?.packageName || 'Project Level'}</span>
                                    <span></span>
                                    <span>${risk.status}</span>
                                    <span></span>
                                    <span style="color:${risk.isAutoGenerated ? '#a78bfa' : '#94a3b8'}">${risk.isAutoGenerated ? 'Auto' : 'Manual'}</span>
                                </div>
                            </div>`;
                        }).join('')}
                        ${groupRisks.length > 3 ? `
                        <div class="risk-group-more" onclick="viewRiskGroup('${groupBy}', '${key.replace(/'/g, "\\'")}')">
                            View all ${groupRisks.length} risks 
                        </div>` : ''}
                    </div>
                </div>`;
            });
            
            html += '</div>';
            groupingContent.innerHTML = html;
        }
        
        function getGroupConfig(groupBy, key) {
            const configs = {
                category: {
                    'Schedule': { bgColor: 'rgba(59,130,246,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#60a5fa"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
                    'Technical': { bgColor: 'rgba(139,92,246,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#a78bfa"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg>' },
                    'Commercial': { bgColor: 'rgba(236,72,153,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#f472b6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
                    'Logistics': { bgColor: 'rgba(245,158,11,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#fbbf24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>' },
                    'HSE': { bgColor: 'rgba(16,185,129,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#34d399"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>' }
                },
                level: {
                    'Critical': { bgColor: 'rgba(239,68,68,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#f87171"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' },
                    'Medium': { bgColor: 'rgba(245,158,11,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#fbbf24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
                    'Low': { bgColor: 'rgba(16,185,129,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#34d399"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' }
                },
                status: {
                    'Open': { bgColor: 'rgba(6,182,212,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#22d3ee"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
                    'Monitoring': { bgColor: 'rgba(245,158,11,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#fbbf24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>' },
                    'Closed': { bgColor: 'rgba(16,185,129,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#34d399"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' }
                },
                source: {
                    'Auto-Generated': { bgColor: 'rgba(139,92,246,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#a78bfa"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>' },
                    'Manual Entry': { bgColor: 'rgba(100,116,139,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#94a3b8"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' }
                }
            };
            
            const defaultConfig = { bgColor: 'rgba(100,116,139,0.2)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#94a3b8"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>' };
            
            return configs[groupBy]?.[key] || defaultConfig;
        }
        
        // ===== RISK VIEW FUNCTIONS =====
        
        let currentViewRiskId = null;
        
        function viewRisk(riskId) {
            const risk = risks.find(r => r.id === riskId);
            if (!risk) return;
            
            currentViewRiskId = riskId;
            const pkg = packages.find(p => p.id === risk.packageId);
            const levelColor = risk.riskLevel === 'Critical' ? '#f87171' : risk.riskLevel === 'Medium' ? '#fbbf24' : '#34d399';
            const levelClass = risk.riskLevel.toLowerCase();
            
            const html = `
            <div class="risk-view-header">
                <div class="risk-view-level ${levelClass}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="${levelColor}">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="risk-view-info">
                    <h3>${risk.riskLevel} Risk</h3>
                    <div class="risk-view-tags">
                        <span class="badge badge-default">${risk.category}</span>
                        <span class="badge badge-${risk.status === 'Open' ? 'info' : risk.status === 'Monitoring' ? 'warning' : 'success'}">${risk.status}</span>
                        ${risk.isAutoGenerated ? 
                            '<span class="badge" style="background:rgba(139,92,246,0.2);color:#a78bfa;border-color:rgba(139,92,246,0.3);">Auto-Generated</span>' : 
                            '<span class="badge" style="background:rgba(100,116,139,0.2);color:#94a3b8;border-color:rgba(100,116,139,0.3);">Manual Entry</span>'}
                    </div>
                </div>
            </div>
            
            <div class="risk-view-section">
                <div class="risk-view-section-title">Risk Description</div>
                <div class="risk-view-section-content">${risk.riskDescription}</div>
            </div>
            
            <div class="risk-view-section">
                <div class="risk-view-section-title">Mitigation Plan</div>
                <div class="risk-view-section-content">${risk.mitigation || 'No mitigation plan defined'}</div>
            </div>
            
            <div class="risk-view-grid">
                <div class="risk-view-item">
                    <label>Package</label>
                    <span>${pkg?.packageName || 'Project Level'}</span>
                </div>
                <div class="risk-view-item">
                    <label>Risk Owner</label>
                    <span>${risk.owner || 'Not assigned'}</span>
                </div>
                <div class="risk-view-item">
                    <label>Probability</label>
                    <span>${risk.probability}</span>
                </div>
                <div class="risk-view-item">
                    <label>Impact</label>
                    <span>${risk.impact}</span>
                </div>
                <div class="risk-view-item">
                    <label>Due Date</label>
                    <span>${risk.dueDate ? new Date(risk.dueDate).toLocaleDateString('id-ID') : 'Not set'}</span>
                </div>
                <div class="risk-view-item">
                    <label>Created</label>
                    <span>${risk.generatedDate ? new Date(risk.generatedDate).toLocaleDateString('id-ID') : 'N/A'}</span>
                </div>
            </div>
            
            ${risk.lastModified ? `
            <div style="margin-top:1rem;padding:0.75rem;background:rgba(59,130,246,0.1);border-radius:8px;border:1px solid rgba(59,130,246,0.2);font-size:0.8rem;color:#93c5fd;">
                <strong>Last Modified:</strong> ${new Date(risk.lastModified).toLocaleString('id-ID')}
            </div>` : ''}
            `;
            
            document.getElementById('riskViewTitle').textContent = 'Risk Details - ' + risk.category;
            document.getElementById('riskViewContent').innerHTML = html;
            document.getElementById('riskViewModal').classList.add('active');
        }
        
        function closeRiskViewModal() {
            document.getElementById('riskViewModal').classList.remove('active');
            currentViewRiskId = null;
        }
        
        function editRiskFromView() {
            if (currentViewRiskId) {
                closeRiskViewModal();
                editRisk(currentViewRiskId);
            }
        }
        
        function viewRiskGroup(groupBy, key) {
            const allRisks = getProjectRisks();
            let groupRisks = [];
            
            switch (groupBy) {
                case 'category':
                    groupRisks = allRisks.filter(r => r.category === key);
                    break;
                case 'level':
                    groupRisks = allRisks.filter(r => r.riskLevel === key);
                    break;
                case 'package':
                    if (key === 'Project Level') {
                        groupRisks = allRisks.filter(r => !r.packageId);
                    } else {
                        const pkg = packages.find(p => p.packageName === key);
                        groupRisks = allRisks.filter(r => r.packageId === pkg?.id);
                    }
                    break;
                case 'status':
                    groupRisks = allRisks.filter(r => r.status === key);
                    break;
                case 'source':
                    groupRisks = allRisks.filter(r => key === 'Auto-Generated' ? r.isAutoGenerated : !r.isAutoGenerated);
                    break;
            }
            
            const autoCount = groupRisks.filter(r => r.isAutoGenerated).length;
            const manualCount = groupRisks.filter(r => !r.isAutoGenerated).length;
            
            let html = `
            <div style="margin-bottom:1rem;padding:1rem;background:rgba(15,23,42,0.5);border-radius:12px;border:1px solid #334155;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase;">Total Risks</div>
                        <div style="font-size:1.5rem;font-weight:700;color:white;">${groupRisks.length}</div>
                    </div>
                    <div style="display:flex;gap:1rem;">
                        <div style="text-align:center;">
                            <div style="font-size:0.7rem;color:#a78bfa;">Auto</div>
                            <div style="font-size:1.25rem;font-weight:600;color:#a78bfa;">${autoCount}</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.7rem;color:#94a3b8;">Manual</div>
                            <div style="font-size:1.25rem;font-weight:600;color:#94a3b8;">${manualCount}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.75rem;">
            `;
            
            groupRisks.forEach(risk => {
                const pkg = packages.find(p => p.id === risk.packageId);
                const levelColor = risk.riskLevel === 'Critical' ? '#f87171' : risk.riskLevel === 'Medium' ? '#fbbf24' : '#34d399';
                
                html += `
                <div style="padding:1rem;background:rgba(15,23,42,0.8);border-radius:10px;border-left:4px solid ${levelColor};cursor:pointer;transition:all 0.2s;" onclick="closeRiskGroupViewModal();viewRisk(${risk.id});" onmouseover="this.style.background='rgba(51,65,85,0.5)'" onmouseout="this.style.background='rgba(15,23,42,0.8)'">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">
                        <div style="color:white;font-weight:500;flex:1;">${risk.riskDescription}</div>
                        <span class="badge badge-${risk.riskLevel === 'Critical' ? 'danger' : risk.riskLevel === 'Medium' ? 'warning' : 'success'}" style="flex-shrink:0;margin-left:0.5rem;">${risk.riskLevel}</span>
                    </div>
                    <div style="display:flex;gap:1rem;flex-wrap:wrap;font-size:0.8rem;color:#94a3b8;">
                        <span>${pkg?.packageName || 'Project Level'}</span>
                        <span></span>
                        <span>${risk.category}</span>
                        <span></span>
                        <span>${risk.status}</span>
                        <span></span>
                        <span style="color:${risk.isAutoGenerated ? '#a78bfa' : '#64748b'};">${risk.isAutoGenerated ? 'Auto' : 'Manual'}</span>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            
            document.getElementById('riskGroupViewTitle').textContent = key + ' Risks';
            document.getElementById('riskGroupViewContent').innerHTML = html;
            document.getElementById('riskGroupViewModal').classList.add('active');
        }
        
        function closeRiskGroupViewModal() {
            document.getElementById('riskGroupViewModal').classList.remove('active');
        }
        
        function updateAutoRiskSummary() {
            // This function is now replaced by updateRiskGrouping
            // Keeping for backward compatibility
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'Schedule': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                'Technical': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg>',
                'Commercial': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                'Logistics': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>',
                'HSE': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>'
            };
            return icons[category] || '';
        }

        // ===== AUTO-GENERATE RISKS FUNCTIONS =====
        
        function autoGenerateRisks() {
            const pkgs = getProjectPackages();
            if (pkgs.length === 0) {
                showNotification('No packages found. Please add packages first.', 'warning');
                return;
            }
            
            // Remove existing auto-generated risks for this project
            risks = risks.filter(r => r.projectId !== selectedProject || !r.isAutoGenerated);
            
            const today = new Date();
            const generatedRisks = [];
            
            pkgs.forEach(pkg => {
                const pkgRisks = analyzePackageRisks(pkg, today);
                generatedRisks.push(...pkgRisks);
            });
            
            // Add project-level risks
            const projectRisks = analyzeProjectLevelRisks(pkgs, today);
            generatedRisks.push(...projectRisks);
            
            // Add generated risks to the risks array
            risks.push(...generatedRisks);
            
            saveAllData();
            renderRisks();
            if (charts.riskPie) updateCharts();
            
            // Update last generated time
            const timeEl = document.getElementById('lastGeneratedTime');
            if (timeEl) {
                timeEl.textContent = 'Generated: ' + today.toLocaleString('id-ID');
            }
            
            showNotification(`Auto-generated ${generatedRisks.length} risks from ${pkgs.length} packages`, 'success');
        }
        
        function analyzePackageRisks(pkg, today) {
            const generatedRisks = [];
            const planMfg = calculateSCurve(pkg.manufacture.planStart, pkg.manufacture.planFinish);
            
            // 1. SCHEDULE RISKS
            
            // Check if PO not issued yet
            if (!pkg.milestones.issuePO.actual) {
                const poPlannedDate = pkg.milestones.issuePO.plan ? new Date(pkg.milestones.issuePO.plan) : null;
                const isOverdue = poPlannedDate && today > poPlannedDate;
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: pkg.id,
                    category: 'Schedule',
                    riskDescription: `PO not yet issued for ${pkg.packageName}${isOverdue ? ' - OVERDUE' : ''}`,
                    probability: isOverdue ? 'High' : 'Medium',
                    impact: 'High',
                    riskLevel: isOverdue ? 'Critical' : 'Medium',
                    status: 'Open',
                    mitigation: 'Expedite procurement process, escalate to management if needed',
                    owner: 'Procurement Manager',
                    dueDate: pkg.milestones.issuePO.plan || '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // Check manufacture delay
            if (pkg.manufacture.actualProgress < planMfg - 10 && pkg.milestones.issuePO.actual) {
                const delay = Math.round(planMfg - pkg.manufacture.actualProgress);
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: pkg.id,
                    category: 'Schedule',
                    riskDescription: `Manufacturing behind schedule by ${delay}% for ${pkg.packageName}`,
                    probability: delay > 20 ? 'High' : 'Medium',
                    impact: delay > 20 ? 'High' : 'Medium',
                    riskLevel: delay > 20 ? 'Critical' : 'Medium',
                    status: 'Open',
                    mitigation: 'Expedite manufacturing, consider air freight, add resources',
                    owner: 'Project Manager',
                    dueDate: pkg.manufacture.planFinish || '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // Check engineering delay (if required)
            if (pkg.engineering.required) {
                const planEng = calculateSCurve(pkg.engineering.planStart, pkg.engineering.planFinish);
                if (pkg.engineering.actualProgress < planEng - 10) {
                    const delay = Math.round(planEng - pkg.engineering.actualProgress);
                    generatedRisks.push({
                        id: Date.now() + Math.random(),
                        projectId: selectedProject,
                        packageId: pkg.id,
                        category: 'Schedule',
                        riskDescription: `Engineering behind schedule by ${delay}% for ${pkg.packageName}`,
                        probability: delay > 15 ? 'High' : 'Medium',
                        impact: 'Medium',
                        riskLevel: delay > 15 ? 'Critical' : 'Medium',
                        status: 'Open',
                        mitigation: 'Add engineering resources, prioritize critical path items',
                        owner: 'Engineering Manager',
                        dueDate: pkg.engineering.planFinish || '',
                        isAutoGenerated: true,
                        generatedDate: today.toISOString()
                    });
                }
            }
            
            // Check milestone delays
            const milestoneKeys = ['issueRFQ', 'receiveQuotation', 'issueTBE', 'issueCBE', 'finalNegotiation'];
            milestoneKeys.forEach(key => {
                const ms = pkg.milestones[key];
                if (ms && ms.plan && !ms.actual) {
                    const planDate = new Date(ms.plan);
                    if (today > planDate) {
                        const daysLate = Math.ceil((today - planDate) / 86400000);
                        if (daysLate > 7) {
                            generatedRisks.push({
                                id: Date.now() + Math.random(),
                                projectId: selectedProject,
                                packageId: pkg.id,
                                category: 'Schedule',
                                riskDescription: `${milestoneLabels.find(m => m.key === key)?.label || key} delayed by ${daysLate} days for ${pkg.packageName}`,
                                probability: daysLate > 30 ? 'High' : 'Medium',
                                impact: 'Medium',
                                riskLevel: daysLate > 30 ? 'Critical' : 'Medium',
                                status: 'Open',
                                mitigation: 'Fast-track milestone completion, identify blockers',
                                owner: 'Procurement Manager',
                                dueDate: ms.plan,
                                isAutoGenerated: true,
                                generatedDate: today.toISOString()
                            });
                        }
                    }
                }
            });
            
            // 2. COMMERCIAL RISKS
            
            // No vendor assigned
            if (!pkg.vendorName && pkg.milestones.issuePO.actual) {
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: pkg.id,
                    category: 'Commercial',
                    riskDescription: `No vendor name recorded for ${pkg.packageName} despite PO issued`,
                    probability: 'Low',
                    impact: 'Low',
                    riskLevel: 'Low',
                    status: 'Open',
                    mitigation: 'Update vendor information in system',
                    owner: 'Procurement Manager',
                    dueDate: '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // Contract not assigned but PO issued
            if (!pkg.contractNo && pkg.milestones.issuePO.actual) {
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: pkg.id,
                    category: 'Commercial',
                    riskDescription: `Contract/PO number not recorded for ${pkg.packageName}`,
                    probability: 'Low',
                    impact: 'Low',
                    riskLevel: 'Low',
                    status: 'Open',
                    mitigation: 'Update contract information in system',
                    owner: 'Procurement Manager',
                    dueDate: '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // 3. TECHNICAL RISKS
            
            // FAT failed or pending
            if (pkg.manufacture.actualFAT && pkg.manufacture.fatResult === 'Failed') {
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: pkg.id,
                    category: 'Technical',
                    riskDescription: `FAT failed for ${pkg.packageName} - requires re-test`,
                    probability: 'High',
                    impact: 'High',
                    riskLevel: 'Critical',
                    status: 'Open',
                    mitigation: 'Address FAT failures, schedule re-test, review punch list',
                    owner: 'QA/QC Manager',
                    dueDate: '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // FAT approaching but manufacture not complete
            if (pkg.manufacture.planFAT && pkg.manufacture.actualProgress < 90) {
                const fatDate = new Date(pkg.manufacture.planFAT);
                const daysToFAT = Math.ceil((fatDate - today) / 86400000);
                if (daysToFAT <= 30 && daysToFAT > 0) {
                    generatedRisks.push({
                        id: Date.now() + Math.random(),
                        projectId: selectedProject,
                        packageId: pkg.id,
                        category: 'Technical',
                        riskDescription: `FAT in ${daysToFAT} days but manufacture only ${pkg.manufacture.actualProgress}% for ${pkg.packageName}`,
                        probability: 'High',
                        impact: 'Medium',
                        riskLevel: 'Critical',
                        status: 'Open',
                        mitigation: 'Expedite manufacturing, consider FAT reschedule',
                        owner: 'Project Manager',
                        dueDate: pkg.manufacture.planFAT,
                        isAutoGenerated: true,
                        generatedDate: today.toISOString()
                    });
                }
            }
            
            // 4. LOGISTICS RISKS
            
            // Delivery approaching but shipping not started
            if (pkg.delivery.planDelivery100) {
                const deliveryDate = new Date(pkg.delivery.planDelivery100);
                const daysToDelivery = Math.ceil((deliveryDate - today) / 86400000);
                const shippingStatus = pkg.delivery.shippingStatus || 0;
                
                if (daysToDelivery <= 60 && daysToDelivery > 0 && shippingStatus < 50 && pkg.manufacture.actualProgress >= 80) {
                    generatedRisks.push({
                        id: Date.now() + Math.random(),
                        projectId: selectedProject,
                        packageId: pkg.id,
                        category: 'Logistics',
                        riskDescription: `Delivery in ${daysToDelivery} days but shipping only ${shippingStatus}% for ${pkg.packageName}`,
                        probability: daysToDelivery <= 30 ? 'High' : 'Medium',
                        impact: 'High',
                        riskLevel: daysToDelivery <= 30 ? 'Critical' : 'Medium',
                        status: 'Open',
                        mitigation: 'Expedite shipping arrangements, consider faster transport mode',
                        owner: 'Logistics Manager',
                        dueDate: pkg.delivery.planDelivery100,
                        isAutoGenerated: true,
                        generatedDate: today.toISOString()
                    });
                }
            }
            
            // International shipping (non-Indonesia COO)
            if (pkg.coo && pkg.coo !== 'Indonesia' && pkg.milestones.issuePO.actual) {
                const hasShippingRisk = !generatedRisks.some(r => r.category === 'Logistics' && r.packageId === pkg.id);
                if (hasShippingRisk && pkg.delivery.shippingStatus < 100) {
                    generatedRisks.push({
                        id: Date.now() + Math.random(),
                        projectId: selectedProject,
                        packageId: pkg.id,
                        category: 'Logistics',
                        riskDescription: `International shipping required from ${pkg.coo} for ${pkg.packageName}`,
                        probability: 'Medium',
                        impact: 'Medium',
                        riskLevel: 'Medium',
                        status: 'Monitoring',
                        mitigation: 'Monitor shipping schedule, prepare customs documentation',
                        owner: 'Logistics Manager',
                        dueDate: pkg.delivery.planDelivery100 || '',
                        isAutoGenerated: true,
                        generatedDate: today.toISOString()
                    });
                }
            }
            
            return generatedRisks;
        }
        
        function analyzeProjectLevelRisks(pkgs, today) {
            const generatedRisks = [];
            
            // Calculate overall project metrics
            const totalPackages = pkgs.length;
            const poIssuedCount = pkgs.filter(p => p.milestones.issuePO.actual).length;
            const avgMfgProgress = pkgs.reduce((a, p) => a + (p.manufacture.actualProgress || 0), 0) / totalPackages;
            const criticalPackages = pkgs.filter(p => {
                const planMfg = calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish);
                return p.manufacture.actualProgress < planMfg - 15;
            });
            
            // Project-level schedule risk
            if (criticalPackages.length >= totalPackages * 0.3) {
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: null,
                    category: 'Schedule',
                    riskDescription: `${criticalPackages.length} of ${totalPackages} packages (${Math.round(criticalPackages.length/totalPackages*100)}%) are behind schedule`,
                    probability: 'High',
                    impact: 'High',
                    riskLevel: 'Critical',
                    status: 'Open',
                    mitigation: 'Conduct schedule recovery workshop, prioritize critical path',
                    owner: 'Project Manager',
                    dueDate: '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // PO issuance progress
            if (poIssuedCount < totalPackages * 0.5) {
                generatedRisks.push({
                    id: Date.now() + Math.random(),
                    projectId: selectedProject,
                    packageId: null,
                    category: 'Commercial',
                    riskDescription: `Only ${poIssuedCount} of ${totalPackages} packages (${Math.round(poIssuedCount/totalPackages*100)}%) have PO issued`,
                    probability: 'Medium',
                    impact: 'High',
                    riskLevel: 'Medium',
                    status: 'Open',
                    mitigation: 'Accelerate procurement process, review bidding status',
                    owner: 'Procurement Manager',
                    dueDate: '',
                    isAutoGenerated: true,
                    generatedDate: today.toISOString()
                });
            }
            
            // Multiple vendors from same country concentration risk
            const cooCount = {};
            pkgs.forEach(p => {
                if (p.coo) {
                    cooCount[p.coo] = (cooCount[p.coo] || 0) + 1;
                }
            });
            Object.keys(cooCount).forEach(coo => {
                if (coo !== 'Indonesia' && cooCount[coo] >= 3) {
                    generatedRisks.push({
                        id: Date.now() + Math.random(),
                        projectId: selectedProject,
                        packageId: null,
                        category: 'Logistics',
                        riskDescription: `${cooCount[coo]} packages sourced from ${coo} - geographic concentration risk`,
                        probability: 'Low',
                        impact: 'Medium',
                        riskLevel: 'Low',
                        status: 'Monitoring',
                        mitigation: 'Monitor geopolitical situation, prepare contingency suppliers',
                        owner: 'Procurement Manager',
                        dueDate: '',
                        isAutoGenerated: true,
                        generatedDate: today.toISOString()
                    });
                }
            });
            
            return generatedRisks;
        }

        function initCharts() {
            charts.discipline = new Chart(document.getElementById('disciplineChart'), {type:'bar',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'},grid:{color:'#334155'}},y:{ticks:{color:'#94a3b8'},grid:{color:'#334155'}}}}});
            charts.scurve = new Chart(document.getElementById('scurveChart'), {
                type:'line',
                data:{labels:[],datasets:[]},
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins:{
                        legend:{labels:{color:'#94a3b8'}},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales:{
                        x:{ticks:{color:'#94a3b8', maxRotation: 45, minRotation: 45},grid:{color:'#334155'}},
                        y:{ticks:{color:'#94a3b8', callback: function(value) { return value + '%'; }},grid:{color:'#334155'},min:0,max:100}
                    }
                }
            });
            charts.riskPie = new Chart(document.getElementById('riskPieChart'), {type:'doughnut',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}}}});
            updateCharts();
        }

        // Normal Distribution CDF for S-Curve calculation
        function normalCDF(x, mean, stdDev) {
            const z = (x - mean) / stdDev;
            const t = 1 / (1 + 0.2316419 * Math.abs(z));
            const d = 0.3989422804 * Math.exp(-z * z / 2);
            const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            return z > 0 ? 1 - p : p;
        }

        // Calculate S-Curve value using normal distribution
        function calcSCurveNormal(startDate, endDate, currentDate, earlyBias = 0.15) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate).getTime();
            const end = new Date(endDate).getTime();
            const current = new Date(currentDate).getTime();
            
            if (current <= start) return 0;
            if (current >= end) return 100;
            
            const totalDuration = end - start;
            const elapsed = current - start;
            const progress = elapsed / totalDuration;
            
            // Use normal CDF with mean at 0.5 and stdDev for S-curve shape
            // earlyBias shifts the curve to start earlier
            const mean = 0.5 - earlyBias;
            const stdDev = 0.2;
            const rawValue = normalCDF(progress, mean, stdDev);
            
            // Scale to 0-100
            const minVal = normalCDF(0, mean, stdDev);
            const maxVal = normalCDF(1, mean, stdDev);
            return ((rawValue - minVal) / (maxVal - minVal)) * 100;
        }

        // Calculate weighted progress for a package at a specific date
        function calcPackageProgressAtDate(pkg, date, wf) {
            let progress = 0;
            const currentDate = new Date(date);
            
            // Determine effective weights based on package configuration
            // If engineering is not required, redistribute its weight to manufacture
            const engineeringRequired = pkg.engineering.required && pkg.engineering.planStart && pkg.engineering.planFinish;
            const effectiveEngWeight = engineeringRequired ? wf.engineering : 0;
            const effectiveMfgWeight = engineeringRequired ? wf.manufacture : (wf.manufacture + wf.engineering);
            
            // Calculate milestone progress based on plan dates
            const milestoneKeys = ['issueRFQ', 'receiveQuotation', 'issueTBE', 'issueCBE', 'finalNegotiation', 'issuePO', 'kom'];
            let milestonesCompleted = 0;
            let milestoneWeight = 0;
            milestoneKeys.forEach(key => {
                milestoneWeight += wf.milestones[key] || 0;
                const ms = pkg.milestones[key];
                if (ms && ms.plan) {
                    const planDate = new Date(ms.plan);
                    if (currentDate >= planDate) {
                        progress += wf.milestones[key] || 0;
                        milestonesCompleted++;
                    }
                }
            });
            
            // Calculate engineering progress (S-curve within engineering period)
            if (engineeringRequired) {
                const engProgress = calcSCurveNormal(pkg.engineering.planStart, pkg.engineering.planFinish, date, 0.1);
                progress += (engProgress / 100) * effectiveEngWeight;
            }
            
            // Calculate manufacture progress (S-curve within manufacture period)
            if (pkg.manufacture.planStart && pkg.manufacture.planFinish) {
                const mfgProgress = calcSCurveNormal(pkg.manufacture.planStart, pkg.manufacture.planFinish, date, 0.1);
                progress += (mfgProgress / 100) * effectiveMfgWeight;
            }
            
            // Calculate FAT progress
            const fatWeight = wf.fat || 0;
            if (fatWeight > 0) {
                if (pkg.manufacture.planFAT) {
                    const fatDate = new Date(pkg.manufacture.planFAT);
                    if (currentDate >= fatDate) {
                        progress += fatWeight;
                    }
                } else if (pkg.manufacture.planFinish) {
                    // If no FAT date, assume FAT is at manufacture finish
                    const mfgFinishDate = new Date(pkg.manufacture.planFinish);
                    if (currentDate >= mfgFinishDate) {
                        progress += fatWeight;
                    }
                }
            }
            
            // Calculate shipping progress using S-curve
            const shippingWeight = wf.delivery.shipping || 0;
            if (shippingWeight > 0) {
                const planDelivery100 = pkg.delivery.planDelivery100 || pkg.delivery.planDate;
                const shippingStartDate = pkg.manufacture.planFAT || pkg.manufacture.planFinish;
                if (shippingStartDate && planDelivery100) {
                    const shippingProgress = calcSCurveNormal(shippingStartDate, planDelivery100, date, 0.1);
                    progress += (shippingProgress / 100) * shippingWeight;
                } else if (shippingStartDate) {
                    // If no delivery date, assume shipping completes 30 days after FAT/manufacture
                    const estimatedDelivery = new Date(shippingStartDate);
                    estimatedDelivery.setDate(estimatedDelivery.getDate() + 30);
                    const shippingProgress = calcSCurveNormal(shippingStartDate, estimatedDelivery.toISOString(), date, 0.1);
                    progress += (shippingProgress / 100) * shippingWeight;
                }
            }
            
            // Calculate material at site using S-curve
            const materialWeight = wf.delivery.materialAtSite || 0;
            if (materialWeight > 0) {
                const planDelivery100 = pkg.delivery.planDelivery100 || pkg.delivery.planDate;
                const planMaterialAtSite100 = pkg.delivery.planMaterialAtSite100 || pkg.delivery.requiredAtSite;
                
                if (planMaterialAtSite100) {
                    const startDate = planDelivery100 || pkg.manufacture.planFinish;
                    if (startDate) {
                        const materialProgress = calcSCurveNormal(startDate, planMaterialAtSite100, date, 0.1);
                        progress += (materialProgress / 100) * materialWeight;
                    } else {
                        // If no start date, check if current date is past material at site date
                        const materialDate = new Date(planMaterialAtSite100);
                        if (currentDate >= materialDate) {
                            progress += materialWeight;
                        }
                    }
                } else if (planDelivery100) {
                    // If no material at site date, assume it's same as delivery
                    const deliveryDate = new Date(planDelivery100);
                    if (currentDate >= deliveryDate) {
                        progress += materialWeight;
                    }
                }
            }
            
            return progress;
        }

        // Calculate actual weighted progress for a package
        function calcPackageActualProgress(pkg, wf) {
            let progress = 0;
            
            // Determine effective weights based on package configuration
            // If engineering is not required, redistribute its weight to manufacture
            const engineeringRequired = pkg.engineering.required;
            const effectiveEngWeight = engineeringRequired ? wf.engineering : 0;
            const effectiveMfgWeight = engineeringRequired ? wf.manufacture : (wf.manufacture + wf.engineering);
            
            // Calculate milestone actual progress
            const milestoneKeys = ['issueRFQ', 'receiveQuotation', 'issueTBE', 'issueCBE', 'finalNegotiation', 'issuePO', 'kom'];
            milestoneKeys.forEach(key => {
                const ms = pkg.milestones[key];
                if (ms && ms.actual) {
                    progress += wf.milestones[key] || 0;
                }
            });
            
            // Engineering actual progress
            if (engineeringRequired) {
                progress += ((pkg.engineering.actualProgress || 0) / 100) * effectiveEngWeight;
            }
            
            // Manufacture actual progress
            progress += ((pkg.manufacture.actualProgress || 0) / 100) * effectiveMfgWeight;
            
            // FAT actual progress (100% if actualFAT exists and result is Passed/Passed with Remarks)
            if (pkg.manufacture.actualFAT && (pkg.manufacture.fatResult === 'Passed' || pkg.manufacture.fatResult === 'Passed with Remarks')) {
                progress += wf.fat || 0;
            }
            
            // Shipping status actual
            const shippingActual = pkg.delivery.shippingStatus || 0;
            progress += (shippingActual / 100) * wf.delivery.shipping;
            
            // Material at site actual
            const materialActual = pkg.delivery.materialReceivedActual || 0;
            progress += (materialActual / 100) * wf.delivery.materialAtSite;
            
            return progress;
        }

        // Calculate actual weighted progress for a package at a specific date using S-Curve
        // This function uses actual dates to generate S-Curve for actual progress
        function calcPackageActualProgressAtDate(pkg, date, wf) {
            let progress = 0;
            const currentDate = new Date(date);
            
            // Determine effective weights based on package configuration
            const engineeringRequired = pkg.engineering.required && pkg.engineering.actualStart;
            const effectiveEngWeight = engineeringRequired ? wf.engineering : 0;
            const effectiveMfgWeight = engineeringRequired ? wf.manufacture : (wf.manufacture + wf.engineering);
            
            // Calculate milestone actual progress based on actual dates
            const milestoneKeys = ['issueRFQ', 'receiveQuotation', 'issueTBE', 'issueCBE', 'finalNegotiation', 'issuePO', 'kom'];
            milestoneKeys.forEach(key => {
                const ms = pkg.milestones[key];
                if (ms && ms.actual) {
                    const actualDate = new Date(ms.actual);
                    if (currentDate >= actualDate) {
                        progress += wf.milestones[key] || 0;
                    }
                }
            });
            
            // Calculate engineering actual progress using S-Curve based on actual dates
            if (engineeringRequired && pkg.engineering.actualStart) {
                // Use actual finish if available, otherwise estimate based on progress
                let engEndDate = pkg.engineering.actualFinish;
                if (!engEndDate && pkg.engineering.actualProgress > 0 && pkg.engineering.actualProgress < 100) {
                    // Estimate finish date based on current progress and elapsed time
                    const elapsed = currentDate - new Date(pkg.engineering.actualStart);
                    const estimatedTotal = elapsed / (pkg.engineering.actualProgress / 100);
                    const estimatedEnd = new Date(new Date(pkg.engineering.actualStart).getTime() + estimatedTotal);
                    engEndDate = estimatedEnd.toISOString();
                } else if (!engEndDate && pkg.engineering.actualProgress >= 100) {
                    // If 100% but no finish date, use current date
                    engEndDate = currentDate.toISOString();
                } else if (!engEndDate) {
                    // Fallback to plan finish
                    engEndDate = pkg.engineering.planFinish;
                }
                
                if (engEndDate) {
                    const engProgress = calcSCurveNormal(pkg.engineering.actualStart, engEndDate, date, 0.1);
                    // Cap at actual progress input
                    const cappedProgress = Math.min(engProgress, pkg.engineering.actualProgress || 0);
                    progress += (cappedProgress / 100) * effectiveEngWeight;
                }
            }
            
            // Calculate manufacture actual progress using S-Curve based on actual dates
            if (pkg.manufacture.actualStart) {
                let mfgEndDate = pkg.manufacture.actualFinish;
                if (!mfgEndDate && pkg.manufacture.actualProgress > 0 && pkg.manufacture.actualProgress < 100) {
                    // Estimate finish date based on current progress
                    const elapsed = currentDate - new Date(pkg.manufacture.actualStart);
                    if (pkg.manufacture.actualProgress > 0) {
                        const estimatedTotal = elapsed / (pkg.manufacture.actualProgress / 100);
                        const estimatedEnd = new Date(new Date(pkg.manufacture.actualStart).getTime() + estimatedTotal);
                        mfgEndDate = estimatedEnd.toISOString();
                    }
                } else if (!mfgEndDate && pkg.manufacture.actualProgress >= 100) {
                    mfgEndDate = currentDate.toISOString();
                } else if (!mfgEndDate) {
                    mfgEndDate = pkg.manufacture.planFinish;
                }
                
                if (mfgEndDate) {
                    const mfgProgress = calcSCurveNormal(pkg.manufacture.actualStart, mfgEndDate, date, 0.1);
                    // Cap at actual progress input
                    const cappedProgress = Math.min(mfgProgress, pkg.manufacture.actualProgress || 0);
                    progress += (cappedProgress / 100) * effectiveMfgWeight;
                }
            }
            
            // Calculate FAT actual progress
            const fatWeight = wf.fat || 0;
            if (fatWeight > 0 && pkg.manufacture.actualFAT) {
                const fatDate = new Date(pkg.manufacture.actualFAT);
                if (currentDate >= fatDate && (pkg.manufacture.fatResult === 'Passed' || pkg.manufacture.fatResult === 'Passed with Remarks')) {
                    progress += fatWeight;
                }
            }
            
            // Calculate shipping actual progress using S-Curve
            const shippingWeight = wf.delivery.shipping || 0;
            if (shippingWeight > 0) {
                const actualDelivery100 = pkg.delivery.actualDelivery100;
                const shippingStartDate = pkg.manufacture.actualFAT || pkg.manufacture.actualFinish;
                
                if (shippingStartDate && actualDelivery100) {
                    // Have both start and end dates - calculate S-Curve
                    const shippingProgress = calcSCurveNormal(shippingStartDate, actualDelivery100, date, 0.1);
                    // Cap at actual shipping status
                    const cappedProgress = Math.min(shippingProgress, pkg.delivery.shippingStatus || 0);
                    progress += (cappedProgress / 100) * shippingWeight;
                } else if (shippingStartDate && pkg.delivery.shippingStatus > 0) {
                    // No end date yet, but have progress - estimate
                    const shippingActual = pkg.delivery.shippingStatus || 0;
                    if (shippingActual >= 100) {
                        progress += shippingWeight;
                    } else if (shippingActual > 0) {
                        // Estimate based on progress
                        const elapsed = currentDate - new Date(shippingStartDate);
                        if (elapsed > 0 && shippingActual > 0) {
                            const estimatedTotal = elapsed / (shippingActual / 100);
                            const estimatedEnd = new Date(new Date(shippingStartDate).getTime() + estimatedTotal);
                            const shippingProgress = calcSCurveNormal(shippingStartDate, estimatedEnd.toISOString(), date, 0.1);
                            const cappedProgress = Math.min(shippingProgress, shippingActual);
                            progress += (cappedProgress / 100) * shippingWeight;
                        }
                    }
                }
            }
            
            // Calculate material at site actual progress using S-Curve
            const materialWeight = wf.delivery.materialAtSite || 0;
            if (materialWeight > 0) {
                const actualMaterialAtSite100 = pkg.delivery.actualMaterialAtSite100;
                const materialStartDate = pkg.delivery.actualDelivery100 || pkg.manufacture.actualFAT || pkg.manufacture.actualFinish;
                
                if (materialStartDate && actualMaterialAtSite100) {
                    // Have both dates - calculate S-Curve
                    const materialProgress = calcSCurveNormal(materialStartDate, actualMaterialAtSite100, date, 0.1);
                    const cappedProgress = Math.min(materialProgress, pkg.delivery.materialReceivedActual || 0);
                    progress += (cappedProgress / 100) * materialWeight;
                } else if (materialStartDate && pkg.delivery.materialReceivedActual > 0) {
                    const materialActual = pkg.delivery.materialReceivedActual || 0;
                    if (materialActual >= 100) {
                        progress += materialWeight;
                    } else if (materialActual > 0) {
                        // Estimate
                        const elapsed = currentDate - new Date(materialStartDate);
                        if (elapsed > 0 && materialActual > 0) {
                            const estimatedTotal = elapsed / (materialActual / 100);
                            const estimatedEnd = new Date(new Date(materialStartDate).getTime() + estimatedTotal);
                            const materialProgress = calcSCurveNormal(materialStartDate, estimatedEnd.toISOString(), date, 0.1);
                            const cappedProgress = Math.min(materialProgress, materialActual);
                            progress += (cappedProgress / 100) * materialWeight;
                        }
                    }
                }
            }
            
            return progress;
        }

        function updateCharts() {
            const pkgs = getProjectPackages(), disc = ['Process','Mechanical','Piping','Electrical','Instrument','Civil'];
            charts.discipline.data = {labels:disc,datasets:[{label:'Engineering',data:disc.map(d=>{const dp=pkgs.filter(p=>p.discipline===d);return dp.length?Math.round(dp.reduce((a,p)=>a+(p.engineering.actualProgress||0),0)/dp.length):0;}),backgroundColor:'#22d3ee',borderRadius:4},{label:'Manufacture',data:disc.map(d=>{const dp=pkgs.filter(p=>p.discipline===d);return dp.length?Math.round(dp.reduce((a,p)=>a+(p.manufacture.actualProgress||0),0)/dp.length):0;}),backgroundColor:'#14b8a6',borderRadius:4}]};
            charts.discipline.update();
            
            const proj = projects.find(p=>p.id===selectedProject);
            if(proj && pkgs.length > 0) {
                const labels = [], planData = [], actualData = [];
                
                // Get cut-off date from input, default to today
                const cutoffInput = document.getElementById('scurveCutoffDate');
                const cutoffDate = cutoffInput && cutoffInput.value ? new Date(cutoffInput.value) : new Date();
                // Set to end of day for comparison
                cutoffDate.setHours(23, 59, 59, 999);
                
                // === DYNAMIC S-CURVE: Calculate date range from package plan data ===
                // Find earliest plan start date (from milestones, engineering, or manufacture)
                // Find latest plan material at site date (100% completion point)
                let earliestDate = null;
                let latestMaterialAtSite = null;
                let earliestActualDate = null;
                
                pkgs.forEach(pkg => {
                    // Check all milestone plan dates for earliest date
                    const milestoneKeys = ['issueRFQ', 'receiveQuotation', 'issueTBE', 'issueCBE', 'finalNegotiation', 'issuePO', 'kom'];
                    milestoneKeys.forEach(key => {
                        const ms = pkg.milestones[key];
                        if (ms && ms.plan) {
                            const d = new Date(ms.plan);
                            if (!earliestDate || d < earliestDate) earliestDate = d;
                        }
                        // Also check actual dates
                        if (ms && ms.actual) {
                            const d = new Date(ms.actual);
                            if (!earliestActualDate || d < earliestActualDate) earliestActualDate = d;
                        }
                    });
                    
                    // Check engineering plan start
                    if (pkg.engineering.required && pkg.engineering.planStart) {
                        const d = new Date(pkg.engineering.planStart);
                        if (!earliestDate || d < earliestDate) earliestDate = d;
                    }
                    // Check engineering actual start
                    if (pkg.engineering.actualStart) {
                        const d = new Date(pkg.engineering.actualStart);
                        if (!earliestActualDate || d < earliestActualDate) earliestActualDate = d;
                    }
                    
                    // Check manufacture plan start
                    if (pkg.manufacture.planStart) {
                        const d = new Date(pkg.manufacture.planStart);
                        if (!earliestDate || d < earliestDate) earliestDate = d;
                    }
                    // Check manufacture actual start
                    if (pkg.manufacture.actualStart) {
                        const d = new Date(pkg.manufacture.actualStart);
                        if (!earliestActualDate || d < earliestActualDate) earliestActualDate = d;
                    }
                    
                    // Find latest material at site date (this is when plan reaches 100%)
                    const materialAtSiteDate = pkg.delivery.planMaterialAtSite100 || pkg.delivery.requiredAtSite || pkg.delivery.planDelivery100 || pkg.delivery.planDate;
                    if (materialAtSiteDate) {
                        const d = new Date(materialAtSiteDate);
                        if (!latestMaterialAtSite || d > latestMaterialAtSite) latestMaterialAtSite = d;
                    }
                });
                
                // Use earliest of plan or actual start date
                const start = earliestActualDate && earliestActualDate < earliestDate ? earliestActualDate : (earliestDate || new Date(proj.startDate));
                const end = latestMaterialAtSite || new Date(proj.finishDate);
                
                // Ensure end date is after start date
                if (end <= start) {
                    end.setTime(start.getTime() + 365 * 24 * 60 * 60 * 1000); // Add 1 year if invalid
                }
                
                const total = Math.ceil((end - start) / 86400000);
                const numPoints = Math.min(20, Math.max(10, Math.ceil(total / 30))); // Dynamic points based on duration
                const step = Math.max(1, Math.floor(total / numPoints));
                
                for (let i = 0; i <= total; i += step) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + i);
                    
                    // Format label with year
                    const month = d.toLocaleDateString('id-ID', {month:'short'});
                    const year = d.getFullYear().toString().slice(-2);
                    labels.push(`${month} '${year}`);
                    
                    // Calculate weighted plan progress for all packages at this date
                    let totalPlanProgress = 0;
                    pkgs.forEach(pkg => {
                        totalPlanProgress += calcPackageProgressAtDate(pkg, d.toISOString(), weightFactors);
                    });
                    planData.push(totalPlanProgress / pkgs.length);
                    
                    // Calculate actual progress using S-Curve up to cut-off date
                    if (d <= cutoffDate) {
                        let totalActualProgress = 0;
                        pkgs.forEach(pkg => {
                            // Use the new S-Curve based actual calculation
                            totalActualProgress += calcPackageActualProgressAtDate(pkg, d.toISOString(), weightFactors);
                        });
                        actualData.push(totalActualProgress / pkgs.length);
                    } else {
                        actualData.push(null); // No actual data for future dates
                    }
                }
                
                // Ensure the final point reaches 100% at the last material at site date
                // Add final point at exact end date if not already included
                const lastDataPoint = planData[planData.length - 1];
                if (lastDataPoint < 99.5) {
                    // Calculate progress at exact end date
                    const endMonth = end.toLocaleDateString('id-ID', {month:'short'});
                    const endYear = end.getFullYear().toString().slice(-2);
                    
                    // Only add if it's a different point from the last one
                    const lastLabel = labels[labels.length - 1];
                    const endLabel = `${endMonth} '${endYear}`;
                    
                    if (lastLabel !== endLabel) {
                        labels.push(endLabel);
                        
                        // At the end date, plan should be 100%
                        let endPlanProgress = 0;
                        pkgs.forEach(pkg => {
                            endPlanProgress += calcPackageProgressAtDate(pkg, end.toISOString(), weightFactors);
                        });
                        planData.push(endPlanProgress / pkgs.length);
                        
                        // Actual at end date using S-Curve
                        if (end <= cutoffDate) {
                            let endActualProgress = 0;
                            pkgs.forEach(pkg => {
                                endActualProgress += calcPackageActualProgressAtDate(pkg, end.toISOString(), weightFactors);
                            });
                            actualData.push(endActualProgress / pkgs.length);
                        } else {
                            actualData.push(null);
                        }
                    }
                }
                
                // Calculate current actual progress at cut-off date for display
                let currentActualAtCutoff = 0;
                let currentPlanAtCutoff = 0;
                pkgs.forEach(pkg => {
                    currentActualAtCutoff += calcPackageActualProgressAtDate(pkg, cutoffDate.toISOString(), weightFactors);
                    currentPlanAtCutoff += calcPackageProgressAtDate(pkg, cutoffDate.toISOString(), weightFactors);
                });
                currentActualAtCutoff = currentActualAtCutoff / pkgs.length;
                currentPlanAtCutoff = currentPlanAtCutoff / pkgs.length;
                const variance = currentActualAtCutoff - currentPlanAtCutoff;
                
                charts.scurve.data = {
                    labels,
                    datasets: [
                        {
                            label: 'Plan',
                            data: planData,
                            borderColor: '#14b8a6',
                            backgroundColor: 'rgba(20,184,166,0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Actual',
                            data: actualData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 2,
                            spanGaps: false
                        }
                    ]
                };
                charts.scurve.update();
                
                // Update date range info display with cut-off date and variance
                const dateRangeEl = document.getElementById('scurveDateRange');
                if (dateRangeEl) {
                    const startStr = start.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
                    const endStr = end.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
                    const cutoffStr = cutoffDate.toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
                    const varianceColor = variance >= 0 ? '#34d399' : '#f87171';
                    const varianceSign = variance >= 0 ? '+' : '';
                    dateRangeEl.innerHTML = ` Period: ${startStr}  ${endStr} |  Cut-off: ${cutoffStr} | <span style="color:${varianceColor}">Variance: ${varianceSign}${variance.toFixed(1)}%</span> (Plan: ${currentPlanAtCutoff.toFixed(1)}% / Actual: ${currentActualAtCutoff.toFixed(1)}%)`;
                }
            }
            
            const r=getProjectRisks(),cats=['Schedule','Technical','Commercial','Logistics','HSE'],catData=cats.map(c=>r.filter(x=>x.category===c).length).filter(v=>v>0),catLabels=cats.filter(c=>r.filter(x=>x.category===c).length>0);
            charts.riskPie.data={labels:catLabels,datasets:[{data:catData,backgroundColor:['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981']}]};charts.riskPie.update();
        }

        // ===== CUT-OFF DATE FUNCTIONS =====
        
        // Initialize cut-off date to today on load
        function initCutoffDate() {
            const cutoffInput = document.getElementById('scurveCutoffDate');
            if (cutoffInput) {
                const today = new Date();
                cutoffInput.value = today.toISOString().split('T')[0];
            }
        }
        
        // Handle cut-off date change
        function onCutoffDateChange() {
            if (charts.scurve) {
                updateCharts();
            }
        }
        
        // Set today as cut-off date
        function setTodayAsCutoff() {
            const cutoffInput = document.getElementById('scurveCutoffDate');
            if (cutoffInput) {
                const today = new Date();
                cutoffInput.value = today.toISOString().split('T')[0];
                onCutoffDateChange();
            }
        }

        // ===== WEIGHT FACTOR FUNCTIONS =====
        
        function openWeightFactorModal() {
            populateWeightFactorForm();
            document.getElementById('weightFactorModal').classList.add('active');
        }
        
        function closeWeightFactorModal() {
            document.getElementById('weightFactorModal').classList.remove('active');
        }
        
        function populateWeightFactorForm() {
            document.getElementById('wfIssueRFQ').value = weightFactors.milestones.issueRFQ;
            document.getElementById('wfReceiveQuotation').value = weightFactors.milestones.receiveQuotation;
            document.getElementById('wfIssueTBE').value = weightFactors.milestones.issueTBE;
            document.getElementById('wfIssueCBE').value = weightFactors.milestones.issueCBE;
            document.getElementById('wfFinalNegotiation').value = weightFactors.milestones.finalNegotiation;
            document.getElementById('wfIssuePO').value = weightFactors.milestones.issuePO;
            document.getElementById('wfKOM').value = weightFactors.milestones.kom;
            document.getElementById('wfEngineering').value = weightFactors.engineering;
            document.getElementById('wfManufacture').value = weightFactors.manufacture;
            document.getElementById('wfFAT').value = weightFactors.fat || 0;
            document.getElementById('wfShipping').value = weightFactors.delivery.shipping;
            document.getElementById('wfMaterialAtSite').value = weightFactors.delivery.materialAtSite;
            updateWFTotal();
        }
        
        function updateWFTotal() {
            const total = 
                parseFloat(document.getElementById('wfIssueRFQ').value || 0) +
                parseFloat(document.getElementById('wfReceiveQuotation').value || 0) +
                parseFloat(document.getElementById('wfIssueTBE').value || 0) +
                parseFloat(document.getElementById('wfIssueCBE').value || 0) +
                parseFloat(document.getElementById('wfFinalNegotiation').value || 0) +
                parseFloat(document.getElementById('wfIssuePO').value || 0) +
                parseFloat(document.getElementById('wfKOM').value || 0) +
                parseFloat(document.getElementById('wfEngineering').value || 0) +
                parseFloat(document.getElementById('wfManufacture').value || 0) +
                parseFloat(document.getElementById('wfFAT').value || 0) +
                parseFloat(document.getElementById('wfShipping').value || 0) +
                parseFloat(document.getElementById('wfMaterialAtSite').value || 0);
            
            const display = document.getElementById('wfTotalDisplay');
            display.textContent = total.toFixed(1) + '%';
            display.className = 'wf-total-value ' + (Math.abs(total - 100) < 0.1 ? 'valid' : 'invalid');
        }
        
        function saveWeightFactors() {
            const total = 
                parseFloat(document.getElementById('wfIssueRFQ').value || 0) +
                parseFloat(document.getElementById('wfReceiveQuotation').value || 0) +
                parseFloat(document.getElementById('wfIssueTBE').value || 0) +
                parseFloat(document.getElementById('wfIssueCBE').value || 0) +
                parseFloat(document.getElementById('wfFinalNegotiation').value || 0) +
                parseFloat(document.getElementById('wfIssuePO').value || 0) +
                parseFloat(document.getElementById('wfKOM').value || 0) +
                parseFloat(document.getElementById('wfEngineering').value || 0) +
                parseFloat(document.getElementById('wfManufacture').value || 0) +
                parseFloat(document.getElementById('wfFAT').value || 0) +
                parseFloat(document.getElementById('wfShipping').value || 0) +
                parseFloat(document.getElementById('wfMaterialAtSite').value || 0);
            
            if (Math.abs(total - 100) > 0.1) {
                showNotification('Total weight factor must equal 100%. Current: ' + total.toFixed(1) + '%', 'error');
                return;
            }
            
            weightFactors = {
                milestones: {
                    issueRFQ: parseFloat(document.getElementById('wfIssueRFQ').value || 0),
                    receiveQuotation: parseFloat(document.getElementById('wfReceiveQuotation').value || 0),
                    issueTBE: parseFloat(document.getElementById('wfIssueTBE').value || 0),
                    issueCBE: parseFloat(document.getElementById('wfIssueCBE').value || 0),
                    finalNegotiation: parseFloat(document.getElementById('wfFinalNegotiation').value || 0),
                    issuePO: parseFloat(document.getElementById('wfIssuePO').value || 0),
                    kom: parseFloat(document.getElementById('wfKOM').value || 0)
                },
                engineering: parseFloat(document.getElementById('wfEngineering').value || 0),
                manufacture: parseFloat(document.getElementById('wfManufacture').value || 0),
                fat: parseFloat(document.getElementById('wfFAT').value || 0),
                delivery: {
                    shipping: parseFloat(document.getElementById('wfShipping').value || 0),
                    materialAtSite: parseFloat(document.getElementById('wfMaterialAtSite').value || 0)
                }
            };
            
            saveAllData();
            updateCharts();
            closeWeightFactorModal();
            showNotification('Weight factors saved successfully', 'success');
        }
        
        function resetWeightFactors() {
            weightFactors = JSON.parse(JSON.stringify(defaultWeightFactors));
            populateWeightFactorForm();
            showNotification('Weight factors reset to defaults', 'info');
        }

        function switchTab(id) { currentTab=id; document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active')); document.querySelector('[data-tab="'+id+'"]').classList.add('active'); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function switchFormTab(id) { document.querySelectorAll('.form-tab').forEach(t=>t.classList.remove('active')); event.target.classList.add('active'); document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active')); document.getElementById(id+'Section').classList.add('active'); }
        function changeProject() { selectedProject = parseInt(document.getElementById('projectSelect').value); saveAllData(); renderAll(); }
        function filterPackages() { renderPackagesTable(); }
        function updateIncotermInfo() { const c=document.getElementById('incoterm').value,i=incoterms.find(x=>x.code===c),d=document.getElementById('incotermInfo');if(i){d.style.display='block';d.innerHTML='<div class="incoterm-header"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'+i.name+'</div><p class="incoterm-desc">'+i.desc+'</p><p class="incoterm-mode">Mode: '+(i.mode==='all'?'All transport':'Sea only')+'</p>';}else{d.style.display='none';}}
        
        // Calculate Delivery Plan Status using S-Curve (Normal Distribution)
        function calcDeliveryPlanStatus() {
            // Get manufacture finish date as shipping start reference
            const mfgFinish = document.getElementById('mfgPlanFinish').value;
            const planDelivery100 = document.getElementById('planDelivery100').value;
            const shippingStatusDate = document.getElementById('shippingStatusDate').value;
            const planMaterialAtSite100 = document.getElementById('planMaterialAtSite100').value;
            const materialStatusDate = document.getElementById('materialStatusDate').value;
            
            // Calculate Shipping Status Plan using S-Curve
            if (mfgFinish && planDelivery100 && shippingStatusDate) {
                const shippingPlan = calcSCurveNormal(mfgFinish, planDelivery100, shippingStatusDate, 0.1);
                const display1 = document.getElementById('shippingStatusPlanDisplay');
                display1.textContent = Math.round(shippingPlan) + '%';
                display1.style.background = shippingPlan >= 100 ? 'rgba(16,185,129,0.2)' : shippingPlan > 0 ? 'rgba(245,158,11,0.2)' : 'rgba(100,116,139,0.2)';
                display1.style.color = shippingPlan >= 100 ? '#34d399' : shippingPlan > 0 ? '#fbbf24' : '#94a3b8';
            } else {
                const display1 = document.getElementById('shippingStatusPlanDisplay');
                display1.textContent = '0%';
                display1.style.background = 'rgba(100,116,139,0.2)';
                display1.style.color = '#94a3b8';
            }
            
            // Calculate Material at Site Plan using S-Curve
            if (planDelivery100 && planMaterialAtSite100 && materialStatusDate) {
                const materialPlan = calcSCurveNormal(planDelivery100, planMaterialAtSite100, materialStatusDate, 0.1);
                const display2 = document.getElementById('materialAtSitePlanDisplay');
                display2.textContent = Math.round(materialPlan) + '%';
                display2.style.background = materialPlan >= 100 ? 'rgba(16,185,129,0.2)' : materialPlan > 0 ? 'rgba(245,158,11,0.2)' : 'rgba(100,116,139,0.2)';
                display2.style.color = materialPlan >= 100 ? '#34d399' : materialPlan > 0 ? '#fbbf24' : '#94a3b8';
            } else {
                const display2 = document.getElementById('materialAtSitePlanDisplay');
                display2.textContent = '0%';
                display2.style.background = 'rgba(100,116,139,0.2)';
                display2.style.color = '#94a3b8';
            }
        }
        
        // Calculate Engineering Plan Progress using S-Curve
        function calcEngineeringPlanProgress() {
            const planStart = document.getElementById('engPlanStart').value;
            const planFinish = document.getElementById('engPlanFinish').value;
            const statusDate = document.getElementById('engStatusDate').value;
            
            const display = document.getElementById('engPlanProgress');
            
            if (planStart && planFinish && statusDate) {
                const engPlan = calcSCurveNormal(planStart, planFinish, statusDate, 0.1);
                display.textContent = Math.round(engPlan) + '%';
                display.style.background = engPlan >= 100 ? 'rgba(16,185,129,0.2)' : engPlan > 50 ? 'rgba(59,130,246,0.2)' : engPlan > 0 ? 'rgba(245,158,11,0.2)' : 'rgba(100,116,139,0.2)';
                display.style.color = engPlan >= 100 ? '#34d399' : engPlan > 50 ? '#60a5fa' : engPlan > 0 ? '#fbbf24' : '#94a3b8';
            } else {
                display.textContent = '0%';
                display.style.background = 'rgba(100,116,139,0.2)';
                display.style.color = '#94a3b8';
            }
        }
        
        // Calculate Manufacture Plan Progress using S-Curve
        function calcManufacturePlanProgress() {
            const planStart = document.getElementById('mfgPlanStart').value;
            const planFinish = document.getElementById('mfgPlanFinish').value;
            const statusDate = document.getElementById('mfgStatusDate').value;
            
            const display = document.getElementById('mfgPlanProgress');
            
            if (planStart && planFinish && statusDate) {
                const mfgPlan = calcSCurveNormal(planStart, planFinish, statusDate, 0.1);
                display.textContent = Math.round(mfgPlan) + '%';
                display.style.background = mfgPlan >= 100 ? 'rgba(16,185,129,0.2)' : mfgPlan > 50 ? 'rgba(59,130,246,0.2)' : mfgPlan > 0 ? 'rgba(245,158,11,0.2)' : 'rgba(100,116,139,0.2)';
                display.style.color = mfgPlan >= 100 ? '#34d399' : mfgPlan > 50 ? '#60a5fa' : mfgPlan > 0 ? '#fbbf24' : '#94a3b8';
            } else {
                display.textContent = '0%';
                display.style.background = 'rgba(100,116,139,0.2)';
                display.style.color = '#94a3b8';
            }
        }
        
        function calcRiskLevel() { const p=document.getElementById('riskProbability').value,i=document.getElementById('riskImpact').value,lv=calcRiskLevelValue(p,i),d=document.getElementById('riskLevelDisplay');d.textContent=lv;d.style.background=lv==='Critical'?'rgba(239,68,68,0.2)':lv==='Medium'?'rgba(245,158,11,0.2)':'rgba(16,185,129,0.2)';d.style.color=lv==='Critical'?'#f87171':lv==='Medium'?'#fbbf24':'#34d399'; }
        function calcRiskLevelValue(p,i) { if((p==='High'&&i==='High')||(p==='High'&&i==='Medium')||(p==='Medium'&&i==='High'))return 'Critical';if((p==='Low'&&i==='Low')||(p==='Low'&&i==='Medium')||(p==='Medium'&&i==='Low'))return 'Low';return 'Medium'; }

        // Update FAT Status Display
        function updateFATStatus(planFAT, actualFAT, fatResult) {
            const display = document.getElementById('fatStatusDisplay');
            if (actualFAT && fatResult) {
                if (fatResult === 'Passed') {
                    display.textContent = 'Passed';
                    display.style.background = 'rgba(16,185,129,0.2)';
                    display.style.color = '#34d399';
                } else if (fatResult === 'Passed with Remarks') {
                    display.textContent = 'Passed*';
                    display.style.background = 'rgba(245,158,11,0.2)';
                    display.style.color = '#fbbf24';
                } else if (fatResult === 'Failed') {
                    display.textContent = 'Failed';
                    display.style.background = 'rgba(239,68,68,0.2)';
                    display.style.color = '#f87171';
                }
            } else if (planFAT) {
                const today = new Date();
                const planDate = new Date(planFAT);
                if (today > planDate) {
                    display.textContent = 'Overdue';
                    display.style.background = 'rgba(239,68,68,0.2)';
                    display.style.color = '#f87171';
                } else {
                    display.textContent = 'Scheduled';
                    display.style.background = 'rgba(59,130,246,0.2)';
                    display.style.color = '#60a5fa';
                }
            } else {
                display.textContent = 'Pending';
                display.style.background = 'rgba(100,116,139,0.2)';
                display.style.color = '#94a3b8';
            }
        }

        function openPackageModal(id=null) { 
            document.getElementById('packageModal').classList.add('active'); 
            document.getElementById('packageModalTitle').textContent=id?'Edit Package':'Add Package'; 
            if(id){
                const p=packages.find(x=>x.id===id);
                if(p)populatePackageForm(p);
            }else{
                document.getElementById('packageForm').reset();
                document.getElementById('packageId').value='';
                document.getElementById('engineeringFields').style.display='none';
                // Reset Engineering plan progress display
                document.getElementById('engPlanProgress').textContent = '0%';
                document.getElementById('engPlanProgress').style.background = 'rgba(100,116,139,0.2)';
                document.getElementById('engPlanProgress').style.color = '#94a3b8';
                // Reset Manufacture plan progress display
                document.getElementById('mfgPlanProgress').textContent = '0%';
                document.getElementById('mfgPlanProgress').style.background = 'rgba(100,116,139,0.2)';
                document.getElementById('mfgPlanProgress').style.color = '#94a3b8';
                // Reset delivery plan displays
                document.getElementById('shippingStatusPlanDisplay').textContent = '0%';
                document.getElementById('shippingStatusPlanDisplay').style.background = 'rgba(100,116,139,0.2)';
                document.getElementById('shippingStatusPlanDisplay').style.color = '#94a3b8';
                document.getElementById('materialAtSitePlanDisplay').textContent = '0%';
                document.getElementById('materialAtSitePlanDisplay').style.background = 'rgba(100,116,139,0.2)';
                document.getElementById('materialAtSitePlanDisplay').style.color = '#94a3b8';
                // Reset FAT status display
                document.getElementById('fatStatusDisplay').textContent = 'Pending';
                document.getElementById('fatStatusDisplay').style.background = 'rgba(100,116,139,0.2)';
                document.getElementById('fatStatusDisplay').style.color = '#94a3b8';
            } 
            switchFormTab('master');
            document.querySelectorAll('.form-tab')[0].classList.add('active'); 
        }
        function closePackageModal() { document.getElementById('packageModal').classList.remove('active'); }
        function openProjectModal(id=null) { document.getElementById('projectModal').classList.add('active'); document.getElementById('projectModalTitle').textContent=id?'Edit Project':'Add Project'; if(id){const p=projects.find(x=>x.id===id);if(p)populateProjectForm(p);}else{document.getElementById('projectForm').reset();document.getElementById('projectId').value='';} }
        function closeProjectModal() { document.getElementById('projectModal').classList.remove('active'); }
        function openRiskModal(id=null) { document.getElementById('riskModal').classList.add('active'); document.getElementById('riskModalTitle').textContent=id?'Edit Risk':'Add Risk'; if(id){const r=risks.find(x=>x.id===id);if(r)populateRiskForm(r);}else{document.getElementById('riskForm').reset();document.getElementById('riskId').value='';calcRiskLevel();} }

        // Package Detail View Functions
        let currentViewPackageId = null;
        
        function viewPackage(id) {
            const p = packages.find(x => x.id === id);
            if (!p) return;
            
            currentViewPackageId = id;
            const planMfg = calculateSCurve(p.manufacture.planStart, p.manufacture.planFinish);
            const planEng = calculateSCurve(p.engineering.planStart, p.engineering.planFinish);
            const mfgVariance = p.manufacture.actualProgress - planMfg;
            const engVariance = p.engineering.actualProgress - planEng;
            const mfgColor = mfgVariance >= 0 ? 'green' : mfgVariance > -10 ? 'yellow' : 'red';
            const engColor = engVariance >= 0 ? 'green' : engVariance > -10 ? 'yellow' : 'red';
            const incoterm = incoterms.find(i => i.code === p.delivery.incoterm);
            const proj = projects.find(pr => pr.id === p.projectId);
            
            const completedMilestones = milestoneLabels.filter(m => p.milestones[m.key].actual).length;
            const totalMilestones = milestoneLabels.length;
            
            let html = `
                <div class="detail-header">
                    <div class="detail-title-section">
                        <h2>${p.packageName}</h2>
                        <p>${p.description || 'No description'}</p>
                        <div class="detail-badges">
                            <span class="package-tag ${p.initiation === 'HO' ? 'ho' : 'site'}">${p.initiation}</span>
                            <span class="package-tag default">${p.discipline}</span>
                            <span class="package-tag default">${p.area}</span>
                            ${p.milestones.issuePO.actual ? '<span class="badge badge-success">PO Issued</span>' : '<span class="badge badge-warning">PO Pending</span>'}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#64748b;font-size:0.75rem;text-transform:uppercase;">Project</div>
                        <div style="color:white;font-weight:500;">${proj?.name || '-'}</div>
                    </div>
                </div>
                
                <!-- Master Data Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        Master Data
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item"><label>RFQ Number</label><span>${p.rfqNo || '-'}</span></div>
                        <div class="detail-item ${p.contractNo ? 'highlight' : ''}"><label>Contract/PO Number</label><span>${p.contractNo || '-'}</span></div>
                        <div class="detail-item"><label>Vendor Name</label><span>${p.vendorName || '-'}</span></div>
                        <div class="detail-item"><label>Country of Origin</label><span>${p.coo || '-'}</span></div>
                    </div>
                </div>
                
                <!-- Milestones Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                        Milestones Progress (${completedMilestones}/${totalMilestones})
                    </div>
                    <div class="milestone-timeline">
                        <div class="milestone-item" style="background:#1e293b;font-weight:600;">
                            <div style="color:#94a3b8;">Milestone</div>
                            <div style="color:#94a3b8;text-align:center;">Plan Date</div>
                            <div style="color:#94a3b8;text-align:center;">Actual Date</div>
                            <div style="color:#94a3b8;text-align:center;">Status</div>
                        </div>
                        ${milestoneLabels.map(m => {
                            const ms = p.milestones[m.key];
                            const isCompleted = !!ms.actual;
                            const isDelayed = ms.actual && ms.plan && new Date(ms.actual) > new Date(ms.plan);
                            return `
                                <div class="milestone-item ${isCompleted ? 'completed' : 'pending'}">
                                    <div class="milestone-name">${m.label}</div>
                                    <div class="milestone-date">${ms.plan || '-'}</div>
                                    <div class="milestone-date ${isCompleted ? 'actual' : ''}">${ms.actual || '-'}</div>
                                    <div class="milestone-status">
                                        ${isCompleted 
                                            ? (isDelayed 
                                                ? '<span class="badge badge-warning">Delayed</span>' 
                                                : '<span class="badge badge-success">Done</span>')
                                            : '<span class="badge badge-default">Pending</span>'
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        Progress Tracking
                    </div>
                    <div class="detail-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        ${p.engineering.required ? `
                        <div class="detail-item">
                            <label>Engineering Progress</label>
                            <div class="progress-detail">
                                <div class="progress-detail-bar">
                                    <div class="progress-detail-fill ${engColor}" style="width:${p.engineering.actualProgress}%"></div>
                                </div>
                                <div class="progress-info">
                                    <span>Actual: <span class="value">${p.engineering.actualProgress}%</span></span>
                                    <span>Plan: <span class="value">${Math.round(planEng)}%</span></span>
                                    <span>Variance: <span class="value" style="color:${engVariance >= 0 ? '#34d399' : '#f87171'}">${engVariance >= 0 ? '+' : ''}${Math.round(engVariance)}%</span></span>
                                </div>
                            </div>
                            <div style="margin-top:0.75rem;display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.8rem;">
                                <div><span style="color:#64748b;">Plan Start:</span> <span style="color:#cbd5e1;">${p.engineering.planStart || '-'}</span></div>
                                <div><span style="color:#64748b;">Plan Finish:</span> <span style="color:#cbd5e1;">${p.engineering.planFinish || '-'}</span></div>
                                <div><span style="color:#64748b;">Actual Start:</span> <span style="color:#cbd5e1;">${p.engineering.actualStart || '-'}</span></div>
                                <div><span style="color:#64748b;">Actual Finish:</span> <span style="color:#cbd5e1;">${p.engineering.actualFinish || '-'}</span></div>
                            </div>
                            ${p.engineering.remark ? `<div style="margin-top:0.5rem;padding:0.5rem;background:#0f172a;border-radius:8px;font-size:0.8rem;color:#94a3b8;"><strong>Remark:</strong> ${p.engineering.remark}</div>` : ''}
                        </div>
                        ` : '<div class="detail-item" style="opacity:0.5;"><label>Engineering</label><span>Not Required</span></div>'}
                        
                        <div class="detail-item">
                            <label>Manufacture Progress</label>
                            <div class="progress-detail">
                                <div class="progress-detail-bar">
                                    <div class="progress-detail-fill ${mfgColor}" style="width:${p.manufacture.actualProgress}%"></div>
                                </div>
                                <div class="progress-info">
                                    <span>Actual: <span class="value">${p.manufacture.actualProgress}%</span></span>
                                    <span>Plan: <span class="value">${Math.round(planMfg)}%</span></span>
                                    <span>Variance: <span class="value" style="color:${mfgVariance >= 0 ? '#34d399' : '#f87171'}">${mfgVariance >= 0 ? '+' : ''}${Math.round(mfgVariance)}%</span></span>
                                </div>
                            </div>
                            <div style="margin-top:0.75rem;display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.8rem;">
                                <div><span style="color:#64748b;">Plan Start:</span> <span style="color:#cbd5e1;">${p.manufacture.planStart || '-'}</span></div>
                                <div><span style="color:#64748b;">Plan Finish:</span> <span style="color:#cbd5e1;">${p.manufacture.planFinish || '-'}</span></div>
                                <div><span style="color:#64748b;">Actual Start:</span> <span style="color:#cbd5e1;">${p.manufacture.actualStart || '-'}</span></div>
                                <div><span style="color:#64748b;">Actual Finish:</span> <span style="color:#cbd5e1;">${p.manufacture.actualFinish || '-'}</span></div>
                            </div>
                            ${p.manufacture.remark ? `<div style="margin-top:0.5rem;padding:0.5rem;background:#0f172a;border-radius:8px;font-size:0.8rem;color:#94a3b8;"><strong>Remark:</strong> ${p.manufacture.remark}</div>` : ''}
                            
                            <!-- FAT Section -->
                            <div style="margin-top:1rem;padding:1rem;background:rgba(139,92,246,0.1);border-radius:12px;border:1px solid rgba(139,92,246,0.2);">
                                <h4 style="color:#a78bfa;font-size:0.8rem;font-weight:600;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    Factory Acceptance Test (FAT)
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.8rem;">
                                    <div><span style="color:#64748b;">Plan FAT:</span> <span style="color:#cbd5e1;">${p.manufacture.planFAT || '-'}</span></div>
                                    <div><span style="color:#64748b;">Actual FAT:</span> <span style="color:#cbd5e1;">${p.manufacture.actualFAT || '-'}</span></div>
                                    <div><span style="color:#64748b;">Result:</span> 
                                        <span style="color:${p.manufacture.fatResult === 'Passed' ? '#34d399' : p.manufacture.fatResult === 'Passed with Remarks' ? '#fbbf24' : p.manufacture.fatResult === 'Failed' ? '#f87171' : '#94a3b8'};">
                                            ${p.manufacture.fatResult || 'Pending'}
                                        </span>
                                    </div>
                                    <div><span style="color:#64748b;">Status:</span> 
                                        <span class="badge" style="background:${p.manufacture.actualFAT && (p.manufacture.fatResult === 'Passed' || p.manufacture.fatResult === 'Passed with Remarks') ? 'rgba(16,185,129,0.2)' : p.manufacture.planFAT && new Date() > new Date(p.manufacture.planFAT) && !p.manufacture.actualFAT ? 'rgba(239,68,68,0.2)' : 'rgba(59,130,246,0.2)'};color:${p.manufacture.actualFAT && (p.manufacture.fatResult === 'Passed' || p.manufacture.fatResult === 'Passed with Remarks') ? '#34d399' : p.manufacture.planFAT && new Date() > new Date(p.manufacture.planFAT) && !p.manufacture.actualFAT ? '#f87171' : '#60a5fa'};">
                                            ${p.manufacture.actualFAT && (p.manufacture.fatResult === 'Passed' || p.manufacture.fatResult === 'Passed with Remarks') ? 'Completed' : p.manufacture.planFAT && new Date() > new Date(p.manufacture.planFAT) && !p.manufacture.actualFAT ? 'Overdue' : p.manufacture.planFAT ? 'Scheduled' : 'Not Scheduled'}
                                        </span>
                                    </div>
                                </div>
                                ${p.manufacture.fatRemarks ? `<div style="margin-top:0.5rem;padding:0.5rem;background:#0f172a;border-radius:8px;font-size:0.8rem;color:#94a3b8;"><strong>FAT Remarks:</strong> ${p.manufacture.fatRemarks}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Section -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                        Delivery Information
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Incoterm</label>
                            <span>${p.delivery.incoterm || '-'}</span>
                            ${incoterm ? `<div style="font-size:0.75rem;color:#94a3b8;margin-top:0.25rem;">${incoterm.name} - ${incoterm.desc}</div>` : ''}
                        </div>
                        <div class="detail-item"><label>Delivery Location</label><span>${p.delivery.deliveryLocation || '-'}</span></div>
                    </div>
                    
                    <!-- Shipping Status Section -->
                    <div style="margin-top:1rem;padding:1rem;background:rgba(6,182,212,0.1);border-radius:12px;border:1px solid rgba(6,182,212,0.2);">
                        <h4 style="color:#22d3ee;font-size:0.875rem;font-weight:600;margin-bottom:1rem;">Shipping / Delivery Status</h4>
                        <div class="detail-grid">
                            <div class="detail-item"><label>Plan Delivery 100%</label><span>${p.delivery.planDelivery100 || p.delivery.planDate || '-'}</span></div>
                            <div class="detail-item"><label>Actual Delivery 100%</label><span>${p.delivery.actualDelivery100 || p.delivery.actualDate || '-'}</span></div>
                            <div class="detail-item">
                                <label>Shipping Status</label>
                                <div class="progress-detail" style="margin-top:0.5rem;">
                                    <div class="progress-detail-bar">
                                        <div class="progress-detail-fill ${(p.delivery.shippingStatus || 0) >= (p.delivery.shippingStatusPlan || 0) ? 'green' : 'red'}" style="width:${p.delivery.shippingStatus || 0}%"></div>
                                    </div>
                                    <div class="progress-info">
                                        <span>Actual: <span class="value">${p.delivery.shippingStatus || 0}%</span></span>
                                        <span>Plan: <span class="value">${p.delivery.shippingStatusPlan || 0}%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Material at Site Section -->
                    <div style="margin-top:1rem;padding:1rem;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);">
                        <h4 style="color:#34d399;font-size:0.875rem;font-weight:600;margin-bottom:1rem;">Material Received at Site</h4>
                        <div class="detail-grid">
                            <div class="detail-item"><label>Plan Material 100% at Site</label><span>${p.delivery.planMaterialAtSite100 || p.delivery.requiredAtSite || '-'}</span></div>
                            <div class="detail-item"><label>Actual Material 100% at Site</label><span>${p.delivery.actualMaterialAtSite100 || '-'}</span></div>
                            <div class="detail-item">
                                <label>Material Received Status</label>
                                <div class="progress-detail" style="margin-top:0.5rem;">
                                    <div class="progress-detail-bar">
                                        <div class="progress-detail-fill ${(p.delivery.materialReceivedActual || 0) >= (p.delivery.materialAtSitePlan || 0) ? 'green' : 'red'}" style="width:${p.delivery.materialReceivedActual || 0}%"></div>
                                    </div>
                                    <div class="progress-info">
                                        <span>Actual: <span class="value">${p.delivery.materialReceivedActual || 0}%</span></span>
                                        <span>Plan: <span class="value">${p.delivery.materialAtSitePlan || 0}%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delivery-status">
                        <div class="delivery-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>
                        </div>
                        <div class="delivery-info">
                            <h4>${(p.delivery.materialReceivedActual || 0) >= 100 ? 'Material Received' : (p.delivery.shippingStatus || 0) >= 100 ? 'Delivered - Awaiting Receipt' : (p.delivery.shippingStatus || 0) > 0 ? 'In Transit' : 'Awaiting Shipment'}</h4>
                            <p>${p.delivery.incoterm ? `Shipping via ${p.delivery.incoterm}` : 'Incoterm not specified'} ${p.delivery.deliveryLocation ? `to ${p.delivery.deliveryLocation}` : ''}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('packageDetailContent').innerHTML = html;
            document.getElementById('packageDetailModal').classList.add('active');
        }
        
        function closePackageDetail() {
            document.getElementById('packageDetailModal').classList.remove('active');
            currentViewPackageId = null;
        }
        
        function editPackageFromDetail() {
            if (currentViewPackageId) {
                closePackageDetail();
                setTimeout(() => {
                    openPackageModal(currentViewPackageId);
                }, 200);
            }
        }
        function closeRiskModal() { document.getElementById('riskModal').classList.remove('active'); }

        function populatePackageForm(p) { 
            document.getElementById('packageId').value=p.id;
            document.getElementById('initiation').value=p.initiation;
            document.getElementById('discipline').value=p.discipline;
            document.getElementById('area').value=p.area;
            document.getElementById('rfqNo').value=p.rfqNo;
            document.getElementById('packageName').value=p.packageName;
            document.getElementById('packageDesc').value=p.description;
            document.getElementById('contractNo').value=p.contractNo;
            document.getElementById('vendorName').value=p.vendorName;
            document.getElementById('coo').value=p.coo;
            milestoneLabels.forEach(m=>{
                document.getElementById(m.key+'Plan').value=p.milestones[m.key].plan;
                document.getElementById(m.key+'Actual').value=p.milestones[m.key].actual;
            });
            document.getElementById('engRequired').checked=p.engineering.required;
            document.getElementById('engineeringFields').style.display=p.engineering.required?'block':'none';
            document.getElementById('engPlanStart').value=p.engineering.planStart;
            document.getElementById('engPlanFinish').value=p.engineering.planFinish;
            document.getElementById('engActualStart').value=p.engineering.actualStart;
            document.getElementById('engActualFinish').value=p.engineering.actualFinish;
            document.getElementById('engStatusDate').value=p.engineering.statusDate || '';
            document.getElementById('engActualProgress').value=p.engineering.actualProgress;
            document.getElementById('engRemark').value=p.engineering.remark;
            // Calculate Engineering Plan Progress
            calcEngineeringPlanProgress();
            
            document.getElementById('mfgPlanStart').value=p.manufacture.planStart;
            document.getElementById('mfgPlanFinish').value=p.manufacture.planFinish;
            document.getElementById('mfgActualStart').value=p.manufacture.actualStart;
            document.getElementById('mfgActualFinish').value=p.manufacture.actualFinish;
            document.getElementById('mfgStatusDate').value=p.manufacture.statusDate || '';
            document.getElementById('mfgActualProgress').value=p.manufacture.actualProgress;
            document.getElementById('mfgRemark').value=p.manufacture.remark;
            // Calculate Manufacture Plan Progress
            calcManufacturePlanProgress();
            
            // FAT fields
            document.getElementById('mfgPlanFAT').value=p.manufacture.planFAT || '';
            document.getElementById('mfgActualFAT').value=p.manufacture.actualFAT || '';
            document.getElementById('mfgFATResult').value=p.manufacture.fatResult || '';
            document.getElementById('mfgFATRemarks').value=p.manufacture.fatRemarks || '';
            updateFATStatus(p.manufacture.planFAT, p.manufacture.actualFAT, p.manufacture.fatResult);
            document.getElementById('incoterm').value=p.delivery.incoterm;
            document.getElementById('deliveryLocation').value=p.delivery.deliveryLocation;
            // New delivery fields
            document.getElementById('planDelivery100').value=p.delivery.planDelivery100 || p.delivery.planDate || '';
            document.getElementById('actualDelivery100').value=p.delivery.actualDelivery100 || p.delivery.actualDate || '';
            document.getElementById('shippingStatusDate').value=p.delivery.shippingStatusDate || '';
            document.getElementById('shippingStatus').value=p.delivery.shippingStatus || 0;
            document.getElementById('planMaterialAtSite100').value=p.delivery.planMaterialAtSite100 || p.delivery.requiredAtSite || '';
            document.getElementById('actualMaterialAtSite100').value=p.delivery.actualMaterialAtSite100 || '';
            document.getElementById('materialStatusDate').value=p.delivery.materialStatusDate || '';
            document.getElementById('materialReceivedActual').value=p.delivery.materialReceivedActual || 0;
            // Legacy hidden fields for backward compatibility
            document.getElementById('deliveryPlanDate').value=p.delivery.planDelivery100 || p.delivery.planDate || '';
            document.getElementById('deliveryActualDate').value=p.delivery.actualDelivery100 || p.delivery.actualDate || '';
            document.getElementById('requiredAtSite').value=p.delivery.planMaterialAtSite100 || p.delivery.requiredAtSite || '';
            updateIncotermInfo();
            calcDeliveryPlanStatus();
        }
        function populateProjectForm(p) { document.getElementById('projectId').value=p.id;document.getElementById('projName').value=p.name;document.getElementById('projOwner').value=p.owner;document.getElementById('projContractor').value=p.contractor;document.getElementById('projTechProvider').value=p.technologyProvider;document.getElementById('projContractType').value=p.contractType;document.getElementById('projContractPrice').value=p.contractPrice;document.getElementById('projPaymentTerm').value=p.paymentTerm;document.getElementById('projStartDate').value=p.startDate;document.getElementById('projFinishDate').value=p.finishDate;document.getElementById('projLdDelay').value=p.ldDelay;document.getElementById('projLdPerformance').value=p.ldPerformance;document.getElementById('projGuaranteePower').value=p.guaranteePower;document.getElementById('projScopeByOwner').value=p.scopeByOwner; }
        function populateRiskForm(r) { document.getElementById('riskId').value=r.id;document.getElementById('riskPackageId').value=r.packageId;document.getElementById('riskCategory').value=r.category;document.getElementById('riskDescription').value=r.riskDescription;document.getElementById('riskProbability').value=r.probability;document.getElementById('riskImpact').value=r.impact;document.getElementById('riskStatus').value=r.status;document.getElementById('riskMitigation').value=r.mitigation;document.getElementById('riskOwner').value=r.owner;document.getElementById('riskDueDate').value=r.dueDate;calcRiskLevel(); }

        function savePackage() { 
            const id=document.getElementById('packageId').value;
            const pkg={
                id:id?parseInt(id):Date.now(),
                projectId:selectedProject,
                initiation:document.getElementById('initiation').value,
                discipline:document.getElementById('discipline').value,
                area:document.getElementById('area').value,
                rfqNo:document.getElementById('rfqNo').value,
                packageName:document.getElementById('packageName').value,
                description:document.getElementById('packageDesc').value,
                contractNo:document.getElementById('contractNo').value,
                vendorName:document.getElementById('vendorName').value,
                coo:document.getElementById('coo').value,
                milestones:{},
                engineering:{
                    required:document.getElementById('engRequired').checked,
                    planStart:document.getElementById('engPlanStart').value,
                    planFinish:document.getElementById('engPlanFinish').value,
                    actualStart:document.getElementById('engActualStart').value,
                    actualFinish:document.getElementById('engActualFinish').value,
                    statusDate:document.getElementById('engStatusDate').value,
                    planProgress:parseFloat(document.getElementById('engPlanProgress').textContent)||0,
                    actualProgress:parseInt(document.getElementById('engActualProgress').value)||0,
                    remark:document.getElementById('engRemark').value
                },
                manufacture:{
                    planStart:document.getElementById('mfgPlanStart').value,
                    planFinish:document.getElementById('mfgPlanFinish').value,
                    actualStart:document.getElementById('mfgActualStart').value,
                    actualFinish:document.getElementById('mfgActualFinish').value,
                    statusDate:document.getElementById('mfgStatusDate').value,
                    planProgress:parseFloat(document.getElementById('mfgPlanProgress').textContent)||0,
                    actualProgress:parseInt(document.getElementById('mfgActualProgress').value)||0,
                    remark:document.getElementById('mfgRemark').value,
                    planFAT:document.getElementById('mfgPlanFAT').value,
                    actualFAT:document.getElementById('mfgActualFAT').value,
                    fatResult:document.getElementById('mfgFATResult').value,
                    fatRemarks:document.getElementById('mfgFATRemarks').value
                },
                delivery:{
                    incoterm:document.getElementById('incoterm').value,
                    deliveryLocation:document.getElementById('deliveryLocation').value,
                    planDelivery100:document.getElementById('planDelivery100').value,
                    actualDelivery100:document.getElementById('actualDelivery100').value,
                    shippingStatusDate:document.getElementById('shippingStatusDate').value,
                    shippingStatusPlan:parseFloat(document.getElementById('shippingStatusPlanDisplay').textContent)||0,
                    shippingStatus:parseInt(document.getElementById('shippingStatus').value)||0,
                    planMaterialAtSite100:document.getElementById('planMaterialAtSite100').value,
                    actualMaterialAtSite100:document.getElementById('actualMaterialAtSite100').value,
                    materialStatusDate:document.getElementById('materialStatusDate').value,
                    materialAtSitePlan:parseFloat(document.getElementById('materialAtSitePlanDisplay').textContent)||0,
                    materialReceivedActual:parseInt(document.getElementById('materialReceivedActual').value)||0
                }
            };
            milestoneLabels.forEach(m=>{
                pkg.milestones[m.key]={
                    plan:document.getElementById(m.key+'Plan').value,
                    actual:document.getElementById(m.key+'Actual').value
                };
            });
            if(id){
                const i=packages.findIndex(p=>p.id===parseInt(id));
                if(i!==-1)packages[i]=pkg;
            }else{
                packages.push(pkg);
            }
            saveAllData();
            showNotification(id?'Package updated successfully':'Package added successfully','success');
            closePackageModal();
            renderAll(); 
        }
        function saveProject() { const id=document.getElementById('projectId').value,proj={id:id?parseInt(id):Date.now(),name:document.getElementById('projName').value,owner:document.getElementById('projOwner').value,contractor:document.getElementById('projContractor').value,technologyProvider:document.getElementById('projTechProvider').value,contractType:document.getElementById('projContractType').value,contractPrice:parseInt(document.getElementById('projContractPrice').value)||0,paymentTerm:document.getElementById('projPaymentTerm').value,startDate:document.getElementById('projStartDate').value,finishDate:document.getElementById('projFinishDate').value,ldDelay:parseInt(document.getElementById('projLdDelay').value)||0,ldPerformance:parseInt(document.getElementById('projLdPerformance').value)||0,guaranteePower:parseInt(document.getElementById('projGuaranteePower').value)||0,scopeByOwner:document.getElementById('projScopeByOwner').value};if(id){const i=projects.findIndex(p=>p.id===parseInt(id));if(i!==-1)projects[i]=proj;}else{projects.push(proj);selectedProject=proj.id;}saveAllData();showNotification(id?'Project updated successfully':'Project added successfully','success');closeProjectModal();populateSelects();renderAll(); }
        function saveRisk() { 
            const id = document.getElementById('riskId').value;
            const prob = document.getElementById('riskProbability').value;
            const impact = document.getElementById('riskImpact').value;
            const existingRisk = id ? risks.find(r => r.id === parseInt(id)) : null;
            
            const risk = {
                id: id ? parseInt(id) : Date.now(),
                projectId: selectedProject,
                packageId: parseInt(document.getElementById('riskPackageId').value) || null,
                category: document.getElementById('riskCategory').value,
                riskDescription: document.getElementById('riskDescription').value,
                probability: prob,
                impact: impact,
                riskLevel: calcRiskLevelValue(prob, impact),
                status: document.getElementById('riskStatus').value,
                mitigation: document.getElementById('riskMitigation').value,
                owner: document.getElementById('riskOwner').value,
                dueDate: document.getElementById('riskDueDate').value,
                isAutoGenerated: existingRisk ? existingRisk.isAutoGenerated : false, // Preserve auto flag if editing
                generatedDate: existingRisk?.generatedDate || null,
                lastModified: new Date().toISOString()
            };
            
            if (id) {
                const i = risks.findIndex(r => r.id === parseInt(id));
                if (i !== -1) risks[i] = risk;
            } else {
                risks.push(risk);
            }
            
            saveAllData();
            showNotification(id ? 'Risk updated successfully' : 'Risk added successfully', 'success');
            closeRiskModal();
            renderAll(); 
        }

        function editPackage(id) { openPackageModal(id); }
        function editProject(id) { openProjectModal(id); }
        function editRisk(id) { openRiskModal(id); }
        function deletePackage(id) { if(confirm('Delete this package?')){packages=packages.filter(p=>p.id!==id);saveAllData();showNotification('Package deleted','success');renderAll();} }
        function deleteRisk(id) { if(confirm('Delete this risk?')){risks=risks.filter(r=>r.id!==id);saveAllData();showNotification('Risk deleted','success');renderAll();} }
        function deleteProject(id) { 
            if(confirm('Delete this project? All associated packages and risks will also be deleted.')){
                packages=packages.filter(p=>p.projectId!==id);
                risks=risks.filter(r=>r.projectId!==id);
                projects=projects.filter(p=>p.id!==id);
                if(selectedProject===id && projects.length>0) selectedProject=projects[0].id;
                else if(projects.length===0) selectedProject=null;
                saveAllData();
                showNotification('Project deleted','success');
                populateSelects();
                renderAll();
            } 
        }

        // ===== EXPORT PDF FUNCTIONS =====
        
        function toggleExportDropdown() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeExportDropdown);
            }, 0);
        }
        
        function closeExportDropdown(e) {
            const dropdown = document.getElementById('exportDropdown');
            const button = e?.target?.closest('.export-dropdown');
            if (!button) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeExportDropdown);
            }
        }
        
        function showPdfLoading(show, progress = '') {
            const overlay = document.getElementById('pdfLoadingOverlay');
            const progressEl = document.getElementById('pdfLoadingProgress');
            if (show) {
                overlay.classList.add('show');
                if (progress) progressEl.textContent = progress;
            } else {
                overlay.classList.remove('show');
            }
        }
        
        // Export Dashboard PDF with Charts
        async function exportDashboardPDF() {
            closeExportDropdown();
            showPdfLoading(true, 'Initializing...');
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape A4
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;
                
                const proj = projects.find(p => p.id === selectedProject);
                const s = getStats();
                const pkgs = getProjectPackages();
                
                // Header
                pdf.setFillColor(15, 118, 110);
                pdf.rect(0, 0, pageWidth, 25, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Procurement Dashboard Report', pageWidth / 2, 12, { align: 'center' });
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(proj?.name || 'All Projects', pageWidth / 2, 19, { align: 'center' });
                
                yPos = 32;
                
                // Meta info
                pdf.setTextColor(100, 116, 139);
                pdf.setFontSize(9);
                pdf.text('Generated: ' + new Date().toLocaleString('id-ID'), margin, yPos);
                pdf.text('Owner: ' + (proj?.owner || '-'), pageWidth / 2, yPos, { align: 'center' });
                pdf.text('Contractor: ' + (proj?.contractor || '-'), pageWidth - margin, yPos, { align: 'right' });
                
                yPos += 10;
                
                // Statistics boxes
                showPdfLoading(true, 'Rendering statistics...');
                const statBoxWidth = (pageWidth - margin * 2 - 15) / 4;
                const stats = [
                    { label: 'Total Packages', value: s.total, color: [59, 130, 246] },
                    { label: 'PO Issued', value: s.poIssued, color: [16, 185, 129] },
                    { label: 'Critical Items', value: s.criticalCount, color: [239, 68, 68] },
                    { label: 'Avg Progress', value: s.avgProgress + '%', color: [20, 184, 166] }
                ];
                
                stats.forEach((stat, i) => {
                    const x = margin + i * (statBoxWidth + 5);
                    pdf.setFillColor(248, 250, 252);
                    pdf.setDrawColor(226, 232, 240);
                    pdf.roundedRect(x, yPos, statBoxWidth, 22, 3, 3, 'FD');
                    pdf.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(String(stat.value), x + statBoxWidth / 2, yPos + 10, { align: 'center' });
                    pdf.setTextColor(100, 116, 139);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(stat.label, x + statBoxWidth / 2, yPos + 17, { align: 'center' });
                });
                
                yPos += 30;
                
                // Capture Charts
                showPdfLoading(true, 'Capturing charts...');
                
                // Discipline Chart
                const disciplineCanvas = document.getElementById('disciplineChart');
                const disciplineImg = disciplineCanvas.toDataURL('image/png', 1.0);
                const chartWidth = (pageWidth - margin * 2 - 10) / 2;
                const chartHeight = 55;
                
                pdf.setFillColor(248, 250, 252);
                pdf.roundedRect(margin, yPos, chartWidth, chartHeight + 10, 3, 3, 'F');
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Progress by Discipline', margin + 5, yPos + 7);
                pdf.addImage(disciplineImg, 'PNG', margin + 5, yPos + 10, chartWidth - 10, chartHeight - 5);
                
                // S-Curve Chart
                const scurveCanvas = document.getElementById('scurveChart');
                const scurveImg = scurveCanvas.toDataURL('image/png', 1.0);
                
                pdf.setFillColor(248, 250, 252);
                pdf.roundedRect(margin + chartWidth + 10, yPos, chartWidth, chartHeight + 10, 3, 3, 'F');
                pdf.setTextColor(30, 41, 59);
                pdf.text('Overall S-Curve', margin + chartWidth + 15, yPos + 7);
                pdf.addImage(scurveImg, 'PNG', margin + chartWidth + 15, yPos + 10, chartWidth - 10, chartHeight - 5);
                
                yPos += chartHeight + 18;
                
                // Packages Table
                showPdfLoading(true, 'Generating table...');
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Package Summary', margin, yPos);
                yPos += 6;
                
                // Table Header
                const colWidths = [55, 30, 45, 30, 30, 35, 40];
                const headers = ['Package', 'Discipline', 'Vendor', 'COO', 'PO Status', 'Mfg Progress', 'Delivery'];
                
                pdf.setFillColor(15, 118, 110);
                pdf.rect(margin, yPos, pageWidth - margin * 2, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                
                let xPos = margin + 2;
                headers.forEach((header, i) => {
                    pdf.text(header, xPos, yPos + 5.5);
                    xPos += colWidths[i];
                });
                
                yPos += 8;
                
                // Table Rows
                pdf.setFont('helvetica', 'normal');
                pkgs.forEach((pkg, idx) => {
                    if (yPos > pageHeight - 25) {
                        pdf.addPage();
                        yPos = margin;
                    }
                    
                    if (idx % 2 === 0) {
                        pdf.setFillColor(248, 250, 252);
                        pdf.rect(margin, yPos, pageWidth - margin * 2, 7, 'F');
                    }
                    
                    pdf.setTextColor(30, 41, 59);
                    pdf.setFontSize(7);
                    xPos = margin + 2;
                    
                    const plan = calculateSCurve(pkg.manufacture.planStart, pkg.manufacture.planFinish);
                    const rowData = [
                        pkg.packageName.substring(0, 25),
                        pkg.discipline,
                        (pkg.vendorName || '-').substring(0, 20),
                        pkg.coo || '-',
                        pkg.milestones.issuePO.actual ? 'Issued' : 'Pending',
                        pkg.manufacture.actualProgress + '% (Plan: ' + Math.round(plan) + '%)',
                        pkg.delivery.planDate || '-'
                    ];
                    
                    rowData.forEach((data, i) => {
                        pdf.text(data, xPos, yPos + 5);
                        xPos += colWidths[i];
                    });
                    
                    yPos += 7;
                });
                
                // Footer
                yPos = pageHeight - 10;
                pdf.setDrawColor(226, 232, 240);
                pdf.line(margin, yPos - 3, pageWidth - margin, yPos - 3);
                pdf.setTextColor(148, 163, 184);
                pdf.setFontSize(8);
                pdf.text('Generated by Procurement Management System | Confidential - Internal Use Only', pageWidth / 2, yPos, { align: 'center' });
                
                showPdfLoading(true, 'Saving PDF...');
                pdf.save('Dashboard_Report_' + new Date().toISOString().split('T')[0] + '.pdf');
                showPdfLoading(false);
                showNotification('Dashboard PDF exported successfully!', 'success');
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showPdfLoading(false);
                showNotification('Error exporting PDF: ' + error.message, 'danger');
            }
        }
        
        // Export Risk Analysis PDF with Charts
        async function exportRiskAnalysisPDF() {
            closeExportDropdown();
            showPdfLoading(true, 'Initializing...');
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;
                
                const proj = projects.find(p => p.id === selectedProject);
                const rs = getProjectRisks();
                
                // Header
                pdf.setFillColor(15, 118, 110);
                pdf.rect(0, 0, pageWidth, 25, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Risk Analysis Report', pageWidth / 2, 12, { align: 'center' });
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(proj?.name || 'All Projects', pageWidth / 2, 19, { align: 'center' });
                
                yPos = 32;
                
                // Meta info
                pdf.setTextColor(100, 116, 139);
                pdf.setFontSize(9);
                pdf.text('Generated: ' + new Date().toLocaleString('id-ID'), margin, yPos);
                pdf.text('Total Risks: ' + rs.length, pageWidth - margin, yPos, { align: 'right' });
                
                yPos += 10;
                
                // Risk Statistics
                showPdfLoading(true, 'Rendering statistics...');
                const critCount = rs.filter(r => r.riskLevel === 'Critical').length;
                const medCount = rs.filter(r => r.riskLevel === 'Medium').length;
                const lowCount = rs.filter(r => r.riskLevel === 'Low').length;
                const openCount = rs.filter(r => r.status === 'Open').length;
                const autoCount = rs.filter(r => r.isAutoGenerated).length;
                const manualCount = rs.filter(r => !r.isAutoGenerated).length;
                
                const statBoxWidth = (pageWidth - margin * 2 - 25) / 6;
                const riskStats = [
                    { label: 'Critical', value: critCount, color: [220, 38, 38] },
                    { label: 'Medium', value: medCount, color: [217, 119, 6] },
                    { label: 'Low', value: lowCount, color: [22, 163, 74] },
                    { label: 'Open', value: openCount, color: [6, 182, 212] },
                    { label: 'Auto', value: autoCount, color: [139, 92, 246] },
                    { label: 'Manual', value: manualCount, color: [100, 116, 139] }
                ];
                
                riskStats.forEach((stat, i) => {
                    const x = margin + i * (statBoxWidth + 5);
                    pdf.setFillColor(248, 250, 252);
                    pdf.setDrawColor(226, 232, 240);
                    pdf.roundedRect(x, yPos, statBoxWidth, 18, 2, 2, 'FD');
                    pdf.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(String(stat.value), x + statBoxWidth / 2, yPos + 8, { align: 'center' });
                    pdf.setTextColor(100, 116, 139);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(stat.label, x + statBoxWidth / 2, yPos + 14, { align: 'center' });
                });
                
                yPos += 25;
                
                // Capture Charts
                showPdfLoading(true, 'Capturing charts...');
                
                // Risk Pie Chart
                const riskPieCanvas = document.getElementById('riskPieChart');
                const riskPieImg = riskPieCanvas.toDataURL('image/png', 1.0);
                const chartWidth = (pageWidth - margin * 2 - 10) / 2;
                const chartHeight = 50;
                
                pdf.setFillColor(248, 250, 252);
                pdf.roundedRect(margin, yPos, chartWidth, chartHeight + 10, 3, 3, 'F');
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Risk Distribution', margin + 5, yPos + 7);
                pdf.addImage(riskPieImg, 'PNG', margin + 10, yPos + 10, chartWidth - 20, chartHeight - 5);
                
                // Risk Heat Map - Capture as image
                showPdfLoading(true, 'Capturing heat map...');
                const heatMapEl = document.getElementById('riskHeatMap');
                const heatMapCanvas = await html2canvas(heatMapEl, { backgroundColor: '#1e293b', scale: 2 });
                const heatMapImg = heatMapCanvas.toDataURL('image/png');
                
                pdf.setFillColor(248, 250, 252);
                pdf.roundedRect(margin + chartWidth + 10, yPos, chartWidth, chartHeight + 10, 3, 3, 'F');
                pdf.setTextColor(30, 41, 59);
                pdf.text('Risk Heat Map', margin + chartWidth + 15, yPos + 7);
                pdf.addImage(heatMapImg, 'PNG', margin + chartWidth + 20, yPos + 10, chartWidth - 25, chartHeight - 5);
                
                yPos += chartHeight + 18;
                
                // Risk Register Table
                showPdfLoading(true, 'Generating risk register...');
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Risk Register', margin, yPos);
                yPos += 6;
                
                // Table Header
                const colWidths = [40, 25, 80, 20, 25, 20, 55];
                const headers = ['Package', 'Category', 'Risk Description', 'Level', 'Status', 'Source', 'Mitigation'];
                
                pdf.setFillColor(15, 118, 110);
                pdf.rect(margin, yPos, pageWidth - margin * 2, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(7);
                pdf.setFont('helvetica', 'bold');
                
                let xPos = margin + 2;
                headers.forEach((header, i) => {
                    pdf.text(header, xPos, yPos + 5.5);
                    xPos += colWidths[i];
                });
                
                yPos += 8;
                
                // Table Rows
                pdf.setFont('helvetica', 'normal');
                rs.forEach((risk, idx) => {
                    if (yPos > pageHeight - 25) {
                        pdf.addPage();
                        yPos = margin;
                        
                        // Re-draw header on new page
                        pdf.setFillColor(15, 118, 110);
                        pdf.rect(margin, yPos, pageWidth - margin * 2, 8, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        xPos = margin + 2;
                        headers.forEach((header, i) => {
                            pdf.text(header, xPos, yPos + 5.5);
                            xPos += colWidths[i];
                        });
                        yPos += 8;
                        pdf.setFont('helvetica', 'normal');
                    }
                    
                    const rowHeight = 8;
                    if (idx % 2 === 0) {
                        pdf.setFillColor(248, 250, 252);
                        pdf.rect(margin, yPos, pageWidth - margin * 2, rowHeight, 'F');
                    }
                    
                    const pkg = packages.find(p => p.id === risk.packageId);
                    pdf.setFontSize(6);
                    xPos = margin + 2;
                    
                    // Package
                    pdf.setTextColor(30, 41, 59);
                    pdf.text((pkg?.packageName || 'Project Level').substring(0, 18), xPos, yPos + 5);
                    xPos += colWidths[0];
                    
                    // Category
                    pdf.text(risk.category, xPos, yPos + 5);
                    xPos += colWidths[1];
                    
                    // Description
                    pdf.text(risk.riskDescription.substring(0, 45), xPos, yPos + 5);
                    xPos += colWidths[2];
                    
                    // Level with color
                    if (risk.riskLevel === 'Critical') pdf.setTextColor(220, 38, 38);
                    else if (risk.riskLevel === 'Medium') pdf.setTextColor(217, 119, 6);
                    else pdf.setTextColor(22, 163, 74);
                    pdf.text(risk.riskLevel, xPos, yPos + 5);
                    xPos += colWidths[3];
                    
                    // Status
                    pdf.setTextColor(30, 41, 59);
                    pdf.text(risk.status, xPos, yPos + 5);
                    xPos += colWidths[4];
                    
                    // Source
                    if (risk.isAutoGenerated) pdf.setTextColor(139, 92, 246);
                    else pdf.setTextColor(100, 116, 139);
                    pdf.text(risk.isAutoGenerated ? 'Auto' : 'Manual', xPos, yPos + 5);
                    xPos += colWidths[5];
                    
                    // Mitigation
                    pdf.setTextColor(30, 41, 59);
                    pdf.text((risk.mitigation || '-').substring(0, 30), xPos, yPos + 5);
                    
                    yPos += rowHeight;
                });
                
                // Footer
                pdf.addPage();
                yPos = margin;
                
                // Risk Summary by Category
                pdf.setTextColor(30, 41, 59);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Risk Summary by Category', margin, yPos);
                yPos += 8;
                
                const categories = ['Schedule', 'Technical', 'Commercial', 'Logistics', 'HSE'];
                const catColors = {
                    'Schedule': [59, 130, 246],
                    'Technical': [139, 92, 246],
                    'Commercial': [236, 72, 153],
                    'Logistics': [245, 158, 11],
                    'HSE': [16, 185, 129]
                };
                
                categories.forEach(cat => {
                    const catRisks = rs.filter(r => r.category === cat);
                    if (catRisks.length > 0) {
                        const crit = catRisks.filter(r => r.riskLevel === 'Critical').length;
                        const med = catRisks.filter(r => r.riskLevel === 'Medium').length;
                        const low = catRisks.filter(r => r.riskLevel === 'Low').length;
                        
                        pdf.setFillColor(catColors[cat][0], catColors[cat][1], catColors[cat][2]);
                        pdf.rect(margin, yPos, 4, 12, 'F');
                        
                        pdf.setTextColor(30, 41, 59);
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(cat, margin + 8, yPos + 5);
                        
                        pdf.setFontSize(8);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(100, 116, 139);
                        pdf.text('Total: ' + catRisks.length + ' | Critical: ' + crit + ' | Medium: ' + med + ' | Low: ' + low, margin + 8, yPos + 10);
                        
                        yPos += 16;
                    }
                });
                
                // Final footer
                yPos = pageHeight - 10;
                pdf.setDrawColor(226, 232, 240);
                pdf.line(margin, yPos - 3, pageWidth - margin, yPos - 3);
                pdf.setTextColor(148, 163, 184);
                pdf.setFontSize(8);
                pdf.text('Generated by Procurement Management System | Confidential - Internal Use Only', pageWidth / 2, yPos, { align: 'center' });
                
                showPdfLoading(true, 'Saving PDF...');
                pdf.save('Risk_Analysis_Report_' + new Date().toISOString().split('T')[0] + '.pdf');
                showPdfLoading(false);
                showNotification('Risk Analysis PDF exported successfully!', 'success');
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showPdfLoading(false);
                showNotification('Error exporting PDF: ' + error.message, 'danger');
            }
        }
        
        // Quick Export (Table only - original functionality)
        function exportQuickPDF(type) {
            closeExportDropdown();
            const isRisk = type === 'risks';
            const proj = projects.find(p => p.id === selectedProject);
            const s = getStats();
            const pkgs = getProjectPackages();
            const rs = getProjectRisks();
            
            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><title>' + (isRisk ? 'Risk Analysis' : 'Dashboard') + ' Report</title><style>@page{size:A4 landscape;margin:15mm}body{font-family:Segoe UI,sans-serif;color:#1e293b;padding:20px}.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #0f766e}.header h1{color:#0f766e;margin:0 0 10px;font-size:24px}.header h2{color:#334155;margin:0;font-size:16px;font-weight:normal}.meta{display:flex;justify-content:space-between;margin-bottom:20px;font-size:12px;color:#64748b}.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:25px}.stat{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;text-align:center}.stat-val{font-size:28px;font-weight:700;color:#0f766e}.stat-lbl{font-size:12px;color:#64748b;margin-top:5px}table{width:100%;border-collapse:collapse;font-size:11px}th{background:#0f766e;color:white;padding:10px 8px;text-align:left}td{padding:8px;border-bottom:1px solid #e2e8f0}tr:nth-child(even){background:#f8fafc}.badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:600}.badge-critical{background:#fef2f2;color:#dc2626}.badge-warning{background:#fffbeb;color:#d97706}.badge-success{background:#f0fdf4;color:#16a34a}.footer{margin-top:30px;padding-top:15px;border-top:1px solid #e2e8f0;text-align:center;font-size:10px;color:#94a3b8}</style></head><body><div class="header"><h1>' + (isRisk ? 'Risk Analysis Report' : 'Procurement Dashboard Report') + '</h1><h2>' + (proj?.name || 'All Projects') + '</h2></div><div class="meta"><span>Generated: ' + new Date().toLocaleString('id-ID') + '</span><span>Owner: ' + (proj?.owner || '-') + '</span><span>Contractor: ' + (proj?.contractor || '-') + '</span></div>' + (isRisk ? '<div class="stats"><div class="stat"><div class="stat-val" style="color:#dc2626">' + rs.filter(r => r.riskLevel === 'Critical').length + '</div><div class="stat-lbl">Critical</div></div><div class="stat"><div class="stat-val" style="color:#d97706">' + rs.filter(r => r.riskLevel === 'Medium').length + '</div><div class="stat-lbl">Medium</div></div><div class="stat"><div class="stat-val" style="color:#16a34a">' + rs.filter(r => r.riskLevel === 'Low').length + '</div><div class="stat-lbl">Low</div></div><div class="stat"><div class="stat-val">' + rs.filter(r => r.status === 'Open').length + '</div><div class="stat-lbl">Open</div></div></div><table><thead><tr><th>Package</th><th>Category</th><th>Risk</th><th>Level</th><th>Status</th><th>Mitigation</th><th>Owner</th></tr></thead><tbody>' + rs.map(r => { const pkg = packages.find(p => p.id === r.packageId); return '<tr><td>' + (pkg?.packageName || '-') + '</td><td>' + r.category + '</td><td>' + r.riskDescription + '</td><td><span class="badge badge-' + (r.riskLevel === 'Critical' ? 'critical' : r.riskLevel === 'Medium' ? 'warning' : 'success') + '">' + r.riskLevel + '</span></td><td>' + r.status + '</td><td style="max-width:200px;font-size:10px;">' + r.mitigation + '</td><td>' + r.owner + '</td></tr>'; }).join('') + '</tbody></table>' : '<div class="stats"><div class="stat"><div class="stat-val">' + s.total + '</div><div class="stat-lbl">Total Packages</div></div><div class="stat"><div class="stat-val">' + s.poIssued + '</div><div class="stat-lbl">PO Issued</div></div><div class="stat"><div class="stat-val">' + s.criticalCount + '</div><div class="stat-lbl">Critical Items</div></div><div class="stat"><div class="stat-val">' + s.avgProgress + '%</div><div class="stat-lbl">Avg Progress</div></div></div><table><thead><tr><th>Package</th><th>Discipline</th><th>Vendor</th><th>COO</th><th>PO Status</th><th>Mfg Progress</th><th>Delivery</th></tr></thead><tbody>' + pkgs.map(p => '<tr><td><strong>' + p.packageName + '</strong><br><small>' + p.rfqNo + '</small></td><td>' + p.discipline + '</td><td>' + (p.vendorName || '-') + '</td><td>' + (p.coo || '-') + '</td><td>' + (p.milestones.issuePO.actual ? '<span class="badge badge-success">Issued</span>' : '<span class="badge badge-warning">Pending</span>') + '</td><td>' + p.manufacture.actualProgress + '%</td><td>' + (p.delivery.planDate || '-') + '</td></tr>').join('') + '</tbody></table>') + '<div class="footer"><p>Generated by Procurement Management System</p><p>Confidential - Internal Use Only</p></div></body></html>');
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 500);
        }
        
        // Legacy function for backward compatibility
        function exportPDF() {
            toggleExportDropdown();
        }
        
        // ===== DATA EXPORT/IMPORT FUNCTIONS =====
        
        // Variable to store imported data temporarily
        let pendingImportData = null;
        
        // Toggle Data Dropdown
        function toggleDataDropdown() {
            const dropdown = document.getElementById('dataDropdown');
            const exportDropdown = document.getElementById('exportDropdown');
            
            // Close export dropdown if open
            if (exportDropdown) exportDropdown.classList.remove('show');
            
            dropdown.classList.toggle('show');
        }
        
        // Close Data Dropdown
        function closeDataDropdown() {
            const dropdown = document.getElementById('dataDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dataDropdown = document.getElementById('dataDropdown');
            const dataBtn = e.target.closest('.data-dropdown');
            if (!dataBtn && dataDropdown) {
                dataDropdown.classList.remove('show');
            }
        });
        
        // Export All Data to JSON
        function exportAllData() {
            closeDataDropdown();
            
            try {
                const exportData = {
                    version: '1.2',
                    exportDate: new Date().toISOString(),
                    exportType: 'full',
                    application: 'Procurement Management System',
                    data: {
                        projects: projects,
                        packages: packages,
                        risks: risks,
                        weightFactors: weightFactors,
                        selectedProject: selectedProject
                    }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'procurement_data_backup_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('All data exported successfully!', 'success');
            } catch (error) {
                console.error('Export Error:', error);
                showNotification('Error exporting data: ' + error.message, 'danger');
            }
        }
        
        // Export Current Project Data to JSON
        function exportProjectData() {
            closeDataDropdown();
            
            try {
                const currentProject = projects.find(p => p.id === selectedProject);
                if (!currentProject) {
                    showNotification('No project selected!', 'warning');
                    return;
                }
                
                const projectPackages = packages.filter(p => p.projectId === selectedProject);
                const projectRisks = risks.filter(r => r.projectId === selectedProject);
                
                const exportData = {
                    version: '1.2',
                    exportDate: new Date().toISOString(),
                    exportType: 'project',
                    application: 'Procurement Management System',
                    data: {
                        projects: [currentProject],
                        packages: projectPackages,
                        risks: projectRisks,
                        weightFactors: weightFactors
                    }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const projectName = currentProject.name.replace(/[^a-z0-9]/gi, '_').substring(0, 30);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'procurement_project_' + projectName + '_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Project data exported successfully!', 'success');
            } catch (error) {
                console.error('Export Error:', error);
                showNotification('Error exporting project data: ' + error.message, 'danger');
            }
        }
        
        // Open Import Modal
        function openImportModal() {
            closeDataDropdown();
            pendingImportData = null;
            
            // Reset file input and preview
            document.getElementById('importFileInput').value = '';
            document.getElementById('importFileInfo').style.display = 'none';
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('importConfirmBtn').disabled = true;
            document.getElementById('importZone').style.display = 'block';
            
            document.getElementById('importModal').classList.add('active');
        }
        
        // Close Import Modal
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            pendingImportData = null;
        }
        
        // Handle File Selection
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.name.endsWith('.json')) {
                showNotification('Please select a JSON file!', 'warning');
                return;
            }
            
            // Show file info
            document.getElementById('importFileName').textContent = file.name;
            document.getElementById('importFileSize').textContent = formatFileSize(file.size);
            document.getElementById('importFileInfo').style.display = 'flex';
            document.getElementById('importZone').style.display = 'none';
            
            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!validateImportData(data)) {
                        showNotification('Invalid data format! Please check the file.', 'danger');
                        removeImportFile();
                        return;
                    }
                    
                    pendingImportData = data;
                    
                    // Show preview
                    const projectCount = data.data?.projects?.length || 0;
                    const packageCount = data.data?.packages?.length || 0;
                    const riskCount = data.data?.risks?.length || 0;
                    
                    document.getElementById('importProjectCount').textContent = projectCount;
                    document.getElementById('importPackageCount').textContent = packageCount;
                    document.getElementById('importRiskCount').textContent = riskCount;
                    
                    document.getElementById('importPreview').classList.add('show');
                    document.getElementById('importConfirmBtn').disabled = false;
                    
                } catch (error) {
                    console.error('Parse Error:', error);
                    showNotification('Error reading file: Invalid JSON format!', 'danger');
                    removeImportFile();
                }
            };
            reader.readAsText(file);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Validate import data structure
        function validateImportData(data) {
            // Check basic structure
            if (!data || typeof data !== 'object') return false;
            if (!data.data || typeof data.data !== 'object') return false;
            
            // Must have at least one of: projects, packages, or risks
            const hasProjects = Array.isArray(data.data.projects);
            const hasPackages = Array.isArray(data.data.packages);
            const hasRisks = Array.isArray(data.data.risks);
            
            if (!hasProjects && !hasPackages && !hasRisks) return false;
            
            // Validate projects structure
            if (hasProjects && data.data.projects.length > 0) {
                const proj = data.data.projects[0];
                if (typeof proj.id === 'undefined' || typeof proj.name === 'undefined') return false;
            }
            
            // Validate packages structure
            if (hasPackages && data.data.packages.length > 0) {
                const pkg = data.data.packages[0];
                if (typeof pkg.id === 'undefined' || typeof pkg.projectId === 'undefined') return false;
            }
            
            return true;
        }
        
        // Remove imported file
        function removeImportFile() {
            document.getElementById('importFileInput').value = '';
            document.getElementById('importFileInfo').style.display = 'none';
            document.getElementById('importPreview').classList.remove('show');
            document.getElementById('importConfirmBtn').disabled = true;
            document.getElementById('importZone').style.display = 'block';
            pendingImportData = null;
        }
        
        // Confirm Import
        function confirmImport() {
            if (!pendingImportData) {
                showNotification('No data to import!', 'warning');
                return;
            }
            
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            const confirmMsg = importMode === 'replace' 
                ? 'This will DELETE all existing data and replace with imported data. Continue?'
                : 'This will ADD imported data to existing data. This may create duplicate entries. Continue?';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                if (importMode === 'replace') {
                    // Replace all data
                    projects = pendingImportData.data.projects || [];
                    packages = pendingImportData.data.packages || [];
                    risks = pendingImportData.data.risks || [];
                    
                    if (pendingImportData.data.weightFactors) {
                        weightFactors = pendingImportData.data.weightFactors;
                    }
                    
                    // Set selected project to first available
                    selectedProject = projects.length > 0 ? projects[0].id : null;
                    
                } else {
                    // Merge data
                    const importedProjects = pendingImportData.data.projects || [];
                    const importedPackages = pendingImportData.data.packages || [];
                    const importedRisks = pendingImportData.data.risks || [];
                    
                    // Generate new IDs to avoid conflicts
                    const maxProjectId = Math.max(0, ...projects.map(p => p.id));
                    const maxPackageId = Math.max(0, ...packages.map(p => p.id));
                    const maxRiskId = Math.max(0, ...risks.map(r => r.id));
                    
                    // Create ID mapping for projects
                    const projectIdMap = {};
                    importedProjects.forEach((proj, index) => {
                        const oldId = proj.id;
                        const newId = maxProjectId + index + 1;
                        projectIdMap[oldId] = newId;
                        proj.id = newId;
                        projects.push(proj);
                    });
                    
                    // Create ID mapping for packages and update project references
                    const packageIdMap = {};
                    importedPackages.forEach((pkg, index) => {
                        const oldId = pkg.id;
                        const newId = maxPackageId + index + 1;
                        packageIdMap[oldId] = newId;
                        pkg.id = newId;
                        // Update project reference
                        if (projectIdMap[pkg.projectId]) {
                            pkg.projectId = projectIdMap[pkg.projectId];
                        }
                        packages.push(pkg);
                    });
                    
                    // Update risks with new IDs and references
                    importedRisks.forEach((risk, index) => {
                        risk.id = maxRiskId + index + 1;
                        // Update project reference
                        if (projectIdMap[risk.projectId]) {
                            risk.projectId = projectIdMap[risk.projectId];
                        }
                        // Update package reference
                        if (packageIdMap[risk.packageId]) {
                            risk.packageId = packageIdMap[risk.packageId];
                        }
                        risks.push(risk);
                    });
                    
                    // If weight factors provided and current is default, update
                    if (pendingImportData.data.weightFactors) {
                        // Optionally merge weight factors (user preference)
                        // weightFactors = pendingImportData.data.weightFactors;
                    }
                }
                
                // Save to localStorage
                saveAllData();
                
                // Refresh UI
                populateSelects();
                renderAll();
                
                // Close modal
                closeImportModal();
                
                const importCount = (pendingImportData.data.projects?.length || 0) + 
                                   (pendingImportData.data.packages?.length || 0) + 
                                   (pendingImportData.data.risks?.length || 0);
                
                showNotification(`Data imported successfully! (${importCount} items)`, 'success');
                
            } catch (error) {
                console.error('Import Error:', error);
                showNotification('Error importing data: ' + error.message, 'danger');
            }
        }
        
        // Setup drag and drop for import zone
        document.addEventListener('DOMContentLoaded', function() {
            const importZone = document.getElementById('importZone');
            if (importZone) {
                importZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('dragover');
                });
                
                importZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                });
                
                importZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('importFileInput');
                        fileInput.files = files;
                        handleImportFile({ target: fileInput });
                    }
                });
            }
        });
    </script>
</body>
</html>
